var __extends=this&&this.__extends||function(b,f){function q(){this.constructor=b}for(var t in f)f.hasOwnProperty(t)&&(b[t]=f[t]);b.prototype=null===f?Object.create(f):(q.prototype=f.prototype,new q)},java;
(function(b){var f;(function(b){var f=function(){function b(){}b.gc=function(){};b.arraycopy=function(b,c,a,d,k){if((a instanceof Float64Array||a instanceof Int32Array)&&(b instanceof Float64Array||b instanceof Int32Array))k==b.length?a.set(b,d):a.set(b.subarray(c,c+k),d);else for(var m=0;m<k;m++)a[d+m]=b[c+m]};return b}();b.System=f;f=function(){function b(){this._buffer="";this.length=0}b.prototype.append=function(b){this._buffer+=b;this.length=this._buffer.length;return this};b.prototype.insert=
function(b,c){this._buffer=this._buffer.slice(0,b)+c+this._buffer.slice(b);return this};b.prototype.toString=function(){return this._buffer};return b}();b.StringBuilder=f;f=function(){function b(){}b.valueOf=function(b,c,a){return"undefined"===typeof c&&"undefined"===typeof a?b+"":b.slice(c,c+a)};b.hashCode=function(b){var c=b._hashCode?b._hashCode:0;if(0===c&&0<b.length){for(var a=0;a<b.length;a++)c=31*c+b.charCodeAt(a);b._hashCode=c}return c};b.isEmpty=function(b){return 0===b.length};b.join=function(b,
c){return c.join(b)};return b}();b.String=f;f=function(){function b(){}b.sleep=function(b){};return b}();b.Thread=f;f=function(){function b(){}b.MAX_VALUE=Number.MAX_VALUE;b.POSITIVE_INFINITY=Number.POSITIVE_INFINITY;b.NEGATIVE_INFINITY=Number.NEGATIVE_INFINITY;b.NaN=NaN;return b}();b.Double=f;f=function(){function b(){}b.parseLong=function(b){return parseInt(b)};return b}();b.Long=f;f=function(){function b(){}b.parseInt=function(b){return parseInt(b)};return b}();b.Integer=f})(f=b.lang||(b.lang=
{}));(function(q){(function(a){(function(d){var a=function(){function d(a){this._internal=new Int32Array(a)}d.prototype.set=function(d,a){this._internal[d]=a};d.prototype.get=function(d){return this._internal[d]};d.prototype.getAndSet=function(d,a){var k=this._internal[d];this._internal[d]=a;return k};d.prototype.compareAndSet=function(d,a,k){return this._internal[d]==a?(this._internal[d]=k,!0):!1};return d}();d.AtomicIntegerArray=a;a=function(){function d(a){this._internal=new Float64Array(a)}d.prototype.set=
function(d,a){this._internal[d]=a};d.prototype.get=function(d){return this._internal[d]};d.prototype.getAndSet=function(d,a){var k=this._internal[d];this._internal[d]=a;return k};d.prototype.compareAndSet=function(d,a,k){return this._internal[d]==a?(this._internal[d]=k,!0):!1};d.prototype.length=function(){return this._internal.length};return d}();d.AtomicLongArray=a;a=function(){function d(a){this._internal=[]}d.prototype.set=function(d,a){this._internal[d]=a};d.prototype.get=function(d){return this._internal[d]};
d.prototype.getAndSet=function(d,a){var k=this._internal[d];this._internal[d]=a;return k};d.prototype.compareAndSet=function(d,a,k){return this._internal[d]==a?(this._internal[d]=k,!0):!1};d.prototype.length=function(){return this._internal.length};return d}();d.AtomicReferenceArray=a;a=function(){function d(){this._internal=null}d.prototype.compareAndSet=function(d,a){return this._internal==d?(this._internal=a,!0):!1};d.prototype.get=function(){return this._internal};d.prototype.set=function(d){this._internal=
d};d.prototype.getAndSet=function(d){var a=this._internal;this._internal=d;return a};return d}();d.AtomicReference=a;a=function(){function d(a){this._internal=0;this._internal=a}d.prototype.compareAndSet=function(d,a){return this._internal==d?(this._internal=a,!0):!1};d.prototype.get=function(){return this._internal};d.prototype.incrementAndGet=function(){this._internal++;return this._internal};d.prototype.decrementAndGet=function(){this._internal--;return this._internal};return d}();d.AtomicLong=
a;a=function(){function d(a){this._internal=!1;this._internal=a}d.prototype.compareAndSet=function(d,a){return this._internal==d?(this._internal=a,!0):!1};d.prototype.get=function(){return this._internal};d.prototype.set=function(d){this._internal=d};return d}();d.AtomicBoolean=a;a=function(){function d(a){this._internal=0;this._internal=a}d.prototype.compareAndSet=function(d,a){return this._internal==d?(this._internal=a,!0):!1};d.prototype.get=function(){return this._internal};d.prototype.set=function(d){this._internal=
d};d.prototype.getAndSet=function(d){var a=this._internal;this._internal=d;return a};d.prototype.incrementAndGet=function(){this._internal++;return this._internal};d.prototype.decrementAndGet=function(){this._internal--;return this._internal};d.prototype.getAndIncrement=function(){var d=this._internal;this._internal++;return d};d.prototype.getAndDecrement=function(){var d=this._internal;this._internal--;return d};return d}();d.AtomicInteger=a})(a.atomic||(a.atomic={}));(function(d){var a=function(){function d(){}
d.prototype.lock=function(){};d.prototype.unlock=function(){};return d}();d.ReentrantLock=a})(a.locks||(a.locks={}))})(q.concurrent||(q.concurrent={}));var t=function(){function a(){this.seed=void 0}a.prototype.nextInt=function(d){"undefined"===typeof d&&(d=Math.pow(2,32));return void 0==this.seed?Math.floor(Math.random()*d):Math.floor(this.nextSeeded(0,d))};a.prototype.nextDouble=function(){return void 0==this.seed?Math.random():this.nextSeeded()};a.prototype.nextBoolean=function(){return void 0==
this.seed?.5<=Math.random():.5<=this.nextSeeded()};a.prototype.setSeed=function(d){this.seed=d};a.prototype.nextSeeded=function(d,a){d=d||0;this.seed=(9301*this.seed+49297)%233280;return d+this.seed/233280*((a||1)-d)};return a}();q.Random=t;t=function(){function a(){}a.fill=function(d,a,b,c){for(b=a+b;a<b;a++)d[a]=c};a.copyOf=function(d,a,b){b=Array(a);f.System.arraycopy(d,0,b,0,Math.min(d.length,a));return b};return a}();q.Arrays=t;t=function(){function a(){}a.swap=function(d,a,b){d.set(a,d.set(b,
d.get(a)))};return a}();q.Collections=t;var p=function(){function a(d){this.cursor=0;this.lastRet=-1;this.list=d}a.prototype.hasNext=function(){return this.cursor!=this.list.size()};a.prototype.next=function(){try{var d=this.cursor,a=this.list.get(d);this.lastRet=d;this.cursor=d+1;return a}catch(b){if(b instanceof Error)throw Error("no such element exception");throw b;}};return a}();q.Itr=p;var e=function(){function a(){this.content={}}a.prototype.add=function(d){this.content[d]=d};a.prototype.clear=
function(){this.content={}};a.prototype.contains=function(d){return this.content.hasOwnProperty(d)};a.prototype.containsAll=function(d){return!1};a.prototype.addAll=function(d){d=d.toArray(null);for(var a=0;a<d.length;a++)this.content[d[a]]=d[a];return!0};a.prototype.remove=function(d){var a=!1;this.content[d]&&(a=!0);delete this.content[d];return a};a.prototype.removeAll=function(){return!1};a.prototype.size=function(){return Object.keys(this.content).length};a.prototype.isEmpty=function(){return 0==
this.size()};a.prototype.toArray=function(d){var a=this;return Object.keys(this.content).map(function(d){return a.content[d]})};a.prototype.iterator=function(){return new b.util.Itr(this)};a.prototype.forEach=function(d){for(var a in this.content)d(this.content[a])};a.prototype.get=function(d){return this.content[d]};return a}();q.HashSet=e;t=function(){function a(){this.content=[]}a.prototype.addAll=function(d,a){for(var b=a.toArray(null),c=0;c<b.length;c++)this.content.push(b[c]);return!1};a.prototype.clear=
function(){this.content=[]};a.prototype.poll=function(){return this.content.shift()};a.prototype.remove=function(d){this.content.splice(d,1);return!0};a.prototype.removeAll=function(){this.content=[];return!0};a.prototype.toArray=function(d){return this.content};a.prototype.size=function(){return this.content.length};a.prototype.add=function(d,a){"undefined"!==typeof a?this.content.splice(d,0,a):this.content.push(d)};a.prototype.get=function(d){return this.content[d]};a.prototype.contains=function(d){return-1!=
this.content.indexOf(d)};a.prototype.containsAll=function(d){return!1};a.prototype.isEmpty=function(){return 0==this.content.length};a.prototype.set=function(d,a){return this.content[d]=a};a.prototype.indexOf=function(d){return this.content.indexOf(d)};a.prototype.lastIndexOf=function(d){return this.content.lastIndexOf(d)};a.prototype.iterator=function(){return new p(this)};return a}();q.AbstractList=t;var c=function(a){function d(){a.apply(this,arguments)}__extends(d,a);return d}(t);q.LinkedList=
c;t=function(a){function d(){a.apply(this,arguments)}__extends(d,a);return d}(t);q.ArrayList=t;t=function(){function a(){this.content=[]}a.prototype.pop=function(){return this.content.pop()};a.prototype.push=function(d){this.content.push(d)};a.prototype.isEmpty=function(){return 0==this.content.length};a.prototype.peek=function(){return this.content.slice(-1)[0]};return a}();q.Stack=t;t=function(){function a(){this.content={}}a.prototype.get=function(d){return this.content[d]};a.prototype.put=function(d,
a){var b=this.content[d];this.content[d]=a;return b};a.prototype.containsKey=function(d){return this.content.hasOwnProperty(d)};a.prototype.remove=function(d){var a=this.content[d];delete this.content[d];return a};a.prototype.keySet=function(){var d=new e,a;for(a in this.content)this.content.hasOwnProperty(a)&&d.add(a);return d};a.prototype.isEmpty=function(){return 0==Object.keys(this.content).length};a.prototype.values=function(){var d=new e,a;for(a in this.content)this.content.hasOwnProperty(a)&&
d.add(this.content[a]);return d};a.prototype.clear=function(){this.content={}};a.prototype.size=function(){return Object.keys(this.content).length};return a}();q.HashMap=t;t=function(a){function d(){a.apply(this,arguments)}__extends(d,a);return d}(t);q.ConcurrentHashMap=t})(b.util||(b.util={}))})(java||(java={}));function arrayInstanceOf(b,f){return b instanceof Array?0==b.length?!0:b[0]instanceof f:!1}
var Long=function(){function b(b,q,t){this.low=this.high=0;this.unsigned=!1;this.eq=this.equals;this.neq=this.notEquals;this.lt=this.lessThan;this.lte=this.lessThanOrEqual;this.gt=this.greaterThan;this.gte=this.greaterThanOrEqual;this.comp=this.compare;this.neg=this.negate;this.sub=this.subtract;this.mul=this.multiply;this.div=this.divide;this.mod=this.modulo;this.shl=this.shiftLeft;this.shr=this.shiftRight;this.shru=this.shiftRightUnsigned;void 0!=q&&(this.high=q);void 0!=b&&(this.low=b);void 0!=
t&&(this.unsigned=t)}b.isLong=function(b){return!0===(b&&b.__isLong__)};b.fromInt=function(f,q){var t,p;if(q){f>>>=0;if(p=0<=f&&256>f)if(t=b.UINT_CACHE[f])return t;t=b.fromBits(f,0>(f|0)?-1:0,!0);p&&(b.UINT_CACHE[f]=t)}else{f|=0;if(p=-128<=f&&128>f)if(t=b.INT_CACHE[f])return t;t=b.fromBits(f,0>f?-1:0,!1);p&&(b.INT_CACHE[f]=t)}return t};b.fromNumber=function(f,q){if(isNaN(f)||!isFinite(f))return q?b.UZERO:b.ZERO;if(q){if(0>f)return b.UZERO;if(f>=b.TWO_PWR_64_DBL)return b.MAX_UNSIGNED_VALUE}else{if(f<=
-b.TWO_PWR_63_DBL)return b.MIN_VALUE;if(f+1>=b.TWO_PWR_63_DBL)return b.MAX_VALUE}return 0>f?b.fromNumber(-f,q).neg():b.fromBits(f%b.TWO_PWR_32_DBL|0,f/b.TWO_PWR_32_DBL|0,q)};b.fromBits=function(f,q,t){return new b(f,q,t)};b.fromString=function(f,q,t){void 0===q&&(q=10);void 0===t&&(t=!1);if(0===f.length)throw Error("empty string");if("NaN"===f||"Infinity"===f||"+Infinity"===f||"-Infinity"===f)return b.ZERO;q=q||10;if(2>q||36<q)throw RangeError("radix");var p;if(0<(p=f.indexOf("-")))throw Error("interior hyphen");
if(0===p)return b.fromString(f.substring(1),q,t).neg();p=b.fromNumber(b.pow_dbl(q,8));for(var e=b.ZERO,c=0;c<f.length;c+=8){var a=Math.min(8,f.length-c),d=parseInt(f.substring(c,c+a),q);8>a?(a=b.fromNumber(b.pow_dbl(q,a)),e=e.mul(a).add(b.fromNumber(d))):(e=e.mul(p),e=e.add(b.fromNumber(d)))}e.unsigned=t;return e};b.fromValue=function(f){return f instanceof b?f:"number"===typeof f?b.fromNumber(f):"string"===typeof f?b.fromString(f):b.fromBits(f.low,f.high,f.unsigned)};b.prototype.toInt=function(){return this.unsigned?
this.low>>>0:this.low};b.prototype.toNumber=function(){return this.unsigned?(this.high>>>0)*b.TWO_PWR_32_DBL+(this.low>>>0):this.high*b.TWO_PWR_32_DBL+(this.low>>>0)};b.prototype.toString=function(f){f=f||10;if(2>f||36<f)throw RangeError("radix");if(this.isZero())return"0";if(this.isNegative()){if(this.eq(b.MIN_VALUE)){var q=b.fromNumber(f),t=this.div(q),q=t.mul(q).sub(this);return t.toString(f)+q.toInt().toString(f)}return"-"+this.neg().toString(f)}for(var t=b.fromNumber(b.pow_dbl(f,6),this.unsigned),
q=this,p="";;){var e=q.div(t),c=(q.sub(e.mul(t)).toInt()>>>0).toString(f),q=e;if(q.isZero())return c+p;for(;6>c.length;)c="0"+c;p=""+c+p}};b.prototype.getHighBits=function(){return this.high};b.prototype.getHighBitsUnsigned=function(){return this.high>>>0};b.prototype.getLowBits=function(){return this.low};b.prototype.getLowBitsUnsigned=function(){return this.low>>>0};b.prototype.getNumBitsAbs=function(){if(this.isNegative())return this.eq(b.MIN_VALUE)?64:this.neg().getNumBitsAbs();for(var f=0!=this.high?
this.high:this.low,q=31;0<q&&0==(f&1<<q);q--);return 0!=this.high?q+33:q+1};b.prototype.isZero=function(){return 0===this.high&&0===this.low};b.prototype.isNegative=function(){return!this.unsigned&&0>this.high};b.prototype.isPositive=function(){return this.unsigned||0<=this.high};b.prototype.isOdd=function(){return 1===(this.low&1)};b.prototype.isEven=function(){return 0===(this.low&1)};b.prototype.equals=function(f){b.isLong(f)||(f=b.fromValue(f));return this.unsigned!==f.unsigned&&1===this.high>>>
31&&1===f.high>>>31?!1:this.high===f.high&&this.low===f.low};b.prototype.notEquals=function(b){return!this.eq(b)};b.prototype.lessThan=function(b){return 0>this.comp(b)};b.prototype.lessThanOrEqual=function(b){return 0>=this.comp(b)};b.prototype.greaterThan=function(b){return 0<this.comp(b)};b.prototype.greaterThanOrEqual=function(b){return 0<=this.comp(b)};b.prototype.compare=function(f){b.isLong(f)||(f=b.fromValue(f));if(this.eq(f))return 0;var q=this.isNegative(),t=f.isNegative();return q&&!t?
-1:!q&&t?1:this.unsigned?f.high>>>0>this.high>>>0||f.high===this.high&&f.low>>>0>this.low>>>0?-1:1:this.sub(f).isNegative()?-1:1};b.prototype.negate=function(){return!this.unsigned&&this.eq(b.MIN_VALUE)?b.MIN_VALUE:this.not().add(b.ONE)};b.prototype.add=function(f){b.isLong(f)||(f=b.fromValue(f));var q=this.high>>>16,t=this.high&65535,p=this.low>>>16,e=f.high>>>16,c=f.high&65535,a=f.low>>>16;f=0+((this.low&65535)+(f.low&65535));a=0+(f>>>16)+(p+a);p=0+(a>>>16);p+=t+c;q=0+(p>>>16)+(q+e)&65535;return b.fromBits((a&
65535)<<16|f&65535,q<<16|p&65535,this.unsigned)};b.prototype.subtract=function(f){b.isLong(f)||(f=b.fromValue(f));return this.add(f.neg())};b.prototype.multiply=function(f){if(this.isZero())return b.ZERO;b.isLong(f)||(f=b.fromValue(f));if(f.isZero())return b.ZERO;if(this.eq(b.MIN_VALUE))return f.isOdd()?b.MIN_VALUE:b.ZERO;if(f.eq(b.MIN_VALUE))return this.isOdd()?b.MIN_VALUE:b.ZERO;if(this.isNegative())return f.isNegative()?this.neg().mul(f.neg()):this.neg().mul(f).neg();if(f.isNegative())return this.mul(f.neg()).neg();
if(this.lt(b.TWO_PWR_24)&&f.lt(b.TWO_PWR_24))return b.fromNumber(this.toNumber()*f.toNumber(),this.unsigned);var q=this.high>>>16,t=this.high&65535,p=this.low>>>16,e=this.low&65535,c=f.high>>>16,a=f.high&65535,d=f.low>>>16;f=f.low&65535;var k,m,r,g;g=0+e*f;r=0+(g>>>16)+p*f;m=0+(r>>>16);r=(r&65535)+e*d;m+=r>>>16;m+=t*f;k=0+(m>>>16);m=(m&65535)+p*d;k+=m>>>16;m=(m&65535)+e*a;k=k+(m>>>16)+(q*f+t*d+p*a+e*c)&65535;return b.fromBits((r&65535)<<16|g&65535,k<<16|m&65535,this.unsigned)};b.prototype.divide=
function(f){b.isLong(f)||(f=b.fromValue(f));if(f.isZero())throw Error("division by zero");if(this.isZero())return this.unsigned?b.UZERO:b.ZERO;var q,t,p;if(this.unsigned){f.unsigned||(f=f.toUnsigned());if(f.gt(this))return b.UZERO;if(f.gt(this.shru(1)))return b.UONE;p=b.UZERO}else{if(this.eq(b.MIN_VALUE)){if(f.eq(b.ONE)||f.eq(b.NEG_ONE))return b.MIN_VALUE;if(f.eq(b.MIN_VALUE))return b.ONE;q=this.shr(1).div(f).shl(1);if(q.eq(b.ZERO))return f.isNegative()?b.ONE:b.NEG_ONE;t=this.sub(f.mul(q));return p=
q.add(t.div(f))}if(f.eq(b.MIN_VALUE))return this.unsigned?b.UZERO:b.ZERO;if(this.isNegative())return f.isNegative()?this.neg().div(f.neg()):this.neg().div(f).neg();if(f.isNegative())return this.div(f.neg()).neg();p=b.ZERO}for(t=this;t.gte(f);){q=Math.max(1,Math.floor(t.toNumber()/f.toNumber()));for(var e=Math.ceil(Math.log(q)/Math.LN2),e=48>=e?1:b.pow_dbl(2,e-48),c=b.fromNumber(q),a=c.mul(f);a.isNegative()||a.gt(t);)q-=e,c=b.fromNumber(q,this.unsigned),a=c.mul(f);c.isZero()&&(c=b.ONE);p=p.add(c);
t=t.sub(a)}return p};b.prototype.modulo=function(f){b.isLong(f)||(f=b.fromValue(f));return this.sub(this.div(f).mul(f))};b.prototype.not=function(){return b.fromBits(~this.low,~this.high,this.unsigned)};b.prototype.and=function(f){b.isLong(f)||(f=b.fromValue(f));return b.fromBits(this.low&f.low,this.high&f.high,this.unsigned)};b.prototype.or=function(f){b.isLong(f)||(f=b.fromValue(f));return b.fromBits(this.low|f.low,this.high|f.high,this.unsigned)};b.prototype.xor=function(f){b.isLong(f)||(f=b.fromValue(f));
return b.fromBits(this.low^f.low,this.high^f.high,this.unsigned)};b.prototype.shiftLeft=function(f){b.isLong(f)&&(f=f.toInt());return 0===(f&=63)?this:32>f?b.fromBits(this.low<<f,this.high<<f|this.low>>>32-f,this.unsigned):b.fromBits(0,this.low<<f-32,this.unsigned)};b.prototype.shiftRight=function(f){b.isLong(f)&&(f=f.toInt());return 0===(f&=63)?this:32>f?b.fromBits(this.low>>>f|this.high<<32-f,this.high>>f,this.unsigned):b.fromBits(this.high>>f-32,0<=this.high?0:-1,this.unsigned)};b.prototype.shiftRightUnsigned=
function(f){b.isLong(f)&&(f=f.toInt());f&=63;if(0===f)return this;var q=this.high;return 32>f?b.fromBits(this.low>>>f|q<<32-f,q>>>f,this.unsigned):32===f?b.fromBits(q,0,this.unsigned):b.fromBits(q>>>f-32,0,this.unsigned)};b.prototype.toSigned=function(){return this.unsigned?b.fromBits(this.low,this.high,!1):this};b.prototype.toUnsigned=function(){return this.unsigned?this:b.fromBits(this.low,this.high,!0)};b.INT_CACHE={};b.UINT_CACHE={};b.pow_dbl=Math.pow;b.TWO_PWR_16_DBL=65536;b.TWO_PWR_24_DBL=16777216;
b.TWO_PWR_32_DBL=b.TWO_PWR_16_DBL*b.TWO_PWR_16_DBL;b.TWO_PWR_64_DBL=b.TWO_PWR_32_DBL*b.TWO_PWR_32_DBL;b.TWO_PWR_63_DBL=b.TWO_PWR_64_DBL/2;b.TWO_PWR_24=b.fromInt(b.TWO_PWR_24_DBL);b.ZERO=b.fromInt(0);b.UZERO=b.fromInt(0,!0);b.ONE=b.fromInt(1);b.UONE=b.fromInt(1,!0);b.NEG_ONE=b.fromInt(-1);b.MAX_VALUE=b.fromBits(2147483647,4294967295,!1);b.MAX_UNSIGNED_VALUE=b.fromBits(4294967295,4294967295,!0);b.MIN_VALUE=b.fromBits(2147483648,0,!1);return b}();
Object.defineProperty(Long.prototype,"__isLong__",{value:!0,enumerable:!1,configurable:!1});var org;
(function(b){(function(f){var q=function(){function b(){}b.isDefined=function(b){return null!=b};b.equals=function(b,e){return b===e};b.longArrayEquals=function(b,e){if(b.length!=e.length)return!1;for(var c=0;c<b.length;c++)if(b[c]!=e[c])return!1;return!0};b.KEY_SIZE=4;b.LONG_SIZE=53;b.PREFIX_SIZE=16;b.BEGINNING_OF_TIME=-9007199254740990;b.END_OF_TIME=9007199254740990;b.NULL_LONG=9007199254740991;b.KEY_PREFIX_MASK=137438953471;b.CACHE_MISS_ERROR="Cache miss error";b.QUERY_SEP=",";b.QUERY_KV_SEP="=";
b.TASK_SEP=".";b.TASK_PARAM_OPEN="(";b.TASK_PARAM_CLOSE=")";b.CHUNK_SEP=124;b.CHUNK_SUB_SEP=44;b.CHUNK_SUB_SUB_SEP=58;b.CHUNK_SUB_SUB_SUB_SEP=37;b.BUFFER_SEP=35;b.KEY_SEP=59;b.MAP_INITIAL_CAPACITY=8;b.MAP_LOAD_FACTOR=.75;b.BOOL_TRUE=49;b.BOOL_FALSE=48;return b}();f.Constants=q;q=function(){function f(){this._plugins=this._scheduler=this._storage=null;this._memorySize=-1;this._readOnly=!1}f.prototype.withStorage=function(b){this._storage=b;return this};f.prototype.withReadOnlyStorage=function(b){this._storage=
b;this._readOnly=!0;return this};f.prototype.withMemorySize=function(b){this._memorySize=b;return this};f.prototype.withScheduler=function(b){this._scheduler=b;return this};f.prototype.withPlugin=function(b){if(null==this._plugins)this._plugins=Array(1),this._plugins[0]=b;else{var e=Array(this._plugins.length+1);java.lang.System.arraycopy(this._plugins,0,e,0,this._plugins.length);e[this._plugins.length]=b;this._plugins=e}return this};f.prototype.build=function(){null==b.mwg.GraphBuilder._internalBuilder&&
(b.mwg.GraphBuilder._internalBuilder=new b.mwg.core.Builder);return b.mwg.GraphBuilder._internalBuilder.newGraph(this._storage,this._readOnly,this._scheduler,this._plugins,this._memorySize)};f._internalBuilder=null;return f}();f.GraphBuilder=q;q=function(){function f(){}f.typeName=function(f){switch(f){case b.mwg.Type.BOOL:return"boolean";case b.mwg.Type.STRING:return"string";case b.mwg.Type.LONG:return"long";case b.mwg.Type.INT:return"int";case b.mwg.Type.DOUBLE:return"double";case b.mwg.Type.DOUBLE_ARRAY:return"double[]";
case b.mwg.Type.LONG_ARRAY:return"long[]";case b.mwg.Type.INT_ARRAY:return"int[]";case b.mwg.Type.LONG_TO_LONG_MAP:return"map(long->long)";case b.mwg.Type.LONG_TO_LONG_ARRAY_MAP:return"map(long->long[])";case b.mwg.Type.STRING_TO_LONG_MAP:return"map(string->long)";case b.mwg.Type.RELATION:return"relation";default:return"unknown"}};f.BOOL=1;f.STRING=2;f.LONG=3;f.INT=4;f.DOUBLE=5;f.DOUBLE_ARRAY=6;f.LONG_ARRAY=7;f.INT_ARRAY=8;f.LONG_TO_LONG_MAP=9;f.LONG_TO_LONG_ARRAY_MAP=10;f.STRING_TO_LONG_MAP=11;f.RELATION=
12;return f}();f.Type=q;(function(b){var f=function(){function b(){}b.STATE_CHUNK=0;b.TIME_TREE_CHUNK=1;b.WORLD_ORDER_CHUNK=2;b.GEN_CHUNK=3;return b}();b.ChunkType=f})(f.chunk||(f.chunk={}));(function(f){var p=function(){function e(b,a,d,k){this._time_magic=this._super_time_magic=this._world_magic=this._index_stateChunk=this._index_timeTree=this._index_superTimeTree=this._index_worldOrder=-1;this._dead=!1;this._world=b;this._time=a;this._id=d;this._graph=k;this._resolver=k.resolver()}e.prototype.cacheLock=
function(){};e.prototype.cacheUnlock=function(){};e.prototype.init=function(){};e.prototype.nodeTypeName=function(){return this._resolver.typeName(this)};e.prototype.unphasedState=function(){return this._resolver.resolveState(this)};e.prototype.phasedState=function(){return this._resolver.alignState(this)};e.prototype.newState=function(b){return this._resolver.newState(this,this._world,b)};e.prototype.graph=function(){return this._graph};e.prototype.world=function(){return this._world};e.prototype.time=
function(){return this._time};e.prototype.id=function(){return this._id};e.prototype.get=function(b){var a=this._resolver.resolveState(this);return null!=a?a.get(this._resolver.stringToHash(b,!1)):null};e.prototype.set=function(c,a){if("string"===typeof a||a instanceof String)this.setProperty(c,b.mwg.Type.STRING,a);else if("number"===typeof a||a instanceof Number)0!=a%1?this.setProperty(c,b.mwg.Type.DOUBLE,a):this.setProperty(c,b.mwg.Type.LONG,a);else if("boolean"===typeof a||a instanceof Boolean)this.setProperty(c,
b.mwg.Type.BOOL,a);else if(a instanceof Int32Array)this.setProperty(c,b.mwg.Type.LONG_ARRAY,a);else if(a instanceof Float64Array)this.setProperty(c,b.mwg.Type.DOUBLE_ARRAY,a);else throw Error("Invalid property type: "+a+", please use a Type listed in org.mwg.Type");};e.prototype.forceProperty=function(c,a,d){c=this._resolver.stringToHash(c,!0);var k=this._resolver.alignState(this);if(null!=k)k.set(c,a,d);else throw Error(b.mwg.Constants.CACHE_MISS_ERROR);};e.prototype.setProperty=function(c,a,d){c=
this._resolver.stringToHash(c,!0);var k=this._resolver.resolveState(this),m=a!=k.getType(c);m||(m=!this.isEquals(k.get(c),d,a));if(m)if(k=this._resolver.alignState(this),null!=k)k.set(c,a,d);else throw Error(b.mwg.Constants.CACHE_MISS_ERROR);};e.prototype.isEquals=function(c,a,d){switch(d){case b.mwg.Type.BOOL:return c==a;case b.mwg.Type.DOUBLE:return c==a;case b.mwg.Type.INT:return c==a;case b.mwg.Type.LONG:return c==a;case b.mwg.Type.STRING:return c===a;case b.mwg.Type.DOUBLE_ARRAY:if(c.length!=
a.length)return!1;for(d=0;d<c.length;d++)if(c[d]!=a[d])return!1;return!0;case b.mwg.Type.INT_ARRAY:if(c.length!=a.length)return!1;for(d=0;d<c.length;d++)if(c[d]!=a[d])return!1;return!0;case b.mwg.Type.LONG_ARRAY:if(c.length!=a.length)return!1;for(d=0;d<c.length;d++)if(c[d]!=a[d])return!1;return!0;case b.mwg.Type.RELATION:case b.mwg.Type.STRING_TO_LONG_MAP:case b.mwg.Type.LONG_TO_LONG_MAP:case b.mwg.Type.LONG_TO_LONG_ARRAY_MAP:throw Error("Bad API usage: set can't be used with complex type, please use getOrCreate instead.");
default:throw Error("Not managed type "+d);}};e.prototype.getOrCreate=function(c,a){var d=this._resolver.alignState(this);if(null!=d)return d.getOrCreate(this._resolver.stringToHash(c,!0),a);throw Error(b.mwg.Constants.CACHE_MISS_ERROR);};e.prototype.type=function(b){var a=this._resolver.resolveState(this);return null!=a?a.getType(this._resolver.stringToHash(b,!1)):-1};e.prototype.removeProperty=function(c){this.setProperty(c,b.mwg.Type.INT,null)};e.prototype.rel=function(b,a){this.relByIndex(this._resolver.stringToHash(b,
!1),a)};e.prototype.relByIndex=function(b,a){if(null!=a){var d=this._resolver.resolveState(this);if(null!=d)if(d=d.get(b),null==d||0==d.size())a([]);else{for(var k=d.size(),m=new Float64Array(k),e=0;e<k;e++)m[e]=d.get(e);this._resolver.lookupAll(this._world,this._time,m,function(d){a(d)})}else a([])}};e.prototype.add=function(c,a){if(null!=a){var d=this._resolver.alignState(this),k=this._resolver.stringToHash(c,!0);if(null!=d)d.getOrCreate(k,b.mwg.Type.RELATION).add(a.id());else throw Error(b.mwg.Constants.CACHE_MISS_ERROR);
}};e.prototype.remove=function(c,a){if(null!=a){var d=this._resolver.alignState(this),k=this._resolver.stringToHash(c,!1);if(null!=d)d=d.get(k),null!=d&&d.remove(a.id());else throw Error(b.mwg.Constants.CACHE_MISS_ERROR);}};e.prototype.free=function(){this._resolver.freeNode(this)};e.prototype.timeDephasing=function(){var c=this._resolver.resolveState(this);if(null!=c)return this._time-c.time();throw Error(b.mwg.Constants.CACHE_MISS_ERROR);};e.prototype.lastModification=function(){var c=this._resolver.resolveState(this);
if(null!=c)return c.time();throw Error(b.mwg.Constants.CACHE_MISS_ERROR);};e.prototype.rephase=function(){this._resolver.alignState(this)};e.prototype.timepoints=function(b,a,d){this._resolver.resolveTimepoints(this,b,a,d)};e.prototype.jump=function(b,a){this._resolver.lookup(this._world,b,this._id,a)};e.prototype.findByQuery=function(c,a){var d=this._resolver.resolveState(this);if(null==d)throw Error(b.mwg.Constants.CACHE_MISS_ERROR);var k=c.indexName();if(null==k)throw Error("Please specify indexName in query before first use!");
var m=c.world();m==b.mwg.Constants.NULL_LONG&&(m=this.world());var e=c.time();e==b.mwg.Constants.NULL_LONG&&(e=this.time());d=d.get(this._resolver.stringToHash(k,!1));if(null!=d){var g=this,l=d.get(c.hash());null==l?a([]):g._resolver.lookupAll(m,e,l,function(d){for(var k=Array(l.length),m=0,e=0;e<k.length;e++){var r=d[e];if(null!=r){for(var f=g._resolver.resolveState(r),p=!0,q=0;q<c.attributes().length;q++){var t=f.get(c.attributes()[q]);if(null==c.values()[q]){if(null!=t){p=!1;break}}else if(null==
t){p=!1;break}else if(t instanceof Float64Array)if(c.values()[q]instanceof Float64Array){if(!b.mwg.Constants.longArrayEquals(c.values()[q],t)){p=!1;break}}else{p=!1;break}else if(!b.mwg.Constants.equals(c.values()[q].toString(),t.toString())){p=!1;break}}p&&(k[m]=r,m++)}}k.length==m?a(k):(d=Array(m),java.lang.System.arraycopy(k,0,d,0,m),a(d))})}else a([])};e.prototype.find=function(b,a,d){var k=this._graph.newQuery();k.setWorld(this.world());k.setTime(this.time());k.setIndexName(b);k.parse(a);this.findByQuery(k,
d)};e.prototype.findAll=function(c,a){var d=this._resolver.resolveState(this);if(null==d)throw Error(b.mwg.Constants.CACHE_MISS_ERROR);d=d.get(this._resolver.stringToHash(c,!1));if(null!=d){var k=new Float64Array(d.size()),m=new Int32Array([0]);d.each(function(d,a){k[m[0]]=a;m[0]++});this._resolver.lookupAll(this.world(),this.time(),k,function(d){a(d)})}else a([])};e.prototype.index=function(c,a,d,k){var m=d.split(b.mwg.Constants.QUERY_SEP+"");c=this._resolver.stringToHash(c,!0);d=this._graph.newQuery();
for(var e=this._resolver.resolveState(a),g=0;g<m.length;g++){var l=m[g],h=e.getFromKey(l);null!=h?d.add(l,h.toString()):d.add(l,null)}m=!1;e=this._resolver.resolveState(this);null!=e&&(e=e.get(c),null!=e&&(m=e.contains(d.hash(),a.id())));if(!m){m=this._resolver.alignState(this);if(null==m)throw Error(b.mwg.Constants.CACHE_MISS_ERROR);m.getOrCreate(c,b.mwg.Type.LONG_TO_LONG_ARRAY_MAP).put(d.hash(),a.id())}b.mwg.Constants.isDefined(k)&&k(!0)};e.prototype.unindex=function(c,a,d,k){d=d.split(b.mwg.Constants.QUERY_SEP+
"");var m=this._resolver.alignState(this);if(null==m)throw Error(b.mwg.Constants.CACHE_MISS_ERROR);c=m.get(this._resolver.stringToHash(c,!1));if(null!=c){for(var m=this._graph.newQuery(),e=this._resolver.resolveState(a),g=0;g<d.length;g++){var l=d[g],h=e.getFromKey(l);null!=h?m.add(l,h.toString()):m.add(l,null)}c.remove(m.hash(),a.id())}b.mwg.Constants.isDefined(k)&&k(!0)};e.prototype.isNaN=function(b){return isNaN(b)};e.prototype.toString=function(){var c=this,a=new java.lang.StringBuilder,d=[!0];
a.append('{"world":');a.append(this.world());a.append(',"time":');a.append(this.time());a.append(',"id":');a.append(this.id());var k=this._resolver.resolveState(this);null!=k&&(k.each(function(k,e,g){if(null!=g){var l=c._resolver.hashToString(k);null==l&&(l=k+"");switch(e){case b.mwg.Type.BOOL:a.append(',"');a.append(l);a.append('":');g?a.append("0"):a.append("1");break;case b.mwg.Type.STRING:a.append(',"');a.append(l);a.append('":');a.append('"');a.append(g);a.append('"');break;case b.mwg.Type.LONG:a.append(',"');
a.append(l);a.append('":');a.append(g);break;case b.mwg.Type.INT:a.append(',"');a.append(l);a.append('":');a.append(g);break;case b.mwg.Type.DOUBLE:c.isNaN(g)||(a.append(',"'),a.append(l),a.append('":'),a.append(g));break;case b.mwg.Type.DOUBLE_ARRAY:a.append(',"');a.append(l);a.append('":');a.append("[");for(k=0;k<g.length;k++)0!=k&&a.append(","),a.append(g[k]);a.append("]");break;case b.mwg.Type.RELATION:a.append(',"');a.append(l);a.append('":');a.append("[");for(k=0;k<g.size();k++)0!=k&&a.append(","),
a.append(g.get(k));a.append("]");break;case b.mwg.Type.LONG_ARRAY:a.append(',"');a.append(l);a.append('":');a.append("[");for(k=0;k<g.length;k++)0!=k&&a.append(","),a.append(g[k]);a.append("]");break;case b.mwg.Type.INT_ARRAY:a.append(',"');a.append(l);a.append('":');a.append("[");for(k=0;k<g.length;k++)0!=k&&a.append(","),a.append(g[k]);a.append("]");break;case b.mwg.Type.LONG_TO_LONG_MAP:a.append(',"');a.append(l);a.append('":');a.append("{");d[0]=!0;g.each(function(b,k){d[0]?d[0]=!1:a.append(",");
a.append('"');a.append(b);a.append('":');a.append(k)});a.append("}");break;case b.mwg.Type.LONG_TO_LONG_ARRAY_MAP:a.append(',"');a.append(l);a.append('":');a.append("{");d[0]=!0;var h=new java.util.HashSet;g.each(function(d,a){h.add(d)});e=h.toArray(Array(h.size()));for(l=0;l<e.length;l++){var f=g.get(e[l]);d[0]?d[0]=!1:a.append(",");a.append('"');a.append(e[l]);a.append('":[');for(k=0;k<f.length;k++)0!=k&&a.append(","),a.append(f[k]);a.append("]")}a.append("}");break;case b.mwg.Type.STRING_TO_LONG_MAP:a.append(',"'),
a.append(l),a.append('":'),a.append("{"),d[0]=!0,g.each(function(b,k){d[0]?d[0]=!1:a.append(",");a.append('"');a.append(b);a.append('":');a.append(k)}),a.append("}")}}}),a.append("}"));return a.toString()};e.prototype.getOrCreateRel=function(c){return this.getOrCreate(c,b.mwg.Type.RELATION)};e.prototype.getByIndex=function(b){return this._resolver.resolveState(this).get(b)};e.prototype.setPropertyByIndex=function(b,a,d){this._resolver.alignState(this).set(b,a,d)};return e}();f.AbstractNode=p;p=function(){function b(){this._nodeTypes=
new java.util.HashMap;this._taskActions=new java.util.HashMap}b.prototype.declareNodeType=function(b,a){this._nodeTypes.put(b,a);return this};b.prototype.declareTaskAction=function(b,a){this._taskActions.put(b,a);return this};b.prototype.declareMemoryFactory=function(b){this._memoryFactory=b;return this};b.prototype.declareResolverFactory=function(b){this._resolverFactory=b;return this};b.prototype.hookFactory=function(){return this._hookFactory};b.prototype.declareTaskHookFactory=function(b){this._hookFactory=
b;return this};b.prototype.nodeTypes=function(){return this._nodeTypes.keySet().toArray(Array(this._nodeTypes.size()))};b.prototype.nodeType=function(b){return this._nodeTypes.get(b)};b.prototype.taskActionTypes=function(){return this._taskActions.keySet().toArray(Array(this._taskActions.size()))};b.prototype.taskActionType=function(b){return this._taskActions.get(b)};b.prototype.memoryFactory=function(){return this._memoryFactory};b.prototype.resolverFactory=function(){return this._resolverFactory};
b.prototype.stop=function(){};return b}();f.AbstractPlugin=p;p=function(){function b(){this._next=null}b.prototype.setNext=function(b){this._next=b};b.prototype.next=function(){return this._next};return b}();f.AbstractTaskAction=p;p=function(){function b(){}b.SAME_THREAD=0;b.ANY_LOCAL_THREAD=1;b.OTHER_LOCAL_THREAD=2;b.ANY_REMOTE_THREAD=3;return b}();f.SchedulerAffinity=p})(f.plugin||(f.plugin={}));(function(f){var p=function(){function e(){}e.newTask=function(){null==b.mwg.task.Actions._internalBuilder&&
(b.mwg.task.Actions._internalBuilder=new b.mwg.core.Builder);return b.mwg.task.Actions._internalBuilder.newTask()};e.setWorld=function(c){return b.mwg.task.Actions.newTask().setWorld(c)};e.setTime=function(c){return b.mwg.task.Actions.newTask().setTime(c)};e.then=function(c){return b.mwg.task.Actions.newTask().then(c)};e.inject=function(c){return b.mwg.task.Actions.newTask().inject(c)};e.fromVar=function(c){return b.mwg.task.Actions.newTask().fromVar(c)};e.fromVarAt=function(c,a){return b.mwg.task.Actions.newTask().fromVarAt(c,
a)};e.fromIndexAll=function(c){return b.mwg.task.Actions.newTask().fromIndexAll(c)};e.fromIndex=function(c,a){return b.mwg.task.Actions.newTask().fromIndex(c,a)};e.indexNode=function(c,a){return b.mwg.task.Actions.newTask().indexNode(c,a)};e.unindexNode=function(c,a){return b.mwg.task.Actions.newTask().unindexNode(c,a)};e.localIndex=function(c,a,d){return b.mwg.task.Actions.newTask().localIndex(c,a,d)};e.localUnindex=function(c,a,d){return b.mwg.task.Actions.newTask().localUnindex(c,a,d)};e.indexesNames=
function(){return b.mwg.task.Actions.newTask().indexesNames()};e.parse=function(c){return b.mwg.task.Actions.newTask().parse(c)};e.asGlobalVar=function(c){return b.mwg.task.Actions.newTask().asGlobalVar(c)};e.addToGlobalVar=function(c){return b.mwg.task.Actions.newTask().addToGlobalVar(c)};e.asVar=function(c){return b.mwg.task.Actions.newTask().asVar(c)};e.defineVar=function(c){return b.mwg.task.Actions.newTask().defineVar(c)};e.addToVar=function(c){return b.mwg.task.Actions.newTask().addToVar(c)};
e.map=function(c){return b.mwg.task.Actions.newTask().map(c)};e.selectWith=function(c,a){return b.mwg.task.Actions.newTask().selectWith(c,a)};e.selectWithout=function(c,a){return b.mwg.task.Actions.newTask().selectWithout(c,a)};e.select=function(c){return b.mwg.task.Actions.newTask().select(c)};e.selectObject=function(c){return b.mwg.task.Actions.newTask().selectObject(c)};e.traverse=function(c){return b.mwg.task.Actions.newTask().traverse(c)};e.get=function(c){return b.mwg.task.Actions.newTask().get(c)};
e.traverseIndex=function(c){for(var a=[],d=1;d<arguments.length;d++)a[d-1]=arguments[d];return(k=b.mwg.task.Actions.newTask()).traverseIndex.apply(k,[c].concat(a));var k};e.traverseOrKeep=function(c){return b.mwg.task.Actions.newTask().traverseOrKeep(c)};e.traverseIndexAll=function(c){return b.mwg.task.Actions.newTask().traverseIndexAll(c)};e.loop=function(c,a,d){return b.mwg.task.Actions.newTask().loop(c,a,d)};e.loopPar=function(c,a,d){return b.mwg.task.Actions.newTask().loopPar(c,a,d)};e.print=
function(c){return b.mwg.task.Actions.newTask().print(c)};e.setProperty=function(c,a,d){return b.mwg.task.Actions.newTask().setProperty(c,a,d)};e.selectWhere=function(c){return b.mwg.task.Actions.newTask().selectWhere(c)};e.foreach=function(c){return b.mwg.task.Actions.newTask().foreach(c)};e.foreachPar=function(c){return b.mwg.task.Actions.newTask().foreachPar(c)};e.flatmap=function(c){return b.mwg.task.Actions.newTask().flatmap(c)};e.flatmapPar=function(c){return b.mwg.task.Actions.newTask().flatmapPar(c)};
e.math=function(c){return b.mwg.task.Actions.newTask().math(c)};e.action=function(c,a){return b.mwg.task.Actions.newTask().action(c,a)};e.remove=function(c,a){return b.mwg.task.Actions.newTask().remove(c,a)};e.add=function(c,a){return b.mwg.task.Actions.newTask().add(c,a)};e.properties=function(){return b.mwg.task.Actions.newTask().properties()};e.propertiesWithTypes=function(c){return b.mwg.task.Actions.newTask().propertiesWithTypes(c)};e.jump=function(c){return b.mwg.task.Actions.newTask().jump(c)};
e.removeProperty=function(c){return b.mwg.task.Actions.newTask().removeProperty(c)};e.newNode=function(){return b.mwg.task.Actions.newTask().newNode()};e.newTypedNode=function(c){return b.mwg.task.Actions.newTask().newTypedNode(c)};e.save=function(){return b.mwg.task.Actions.newTask().save()};e.ifThen=function(c,a){return b.mwg.task.Actions.newTask().ifThen(c,a)};e.ifThenElse=function(c,a,d){return b.mwg.task.Actions.newTask().ifThenElse(c,a,d)};e.whileDo=function(c,a){return b.mwg.task.Actions.newTask().whileDo(c,
a)};e.doWhile=function(c,a){return b.mwg.task.Actions.newTask().doWhile(c,a)};e.split=function(c){return b.mwg.task.Actions.newTask().split(c)};e.lookup=function(c){return b.mwg.task.Actions.newTask().lookup(c)};e.hook=function(c){return b.mwg.task.Actions.newTask().hook(c)};e.clear=function(){return b.mwg.task.Actions.newTask().clear()};e.subTask=function(c){return b.mwg.task.Actions.newTask().subTask(c)};e.isolate=function(c){return b.mwg.task.Actions.newTask().isolate(c)};e.subTasks=function(c){return b.mwg.task.Actions.newTask().subTasks(c)};
e.subTasksPar=function(c){return b.mwg.task.Actions.newTask().subTasksPar(c)};e.cond=function(c){return b.mwg.task.Actions.newTask().mathConditional(c)};e._internalBuilder=null;return e}();f.Actions=p})(f.task||(f.task={}));(function(f){var p=function(){function b(){}b.encodeLongToBuffer=function(c,a){var d=!0,k=c;0>c&&(k=-k);for(var m=47;5<=m;m-=6)d&&0==(k/b.powTwo[m]&63)||(d=!1,a.write(b.dictionary[k/b.powTwo[m]&63]));a.write(b.dictionary[2*(k&31)+(0>c?1:0)])};b.encodeIntToBuffer=function(c,a){var d=
!0,k=c;0>c&&(k=-k);for(var m=29;5<=m;m-=6)d&&0==(k/b.powTwo[m]&63)||(d=!1,a.write(b.dictionary[k/b.powTwo[m]&63]));a.write(b.dictionary[2*(k&31)+(0>c?1:0)])};b.decodeToLong=function(c){return b.decodeToLongWithBounds(c,0,c.length())};b.decodeToLongWithBounds=function(c,a,d){for(var k=Long.ZERO,k=k.add(b.longIndexes[b.dictionary.indexOf(c.read(d-1))&255].shiftRightUnsigned(1)),m=1;m<d-a;m++)k=k.add(b.longIndexes[b.dictionary.indexOf(c.read(d-1-m))&255].shiftLeft(6*m-1));0!=(b.dictionary.indexOf(c.read(d-
1))&1)&&(k=k.mul(-1));return k.toNumber()};b.decodeToInt=function(c){return b.decodeToIntWithBounds(c,0,c.length())};b.decodeToIntWithBounds=function(c,a,d){var k;k=0+(b.dictionary.indexOf(c.read(d-1))&255)/2;for(var m=1;m<d-a;m++)k+=(b.dictionary.indexOf(c.read(d-1-m))&255)*b.powTwo[6*m-1];0!=(b.dictionary.indexOf(c.read(d-1))&1)&&(k=-k);return k};b.encodeDoubleToBuffer=function(c,a){var d=[],k=new Float64Array(1),m=new Uint8Array(k.buffer);k[0]=c;k=2048*(m[7]/128&1)+((16*(m[7]&127)|m[6]/16)-1023+
1023);d.push(b.dictionary[k/64&63]);d.push(b.dictionary[k&63]);d.push(b.dictionary[m[6]&15]);d.push(b.dictionary[m[5]/4&63]);d.push(b.dictionary[16*(m[5]&3)|m[4]/16]);d.push(b.dictionary[4*(m[4]&15)|m[3]/64]);d.push(b.dictionary[m[3]&63]);d.push(b.dictionary[m[2]/4&63]);d.push(b.dictionary[16*(m[2]&3)|m[1]/16]);d.push(b.dictionary[4*(m[1]&15)|m[0]/64]);d.push(b.dictionary[m[0]&63]);for(m=d.length;3<=m&&65==d[r];)m--;for(var r=0;r<m;r++)a.write(d[r])};b.decodeToDouble=function(c){return b.decodeToDoubleWithBounds(c,
0,c.length())};b.decodeToDoubleWithBounds=function(c,a,d){for(var k=64*(b.dictionary.indexOf(c.read(a))&255)+(b.dictionary.indexOf(c.read(a+1))&255),m=0!=(k&2048)?-1:1,k=k&2047,r=0,g=2;g<d-a;g++)r+=(b.dictionary.indexOf(c.read(a+g))&255)*b.powTwo[48-6*(g-2)];return 0!=k?m*Math.pow(2,k-1023)*(1+r/Math.pow(2,52)):m*Math.pow(2,-1022)*(0+r/Math.pow(2,52))};b.encodeBoolArrayToBuffer=function(c,a){for(var d=0,k=0;k<c.length;k++)if(d|=(c[k]?1:0)*b.powTwo[k%6],5==k%6||k==c.length-1)a.write(b.dictionary[d]),
d=0};b.decodeBoolArray=function(c,a){return b.decodeToBoolArrayWithBounds(c,0,c.length(),a)};b.decodeToBoolArrayWithBounds=function(c,a,d,k){for(var m=[],r=0;r<d-a;r++)for(var g=b.dictionary.indexOf(c.read(a+r))&255,l=0;6>l;l++)if(6*r+l<k)m[6*r+l]=0!=(g&1*b.powTwo[l]);else break;return m};b.encodeStringToBuffer=function(c,a){for(var d=c.length,k,m=0,r=6,g=0;g<d;g++)k=c.charCodeAt(g),6==r?(a.write(b.dictionary[k/4&63]),m=16*(k&3),r=4):4==r?(a.write(b.dictionary[(m|k/16&15)&63]),m=4*(k&15),r=2):2==
r&&(a.write(b.dictionary[(m|k/64&3)&63]),a.write(b.dictionary[k&63]),r=6);6!=r&&a.write(b.dictionary[m])};b.decodeString=function(c){return b.decodeToStringWithBounds(c,0,c.length())};b.decodeToStringWithBounds=function(c,a,d){for(var k="",m=0,r=8,g=a;g<d;g++)a=b.dictionary.indexOf(c.read(g)),8==r?(m=4*a,r=2):2==r?(k+=String.fromCharCode(m|a/16),m=16*(a&15),r=4):4==r?(k+=String.fromCharCode(m|a/4),m=64*(a&3),r=6):6==r&&(k+=String.fromCharCode(m|a),r=8);return k};b.dictionary=[65,66,67,68,69,70,71,
72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,48,49,50,51,52,53,54,55,56,57,43,47];b.powTwo={0:1,1:2,2:4,3:8,4:16,5:32,6:64,7:128,8:256,9:512,10:1024,11:2048,12:4096,13:8192,14:16384,15:32768,16:65536,17:131072,18:262144,19:524288,20:1048576,21:2097152,22:4194304,23:8388608,24:16777216,25:33554432,26:67108864,27:134217728,28:268435456,29:536870912,30:1073741824,31:2147483648,32:4294967296,
33:8589934592,34:17179869184,35:34359738368,36:68719476736,37:137438953472,38:274877906944,39:549755813888,40:1099511627776,41:2199023255552,42:4398046511104,43:8796093022208,44:17592186044416,45:35184372088832,46:70368744177664,47:0x800000000000,48:281474976710656,49:562949953421312,50:0x4000000000000,51:0x8000000000000,52:4503599627370496,53:9007199254740992};b.longIndexes=[Long.fromNumber(0),Long.fromNumber(1),Long.fromNumber(2),Long.fromNumber(3),Long.fromNumber(4),Long.fromNumber(5),Long.fromNumber(6),
Long.fromNumber(7),Long.fromNumber(8),Long.fromNumber(9),Long.fromNumber(10),Long.fromNumber(11),Long.fromNumber(12),Long.fromNumber(13),Long.fromNumber(14),Long.fromNumber(15),Long.fromNumber(16),Long.fromNumber(17),Long.fromNumber(18),Long.fromNumber(19),Long.fromNumber(20),Long.fromNumber(21),Long.fromNumber(22),Long.fromNumber(23),Long.fromNumber(24),Long.fromNumber(25),Long.fromNumber(26),Long.fromNumber(27),Long.fromNumber(28),Long.fromNumber(29),Long.fromNumber(30),Long.fromNumber(31),Long.fromNumber(32),
Long.fromNumber(33),Long.fromNumber(34),Long.fromNumber(35),Long.fromNumber(36),Long.fromNumber(37),Long.fromNumber(38),Long.fromNumber(39),Long.fromNumber(40),Long.fromNumber(41),Long.fromNumber(42),Long.fromNumber(43),Long.fromNumber(44),Long.fromNumber(45),Long.fromNumber(46),Long.fromNumber(47),Long.fromNumber(48),Long.fromNumber(49),Long.fromNumber(50),Long.fromNumber(51),Long.fromNumber(52),Long.fromNumber(53),Long.fromNumber(54),Long.fromNumber(55),Long.fromNumber(56),Long.fromNumber(57),Long.fromNumber(58),
Long.fromNumber(59),Long.fromNumber(60),Long.fromNumber(61),Long.fromNumber(62),Long.fromNumber(63)];return b}();f.Base64=p;p=function(){function b(c,a,d){this._origin=c;this._initPos=a;this._endPos=d}b.prototype.write=function(b){throw Error("Write operation forbidden during iteration");};b.prototype.writeAll=function(b){throw Error("Write operation forbidden during iteration");};b.prototype.read=function(b){if(this._initPos+b>this._endPos)throw Error(""+b);return this._origin.read(this._initPos+
b)};b.prototype.data=function(){return this._origin.slice(this._initPos,this._endPos)};b.prototype.length=function(){return this._endPos-this._initPos+1};b.prototype.free=function(){throw Error("Free operation forbidden during iteration");};b.prototype.iterator=function(){throw Error("iterator creation forbidden forbidden during iteration");};b.prototype.removeLast=function(){throw Error("Write operation forbidden during iteration");};b.prototype.slice=function(b,a){throw Error("Write operation forbidden during iteration");
};return b}();f.BufferView=p;p=function(){function e(b){this._cursor=-1;this._origin=b;this._originSize=b.length()}e.prototype.hasNext=function(){return 0<this._originSize&&this._cursor+1<this._originSize};e.prototype.next=function(){for(var c=this._cursor;this._cursor+1<this._originSize;)if(this._cursor++,this._origin.read(this._cursor)==b.mwg.Constants.BUFFER_SEP)return new b.mwg.utility.BufferView(this._origin,c+1,this._cursor-1);return c<this._originSize?new b.mwg.utility.BufferView(this._origin,
c+1,this._cursor):null};return e}();f.DefaultBufferIterator=p;p=function(){function e(){this.checkers=new java.util.HashMap}e.prototype.asBool=function(c){return this.declare(c,{check:function(a,d){if(null!=d&&a!=b.mwg.Type.BOOL)throw Error("Property "+c+" should be Boolean value, currently "+d);}})};e.prototype.asString=function(c){return this.declare(c,{check:function(a,d){if(null!=d&&a!=b.mwg.Type.STRING)throw Error("Property "+c+" should be String value, currently "+d);}})};e.prototype.asLong=
function(c){return this.declare(c,{check:function(a,d){if(null!=d&&a!=b.mwg.Type.LONG&&a!=b.mwg.Type.INT)throw Error("Property "+c+" should be long value, currently "+d);}})};e.prototype.asLongWithin=function(c,a,d){return this.declare(c,{check:function(k,m){if(null!=m&&(k!=b.mwg.Type.LONG&&k!=b.mwg.Type.INT||m<a||m>d))throw Error("Property "+c+" should be long value ["+a+","+d+"], currently "+m);}})};e.prototype.asDouble=function(c){return this.declare(c,{check:function(a,d){if(null!=d&&a!=b.mwg.Type.DOUBLE&&
a!=b.mwg.Type.INT&&a!=b.mwg.Type.LONG)throw Error("Property "+c+" should be double value, currently "+d);}})};e.prototype.asDoubleWithin=function(c,a,d){return this.declare(c,{check:function(k,m){if(null!=m&&(k!=b.mwg.Type.DOUBLE&&k!=b.mwg.Type.INT&&k!=b.mwg.Type.LONG||m<a||m>d))throw Error("Property "+c+" should be double value ["+a+","+d+"], currently "+m);}})};e.prototype.asInt=function(c){return this.declare(c,{check:function(a,d){if(null!=d&&a!=b.mwg.Type.INT&&a!=b.mwg.Type.LONG)throw Error("Property "+
c+" should be integer value, currently "+d);}})};e.prototype.asIntWithin=function(c,a,d){return this.declare(c,{check:function(k,m){if(null!=m&&(k!=b.mwg.Type.INT&&k!=b.mwg.Type.LONG||m<a||m>d))throw Error("Property "+c+" should be integer value ["+a+","+d+"], currently "+m);}})};e.prototype.asIntGreaterOrEquals=function(c,a){return this.declare(c,{check:function(d,k){if(null!=k&&(d!=b.mwg.Type.INT&&d!=b.mwg.Type.LONG||k<a))throw Error("Property "+c+" should be integer value >="+a+", currently "+
k);}})};e.prototype.asDoubleArray=function(c){return this.declare(c,{check:function(a,d){if(null!=d&&a!=b.mwg.Type.DOUBLE_ARRAY)throw Error("Property "+c+" should be doubleArray value, currently "+d);}})};e.prototype.asPositiveInt=function(c){return this.declare(c,{check:function(a,d){if(null!=d&&a!=b.mwg.Type.INT||0>=d)throw Error("Property "+c+" should be a positive integer, currently "+d);}})};e.prototype.asNonNegativeDouble=function(c){return this.declare(c,{check:function(a,d){if(null!=d&&(a!=
b.mwg.Type.DOUBLE&&a!=b.mwg.Type.INT&&a!=b.mwg.Type.LONG||!(0<=d)))throw Error("Property "+c+" should be a non-negative double, currently "+d);}})};e.prototype.asPositiveDouble=function(c){return this.declare(c,{check:function(a,d){if(null!=d&&(a!=b.mwg.Type.DOUBLE&&a!=b.mwg.Type.INT&&a!=b.mwg.Type.LONG||!(0<d)))throw Error("Property "+c+" should be a positive double, currently "+d);}})};e.prototype.asNonNegativeOrNanDouble=function(c){return this.declare(c,{check:function(a,d){if(null!=d&&(a!=b.mwg.Type.DOUBLE&&
a!=b.mwg.Type.INT&&a!=b.mwg.Type.LONG||0>d))throw Error("Property "+c+" should be a positive double, currently "+d);}})};e.prototype.asPositiveLong=function(c){return this.declare(c,{check:function(a,d){if(null!=d&&(a!=b.mwg.Type.LONG&&a!=b.mwg.Type.INT||0>=d))throw Error("Property "+c+" should be a positive long, currently "+d);}})};e.prototype.declare=function(b,a){this.checkers.put(b,a);return this};e.prototype.check=function(b,a,d){b=this.checkers.get(b);null!=b&&b.check(a,d)};return e}();f.Enforcer=
p;p=function(){function e(){}e.longHash=function(b,a){if(0>=a)throw Error("Max must be > 0");var d=e.PRIME5,d=d+b,d=(d+(d<<17))*e.PRIME4,d=d*e.PRIME1,d=d+b,d=(d+(d<<17))*e.PRIME4,d=d*e.PRIME1,d=d+e.len,d=(d^d>>>15)*e.PRIME2,d=d+b,d=(d^d>>>13)*e.PRIME3,d=d^d>>>16;return(0>d?-1*d:d)%a};e.tripleHash=function(b,a,d,k,m){if(0>=m)throw Error("Max must be > 0");var r=e.PRIME5,g=r*e.PRIME2+e.len,l=g*e.PRIME3,h=l*e.PRIME4,r=(r<<13|r>>>51)+a,g=(g<<11|g>>>53)+d,l=(l<<17|l>>>47)+k,h=(h<<19|h>>>45)+b,r=(r+(r<<
17|r>>>47))*e.PRIME1,g=(g+(g<<19|g>>>45))*e.PRIME1,l=(l+(l<<13|l>>>51))*e.PRIME1,h=(h+(h<<11|h>>>53))*e.PRIME1,h=h+e.PRIME5,r=(r+a)*e.PRIME2,g=(g+d)*e.PRIME2,l=(l+k)*e.PRIME2,h=h*e.PRIME2,r=(r+(r<<11|r>>>53))*e.PRIME3,g=(g+(g<<17|g>>>47))*e.PRIME3,l=(l+(l<<19|l>>>45))*e.PRIME3,h=(h+(h<<13|h>>>51))*e.PRIME3;b=r+(g<<3|g>>>61)+(l<<6|l>>>58)+(h<<9|h>>>55);b=(b^b>>>11)+(e.PRIME4+e.len)*e.PRIME1;b=(b^b>>>15)*e.PRIME2;b^=b>>>13;return(0>b?-1*b:b)%m};e.rand=function(){return 1E6*Math.random()};e.equals=function(b,
a){return b===a};e.DOUBLE_MIN_VALUE=function(){return Number.MIN_VALUE};e.DOUBLE_MAX_VALUE=function(){return Number.MAX_VALUE};e.isDefined=function(b){return void 0!=b&&null!=b};e.hash=function(b){var a=0,d,k,m;if(0===b.length)return a;d=0;for(m=b.length;d<m;d++)k=b.charCodeAt(d),a=(a<<5)-a+k,a|=0;return a};e.hashBytes=function(c){for(var a=b.mwg.utility.HashHelper.HSTART,d=c.length,k=0;k<d;k++)a=a.mul(b.mwg.utility.HashHelper.HMULT).xor(b.mwg.utility.HashHelper.byteTable[c[k]&255]);return a.mod(b.mwg.core.CoreConstants.END_OF_TIME).toNumber()};
e.PRIME1=2654435761;e.PRIME2=2246822519;e.PRIME3=3266489917;e.PRIME4=668265263;e.PRIME5=374761393;e.len=24;e.byteTable=function(){for(var b=[],a=Long.fromBits(3400472196,1414213562),d=0;256>d;d++){for(var k=0;31>k;k++)a=a.shiftRightUnsigned(7).xor(a),a=a.shiftLeft(11).xor(a),a=a.shiftRightUnsigned(10).xor(a);b[d]=a.toSigned()}return b}();e.HSTART=Long.fromBits(2718281828,3141592653);e.HMULT=Long.fromBits(3776338029,1784494570);return e}();f.HashHelper=p;p=function(){function e(){}e.keyToBuffer=function(c,
a,d,k,m){b.mwg.utility.Base64.encodeIntToBuffer(a,c);c.write(b.mwg.Constants.KEY_SEP);b.mwg.utility.Base64.encodeLongToBuffer(d,c);c.write(b.mwg.Constants.KEY_SEP);b.mwg.utility.Base64.encodeLongToBuffer(k,c);c.write(b.mwg.Constants.KEY_SEP);b.mwg.utility.Base64.encodeLongToBuffer(m,c)};return e}();f.KeyHelper=p;p=function(){function b(c,a){this._left=c;this._right=a}b.prototype.left=function(){return this._left};b.prototype.right=function(){return this._right};return b}();f.Tuple=p;p=function(){function b(){this.ctxIdents=
new java.util.HashMap}b.prototype.start=function(b){this.ctxIdents.put(b,0);console.log("StartTask:"+b)};b.prototype.beforeAction=function(b,a){for(var d=this.ctxIdents.get(a),k=0;k<d;k++)console.log("\t");console.log(a.template(b.toString()))};b.prototype.afterAction=function(b,a){};b.prototype.beforeTask=function(b,a){var d=this.ctxIdents.get(b);this.ctxIdents.put(a,d+1)};b.prototype.afterTask=function(b){this.ctxIdents.remove(b)};b.prototype.end=function(b){console.log("EndTask:"+b.toString())};
return b}();f.VerboseHook=p;p=function(){function e(){}e.prototype.newHook=function(){return new b.mwg.utility.VerboseHook};return e}();f.VerboseHookFactory=p;p=function(e){function c(){e.call(this);this.declareTaskHookFactory(new b.mwg.utility.VerboseHookFactory)}__extends(c,e);return c}(b.mwg.plugin.AbstractPlugin);f.VerbosePlugin=p})(f.utility||(f.utility={}))})(b.mwg||(b.mwg={}))})(org||(org={}));
(function(b){(function(f){(function(f){var t=function(){function f(){this.prefix=0}f.prototype.get=function(e,c){for(var a=this._graph.newBuffer(),d=e.iterator(),k=!0;d.hasNext();)d.next(),k?k=!1:a.write(b.mwg.core.CoreConstants.BUFFER_SEP);c(a)};f.prototype.put=function(b,c){null!=c&&c(!0)};f.prototype.remove=function(b,c){c(!0)};f.prototype.connect=function(b,c){this._graph=b;c(!0)};f.prototype.lock=function(e){var c=this._graph.newBuffer();b.mwg.utility.Base64.encodeIntToBuffer(this.prefix,c);
this.prefix++;e(c)};f.prototype.unlock=function(b,c){c(!0)};f.prototype.disconnect=function(b){this._graph=null;b(!0)};return f}();f.BlackHoleStorage=t;t=function(){function f(){}f.prototype.newGraph=function(e,c,a,d,k){null==e&&(e=new b.mwg.core.BlackHoleStorage);c&&(e=new b.mwg.core.utility.ReadOnlyStorage(e));c=a;null==c&&(c=new b.mwg.core.scheduler.TrampolineScheduler);-1==k&&(k=1E5);return new b.mwg.core.CoreGraph(e,k,c,d)};f.prototype.newTask=function(){return new b.mwg.core.task.CoreTask};
return f}();f.Builder=t;t=function(f){function e(){f.apply(this,arguments)}__extends(e,f);e.PREFIX_TO_SAVE_SIZE=2;e.NULL_KEY=new Float64Array([b.mwg.Constants.END_OF_TIME,b.mwg.Constants.END_OF_TIME,b.mwg.Constants.END_OF_TIME]);e.GLOBAL_UNIVERSE_KEY=new Float64Array([b.mwg.Constants.NULL_LONG,b.mwg.Constants.NULL_LONG,b.mwg.Constants.NULL_LONG]);e.GLOBAL_DICTIONARY_KEY=new Float64Array([b.mwg.Constants.NULL_LONG,0,0]);e.GLOBAL_INDEX_KEY=new Float64Array([b.mwg.Constants.NULL_LONG,1,0]);e.INDEX_ATTRIBUTE=
"index";e.DISCONNECTED_ERROR="Please connect your graph, prior to any usage of it";e.SCALE_1=1E3;e.SCALE_2=1E4;e.SCALE_3=1E5;e.SCALE_4=1E6;e.DEAD_NODE_ERROR="This Node has been tagged destroyed, please don't use it anymore!";return e}(b.mwg.Constants);f.CoreConstants=t;t=function(){function f(e,c,a,d){this._worldKeyCalculator=this._nodeKeyCalculator=this._prefix=null;var k=this,m=null,r=null,g=null;if(null!=d)for(var l=0;l<d.length;l++){var h=d[l],p=h.memoryFactory(),B=h.hookFactory();null!=p&&(m=
p);h=h.resolverFactory();null!=h&&(r=h);null!=B&&(g=B)}null==m&&(m=new b.mwg.core.memory.HeapMemoryFactory);null==r&&(r={newResolver:function(d,a){return new b.mwg.core.MWGResolver(d,a,k)}});this._hookFactory=g;this._storage=e;this._memoryFactory=m;this._space=m.newSpace(c,k);this._resolver=r.newResolver(this._storage,this._space);this._scheduler=a;this._taskActions=new java.util.HashMap;b.mwg.core.task.CoreTask.fillDefault(this._taskActions);if(null!=d)for(this._nodeTypes=new java.util.HashMap,l=
0;l<d.length;l++){h=d[l];c=h.nodeTypes();for(e=0;e<c.length;e++)a=c[e],this._nodeTypes.put(this._resolver.stringToHash(a,!1),h.nodeType(a));c=h.taskActionTypes();for(e=0;e<c.length;e++)a=c[e],this._taskActions.put(a,h.taskActionType(a))}else this._nodeTypes=null;this._isConnected=new java.util.concurrent.atomic.AtomicBoolean(!1);this._lock=new java.util.concurrent.atomic.AtomicBoolean(!1);this._plugins=d}f.prototype.fork=function(b){var c=this._worldKeyCalculator.newKey();this._resolver.initWorld(b,
c);return c};f.prototype.newNode=function(e,c){if(!this._isConnected.get())throw Error(b.mwg.core.CoreConstants.DISCONNECTED_ERROR);var a=new b.mwg.core.CoreNode(e,c,this._nodeKeyCalculator.newKey(),this);this._resolver.initNode(a,b.mwg.Constants.NULL_LONG);return a};f.prototype.newTypedNode=function(e,c,a){if(null==a)throw Error("nodeType should not be null");if(!this._isConnected.get())throw Error(b.mwg.core.CoreConstants.DISCONNECTED_ERROR);var d=this._resolver.stringToHash(a,!1),k=this.factoryByCode(d);
null==k?(console.log("WARNING: UnKnow NodeType "+a+", missing plugin configuration in the builder ? Using generic node as a fallback"),e=new b.mwg.core.CoreNode(e,c,this._nodeKeyCalculator.newKey(),this)):e=k(e,c,this._nodeKeyCalculator.newKey(),this);this._resolver.initNode(e,d);return e};f.prototype.cloneNode=function(e){if(null==e)throw Error("origin node should not be null");if(!this._isConnected.get())throw Error(b.mwg.core.CoreConstants.DISCONNECTED_ERROR);e.cacheLock();if(e._dead)throw e.cacheUnlock(),
Error(b.mwg.core.CoreConstants.DEAD_NODE_ERROR+" node id: "+e.id());this._space.mark(e._index_stateChunk);this._space.mark(e._index_superTimeTree);this._space.mark(e._index_timeTree);this._space.mark(e._index_worldOrder);var c=this._space.get(e._index_worldOrder),c=this.factoryByCode(c.extra()),c=null==c?new b.mwg.core.CoreNode(e.world(),e.time(),e.id(),this):c(e.world(),e.time(),e.id(),this);c._index_stateChunk=e._index_stateChunk;c._index_timeTree=e._index_timeTree;c._index_superTimeTree=e._index_superTimeTree;
c._index_worldOrder=e._index_worldOrder;c._world_magic=e._world_magic;c._super_time_magic=e._super_time_magic;c._time_magic=e._time_magic;e.cacheUnlock();return c};f.prototype.factoryByCode=function(e){return null!=this._nodeTypes&&e!=b.mwg.Constants.NULL_LONG?this._nodeTypes.get(e):null};f.prototype.taskAction=function(b){return null!=this._taskActions&&null!=b?this._taskActions.get(b):null};f.prototype.taskHookFactory=function(){return this._hookFactory};f.prototype.lookup=function(e,c,a,d){if(!this._isConnected.get())throw Error(b.mwg.core.CoreConstants.DISCONNECTED_ERROR);
this._resolver.lookup(e,c,a,d)};f.prototype.lookupAll=function(e,c,a,d){if(!this._isConnected.get())throw Error(b.mwg.core.CoreConstants.DISCONNECTED_ERROR);this._resolver.lookupAll(e,c,a,d)};f.prototype.save=function(b){this._space.save(b)};f.prototype.connect=function(e){for(var c=this,a=this;a._lock.compareAndSet(!1,!0);)this._isConnected.compareAndSet(!1,!0)?(a._scheduler.start(),a._storage.connect(a,function(d){a._storage.lock(function(d){c._prefix=b.mwg.utility.Base64.decodeToIntWithBounds(d,
0,d.length());d.free();var m=a.newBuffer();b.mwg.utility.KeyHelper.keyToBuffer(m,b.mwg.chunk.ChunkType.GEN_CHUNK,b.mwg.Constants.BEGINNING_OF_TIME,b.mwg.Constants.NULL_LONG,c._prefix);m.write(b.mwg.core.CoreConstants.BUFFER_SEP);b.mwg.utility.KeyHelper.keyToBuffer(m,b.mwg.chunk.ChunkType.GEN_CHUNK,b.mwg.Constants.END_OF_TIME,b.mwg.Constants.NULL_LONG,c._prefix);m.write(b.mwg.core.CoreConstants.BUFFER_SEP);b.mwg.utility.KeyHelper.keyToBuffer(m,b.mwg.chunk.ChunkType.WORLD_ORDER_CHUNK,0,0,b.mwg.Constants.NULL_LONG);
m.write(b.mwg.core.CoreConstants.BUFFER_SEP);b.mwg.utility.KeyHelper.keyToBuffer(m,b.mwg.chunk.ChunkType.STATE_CHUNK,b.mwg.core.CoreConstants.GLOBAL_DICTIONARY_KEY[0],b.mwg.core.CoreConstants.GLOBAL_DICTIONARY_KEY[1],b.mwg.core.CoreConstants.GLOBAL_DICTIONARY_KEY[2]);m.write(b.mwg.core.CoreConstants.BUFFER_SEP);a._storage.get(m,function(d){m.free();if(null!=d){var k=d.iterator(),l=k.next(),h=k.next(),f=k.next(),p=k.next(),k=!0;try{var u=a._space.createAndMark(b.mwg.chunk.ChunkType.WORLD_ORDER_CHUNK,
0,0,b.mwg.Constants.NULL_LONG);0<f.length()&&u.load(f);var y=a._space.createAndMark(b.mwg.chunk.ChunkType.STATE_CHUNK,b.mwg.core.CoreConstants.GLOBAL_DICTIONARY_KEY[0],b.mwg.core.CoreConstants.GLOBAL_DICTIONARY_KEY[1],b.mwg.core.CoreConstants.GLOBAL_DICTIONARY_KEY[2]);0<p.length()&&y.load(p);a._worldKeyCalculator=a._space.createAndMark(b.mwg.chunk.ChunkType.GEN_CHUNK,b.mwg.Constants.END_OF_TIME,b.mwg.Constants.NULL_LONG,c._prefix);0<h.length()&&a._worldKeyCalculator.load(h);a._nodeKeyCalculator=a._space.createAndMark(b.mwg.chunk.ChunkType.GEN_CHUNK,
b.mwg.Constants.BEGINNING_OF_TIME,b.mwg.Constants.NULL_LONG,c._prefix);0<l.length()&&a._nodeKeyCalculator.load(l);a._resolver.init();if(null!=c._plugins)for(l=0;l<c._plugins.length;l++){var q=c._plugins[l].nodeTypes();if(null!=q)for(h=0;h<q.length;h++)a._resolver.stringToHash(q[h],!0)}}catch(t){if(t instanceof Error)console.error(t),k=!1;else throw t;}d.free();a._lock.set(!0);b.mwg.utility.HashHelper.isDefined(e)&&e(k)}else a._lock.set(!0),b.mwg.utility.HashHelper.isDefined(e)&&e(!1)})})})):(a._lock.set(!0),
b.mwg.utility.HashHelper.isDefined(e)&&e(null))};f.prototype.disconnect=function(e){for(var c=function(){if(a._isConnected.compareAndSet(!0,!1)){var d=a;d._scheduler.stop();if(null!=a._plugins)for(var k=0;k<a._plugins.length;k++)a._plugins[k].stop();a.save(function(a){d._space.freeAll();if(null!=d._storage){var k=d.newBuffer();b.mwg.utility.Base64.encodeIntToBuffer(d._prefix,k);d._storage.unlock(k,function(a){k.free();d._storage.disconnect(function(a){d._lock.set(!0);b.mwg.utility.HashHelper.isDefined(e)&&
e(a)})})}else d._lock.set(!0),b.mwg.utility.HashHelper.isDefined(e)&&e(a)})}else a._lock.set(!0),b.mwg.utility.HashHelper.isDefined(e)&&e(null)},a=this;this._lock.compareAndSet(!1,!0);)c()};f.prototype.newBuffer=function(){return this._memoryFactory.newBuffer()};f.prototype.newQuery=function(){return new b.mwg.core.CoreQuery(this,this._resolver)};f.prototype.index=function(b,c,a,d){this.indexAt(c.world(),c.time(),b,c,a,d)};f.prototype.indexAt=function(e,c,a,d,k,m){if(null==a)throw Error("indexName should not be null");
if(null==d)throw Error("toIndexNode should not be null");if(null==k)throw Error("flatKeyAttributes should not be null");this.getIndexOrCreate(e,c,a,!0,function(a){if(null==a)throw Error("Index creation failed, cache is probably full !!!");a.index(b.mwg.core.CoreConstants.INDEX_ATTRIBUTE,d,k,function(d){a.free();b.mwg.utility.HashHelper.isDefined(m)&&m(d)})})};f.prototype.unindex=function(b,c,a,d){this.unindexAt(c.world(),c.time(),b,c,a,d)};f.prototype.unindexAt=function(e,c,a,d,k,m){if(null==a)throw Error("indexName should not be null");
if(null==d)throw Error("toIndexNode should not be null");if(null==k)throw Error("flatKeyAttributes should not be null");this.getIndexOrCreate(e,c,a,!1,function(a){null!=a?a.unindex(b.mwg.core.CoreConstants.INDEX_ATTRIBUTE,d,k,function(d){a.free();b.mwg.utility.HashHelper.isDefined(m)&&m(d)}):b.mwg.utility.HashHelper.isDefined(m)&&m(!1)})};f.prototype.indexes=function(e,c,a){var d=this;this._resolver.lookup(e,c,b.mwg.core.CoreConstants.END_OF_TIME,function(k){if(null==k)a([]);else{var m=k.get(b.mwg.core.CoreConstants.INDEX_ATTRIBUTE);
if(null==m)k.free(),a([]);else{var c=Array(m.size()),e=new Int32Array([0]);m.each(function(a,b){c[e[0]]=d._resolver.hashToString(a);e[0]++});k.free();a(c)}}})};f.prototype.find=function(e,c,a,d,k){if(null==a)throw Error("indexName should not be null");if(null==d)throw Error("query should not be null");this.getIndexOrCreate(e,c,a,!1,function(a){null==a?b.mwg.utility.HashHelper.isDefined(k)&&k([]):a.find(b.mwg.core.CoreConstants.INDEX_ATTRIBUTE,d,function(d){a.free();b.mwg.utility.HashHelper.isDefined(k)&&
k(d)})})};f.prototype.findByQuery=function(e,c){if(null==e)throw Error("query should not be null");if(e.world()==b.mwg.Constants.NULL_LONG)throw Error("Please fill world parameter in query before first usage!");if(e.time()==b.mwg.Constants.NULL_LONG)throw Error("Please fill time parameter in query before first usage!");if(null==e.indexName())throw Error("Please fill indexName parameter in query before first usage!");this.getIndexOrCreate(e.world(),e.time(),e.indexName(),!1,function(a){null==a?b.mwg.utility.HashHelper.isDefined(c)&&
c([]):(e.setIndexName(b.mwg.core.CoreConstants.INDEX_ATTRIBUTE),a.findByQuery(e,function(d){a.free();b.mwg.utility.HashHelper.isDefined(c)&&c(d)}))})};f.prototype.findAll=function(e,c,a,d){if(null==a)throw Error("indexName should not be null");this.getIndexOrCreate(e,c,a,!1,function(a){null==a?b.mwg.utility.HashHelper.isDefined(d)&&d([]):a.findAll(b.mwg.core.CoreConstants.INDEX_ATTRIBUTE,function(m){a.free();b.mwg.utility.HashHelper.isDefined(d)&&d(m)})})};f.prototype.getIndexNode=function(b,c,a,
d){if(null==a)throw Error("indexName should not be null");this.getIndexOrCreate(b,c,a,!1,d)};f.prototype.getIndexOrCreate=function(e,c,a,d,k){var m=this,r=this._resolver.stringToHash(a,d);this._resolver.lookup(e,c,b.mwg.core.CoreConstants.END_OF_TIME,function(a){if(null!=a||d){var l;null==a?(a=new b.mwg.core.CoreNode(e,c,b.mwg.core.CoreConstants.END_OF_TIME,m),m._resolver.initNode(a,b.mwg.core.CoreConstants.NULL_LONG),l=a.getOrCreate(b.mwg.core.CoreConstants.INDEX_ATTRIBUTE,b.mwg.Type.LONG_TO_LONG_MAP)):
l=a.get(b.mwg.core.CoreConstants.INDEX_ATTRIBUTE);var h=l.get(r);a.free();h==b.mwg.core.CoreConstants.NULL_LONG?d?(a=m.newNode(e,c),a.getOrCreate(b.mwg.core.CoreConstants.INDEX_ATTRIBUTE,b.mwg.Type.LONG_TO_LONG_ARRAY_MAP),h=a.id(),l.put(r,h),k(a)):k(null):m._resolver.lookup(e,c,h,k)}else k(null)})};f.prototype.newCounter=function(e){return new b.mwg.core.utility.CoreDeferCounter(e)};f.prototype.newSyncCounter=function(e){return new b.mwg.core.utility.CoreDeferCounterSync(e)};f.prototype.resolver=
function(){return this._resolver};f.prototype.scheduler=function(){return this._scheduler};f.prototype.space=function(){return this._space};f.prototype.storage=function(){return this._storage};f.prototype.freeNodes=function(b){if(null!=b)for(var c=0;c<b.length;c++)null!=b[c]&&b[c].free()};return f}();f.CoreGraph=t;t=function(b){function e(c,a,d,k){b.call(this,c,a,d,k)}__extends(e,b);return e}(b.mwg.plugin.AbstractNode);f.CoreNode=t;t=function(){function f(e,c){this.capacity=1;this._attributes=new Float64Array(this.capacity);
this._values=Array(this.capacity);this.size=0;this._time=this._world=b.mwg.Constants.NULL_LONG;this._indexName=null;this._graph=e;this._resolver=c;this._hash=null}f.prototype.parse=function(e){for(var c=0,a=b.mwg.Constants.NULL_LONG,d=0;c<e.length;)e.charAt(c)==b.mwg.Constants.QUERY_KV_SEP?(-1!=d&&(a=this._resolver.stringToHash(e.substring(d,c).trim(),!1)),d=c+1):e.charAt(c)==b.mwg.Constants.QUERY_SEP&&(a!=b.mwg.Constants.NULL_LONG&&this.internal_add(a,e.substring(d,c).trim()),a=b.mwg.Constants.NULL_LONG,
d=c+1),c++;a!=b.mwg.Constants.NULL_LONG&&this.internal_add(a,e.substring(d,c).trim());return this};f.prototype.add=function(b,c){this.internal_add(this._resolver.stringToHash(b.trim(),!1),c);return this};f.prototype.setWorld=function(b){this._world=b;return this};f.prototype.world=function(){return this._world};f.prototype.setTime=function(b){this._time=b;return this};f.prototype.time=function(){return this._time};f.prototype.setIndexName=function(b){this._indexName=b;return this};f.prototype.indexName=
function(){return this._indexName};f.prototype.hash=function(){null==this._hash&&this.compute();return this._hash};f.prototype.attributes=function(){return this._attributes};f.prototype.values=function(){return this._values};f.prototype.internal_add=function(b,c){if(this.size==this.capacity){var a=2*this.capacity,d=new Float64Array(a),k=Array(a);java.lang.System.arraycopy(this._attributes,0,d,0,this.capacity);java.lang.System.arraycopy(this._values,0,k,0,this.capacity);this._attributes=d;this._values=
k;this.capacity=a}this._attributes[this.size]=b;this._values[this.size]=c;this.size++};f.prototype.compute=function(){for(var e=this.size-1;0<=e;e--)for(var c=1;c<=e;c++)if(this._attributes[c-1]>this._attributes[c]){var a=this._attributes[c-1],d=this._values[c-1];this._attributes[c-1]=this._attributes[c];this._values[c-1]=this._values[c];this._attributes[c]=a;this._values[c]=d}c=this._graph.newBuffer();for(e=0;e<this.size;e++)b.mwg.utility.Base64.encodeLongToBuffer(this._attributes[e],c),null!=this._values[e]&&
b.mwg.utility.Base64.encodeStringToBuffer(this._values[e],c);this._hash=b.mwg.utility.HashHelper.hashBytes(c.data());c.free()};return f}();f.CoreQuery=t;t=function(){function f(b,c,a){this._space=c;this._storage=b;this._graph=a}f.prototype.init=function(){this.dictionary=this._space.getAndMark(b.mwg.chunk.ChunkType.STATE_CHUNK,b.mwg.core.CoreConstants.GLOBAL_DICTIONARY_KEY[0],b.mwg.core.CoreConstants.GLOBAL_DICTIONARY_KEY[1],b.mwg.core.CoreConstants.GLOBAL_DICTIONARY_KEY[2]);this.globalWorldOrderChunk=
this._space.getAndMark(b.mwg.chunk.ChunkType.WORLD_ORDER_CHUNK,0,0,b.mwg.Constants.NULL_LONG)};f.prototype.typeName=function(b){return this.hashToString(this.typeCode(b))};f.prototype.typeCode=function(e){e=this._space.get(e._index_worldOrder);return null==e?b.mwg.Constants.NULL_LONG:e.extra()};f.prototype.initNode=function(e,c){var a=this._space.createAndMark(b.mwg.chunk.ChunkType.STATE_CHUNK,e.world(),e.time(),e.id());this._space.notifyUpdate(a.index());var d=this._space.createAndMark(b.mwg.chunk.ChunkType.TIME_TREE_CHUNK,
e.world(),b.mwg.Constants.NULL_LONG,e.id());d.insert(e.time());var k=this._space.createAndMark(b.mwg.chunk.ChunkType.TIME_TREE_CHUNK,e.world(),e.time(),e.id());k.insert(e.time());var m=this._space.createAndMark(b.mwg.chunk.ChunkType.WORLD_ORDER_CHUNK,0,0,e.id());m.put(e.world(),e.time());c!=b.mwg.Constants.NULL_LONG&&m.setExtra(c);e._index_stateChunk=a.index();e._index_timeTree=k.index();e._index_superTimeTree=d.index();e._index_worldOrder=m.index();e._world_magic=-1;e._super_time_magic=-1;e._time_magic=
-1;e.init()};f.prototype.initWorld=function(b,c){this.globalWorldOrderChunk.put(c,b)};f.prototype.freeNode=function(b){b.cacheLock();b._dead||(this._space.unmark(b._index_stateChunk),this._space.unmark(b._index_timeTree),this._space.unmark(b._index_superTimeTree),this._space.unmark(b._index_worldOrder),b._dead=!0);b.cacheUnlock()};f.prototype.lookup=function(e,c,a,d){var k=this,m=this;try{m._space.getOrLoadAndMark(b.mwg.chunk.ChunkType.WORLD_ORDER_CHUNK,0,0,a,function(r){if(null==r)d(null);else{var g=
m.resolve_world(k.globalWorldOrderChunk,r,c,e);m._space.getOrLoadAndMark(b.mwg.chunk.ChunkType.TIME_TREE_CHUNK,g,b.mwg.Constants.NULL_LONG,a,function(k){if(null==k)m._space.unmark(r.index()),d(null);else{var f=k.previousOrEqual(c);f==b.mwg.Constants.NULL_LONG?(m._space.unmark(k.index()),m._space.unmark(r.index()),d(null)):m._space.getOrLoadAndMark(b.mwg.chunk.ChunkType.TIME_TREE_CHUNK,g,f,a,function(f){if(null==f)m._space.unmark(k.index()),m._space.unmark(r.index()),d(null);else{var h=f.previousOrEqual(c);
h==b.mwg.Constants.NULL_LONG?(m._space.unmark(f.index()),m._space.unmark(k.index()),m._space.unmark(r.index()),d(null)):m._space.getOrLoadAndMark(b.mwg.chunk.ChunkType.STATE_CHUNK,g,h,a,function(p){if(null==p)m._space.unmark(f.index()),m._space.unmark(k.index()),m._space.unmark(r.index()),d(null);else{var y=r.extra(),q=null;y!=b.mwg.Constants.NULL_LONG&&(q=m._graph.factoryByCode(y));y=null==q?new b.mwg.core.CoreNode(e,c,a,m._graph):q(e,c,a,m._graph);y._dead=!1;y._index_stateChunk=p.index();y._index_superTimeTree=
k.index();y._index_timeTree=f.index();y._index_worldOrder=r.index();g==e&&h==c?(y._world_magic=-1,y._super_time_magic=-1,y._time_magic=-1):(y._world_magic=r.magic(),y._super_time_magic=k.magic(),y._time_magic=f.magic());null!=d&&d(y)}})}})}})}})}catch(r){if(r instanceof Error)console.error(r);else throw r;}};f.prototype.lookupAll_end=function(b,c,a,d,k,m,r){if(null!=d||null!=k||null!=m||null!=r)for(var g=0;g<a;g++)null==b[g]&&(null!=d&&null!=d[g]&&this._space.unmark(d[g].index()),null!=k&&null!=k[g]&&
this._space.unmark(k[g].index()),null!=m&&null!=m[g]&&this._space.unmark(m[g].index()),null!=r&&null!=r[g]&&this._space.unmark(r[g].index()));c(b)};f.prototype.lookupAll=function(e,c,a,d){for(var k=this,m=this,r=a.length,g=Array(r),f=0;f<r;f++)g[f]=null;for(var h=[!0],n=new Float64Array(r*b.mwg.Constants.KEY_SIZE),f=0;f<r;f++)h[0]=!1,n[f*b.mwg.Constants.KEY_SIZE]=b.mwg.chunk.ChunkType.WORLD_ORDER_CHUNK,n[f*b.mwg.Constants.KEY_SIZE+1]=0,n[f*b.mwg.Constants.KEY_SIZE+2]=0,n[f*b.mwg.Constants.KEY_SIZE+
3]=a[f];h[0]?this.lookupAll_end(g,d,r,null,null,null,null):m._space.getOrLoadAndMarkAll(n,function(f){if(null==f)k.lookupAll_end(g,d,r,null,null,null,null);else{h[0]=!0;for(var l=0;l<r;l++)null!=f[l]?(h[0]=!1,n[l*b.mwg.Constants.KEY_SIZE]=b.mwg.chunk.ChunkType.TIME_TREE_CHUNK,n[l*b.mwg.Constants.KEY_SIZE+1]=m.resolve_world(k.globalWorldOrderChunk,f[l],c,e),n[l*b.mwg.Constants.KEY_SIZE+2]=b.mwg.Constants.NULL_LONG):n[l*b.mwg.Constants.KEY_SIZE]=-1;h[0]?k.lookupAll_end(g,d,r,f,null,null,null):m._space.getOrLoadAndMarkAll(n,
function(l){if(null==l)k.lookupAll_end(g,d,r,f,null,null,null);else{h[0]=!0;for(var p=0;p<r;p++)if(null!=l[p]){var u=l[p].previousOrEqual(c);u==b.mwg.Constants.NULL_LONG?n[p*b.mwg.Constants.KEY_SIZE]=-1:(h[0]=!1,n[p*b.mwg.Constants.KEY_SIZE+2]=u)}else n[p*b.mwg.Constants.KEY_SIZE]=-1;h[0]?k.lookupAll_end(g,d,r,f,l,null,null):m._space.getOrLoadAndMarkAll(n,function(p){if(null==p)k.lookupAll_end(g,d,r,f,l,null,null);else{h[0]=!0;for(var u=0;u<r;u++)if(null!=p[u]){var q=p[u].previousOrEqual(c);q==b.mwg.Constants.NULL_LONG?
n[u*b.mwg.Constants.KEY_SIZE]=-1:(h[0]=!1,n[u*b.mwg.Constants.KEY_SIZE]=b.mwg.chunk.ChunkType.STATE_CHUNK,n[u*b.mwg.Constants.KEY_SIZE+2]=q)}else n[u*b.mwg.Constants.KEY_SIZE]=-1;h[0]?k.lookupAll_end(g,d,r,f,l,p,null):m._space.getOrLoadAndMarkAll(n,function(h){if(null==h)k.lookupAll_end(g,d,r,f,l,p,null);else{for(var n=0;n<r;n++)if(null!=h[n]){var u=f[n].extra(),q=null;u!=b.mwg.Constants.NULL_LONG&&(q=m._graph.factoryByCode(u));u=null==q?new b.mwg.core.CoreNode(e,c,a[n],m._graph):q(e,c,a[n],m._graph);
u._dead=!1;u._index_stateChunk=h[n].index();u._index_superTimeTree=l[n].index();u._index_timeTree=p[n].index();u._index_worldOrder=f[n].index();h[n].world()==e&&h[n].time()==c?(u._world_magic=-1,u._super_time_magic=-1,u._time_magic=-1):(u._world_magic=f[n].magic(),u._super_time_magic=l[n].magic(),u._time_magic=p[n].magic());g[n]=u}k.lookupAll_end(g,d,r,f,l,p,h)}})}})}})}})};f.prototype.resolve_world=function(e,c,a,d){if(null==e||null==c)return d;for(var k=d,m=b.mwg.Constants.NULL_LONG,r=c.get(k);k!=
m;){if(r!=b.mwg.Constants.NULL_LONG&&r<=a)return k;m=k;k=e.get(k);r=c.get(k)}return d};f.prototype.getOrLoadAndMarkAll=function(e,c,a){for(var d=c.length/f.KEY_SIZE,k=[],m=0,r=Array(d),g=0;g<d;g++)c[g*f.KEY_SIZE]==b.mwg.core.CoreConstants.NULL_KEY[0]&&c[g*f.KEY_SIZE+1]==b.mwg.core.CoreConstants.NULL_KEY[1]&&c[g*f.KEY_SIZE+2]==b.mwg.core.CoreConstants.NULL_KEY[2]?(k[g]=!1,r[g]=null):(r[g]=this._space.getAndMark(e[g],c[g*f.KEY_SIZE],c[g*f.KEY_SIZE+1],c[g*f.KEY_SIZE+2]),null==r[g]?(k[g]=!0,m++):k[g]=
!1);if(0==m)a(r);else{for(var l=this._graph.newBuffer(),h=new Int32Array(m),g=m=0;g<d;g++)k[g]&&(h[m]=g,0!=m&&l.write(b.mwg.core.CoreConstants.BUFFER_SEP),b.mwg.utility.KeyHelper.keyToBuffer(l,e[g],c[g*f.KEY_SIZE],c[g*f.KEY_SIZE+1],c[g*f.KEY_SIZE+2]),m+=1);var n=this;this._storage.get(l,function(d){l.free();for(var k=d.iterator(),m=0;k.hasNext();){var g=h[m],f=k.next();0<f.length()?(r[g]=n._space.createAndMark(e[g],c[g*b.mwg.core.MWGResolver.KEY_SIZE],c[g*b.mwg.core.MWGResolver.KEY_SIZE+1],c[g*b.mwg.core.MWGResolver.KEY_SIZE+
2]),r[g].load(f)):r[g]=null;m++}d.free();a(r)})}};f.prototype.resolveState=function(b){return this.internal_resolveState(b,!0)};f.prototype.internal_resolveState=function(e,c){var a=null;c&&e.cacheLock();if(e._dead)throw c&&e.cacheUnlock(),Error(b.mwg.core.CoreConstants.DEAD_NODE_ERROR+" node id: "+e.id());if(-1==e._world_magic&&-1==e._time_magic&&-1==e._super_time_magic)a=this._space.get(e._index_stateChunk);else{var d=this._space.get(e._index_worldOrder),k=this._space.get(e._index_superTimeTree),
m=this._space.get(e._index_timeTree);if(null!=d&&null!=k&&null!=m)if(e._world_magic==d.magic()&&e._super_time_magic==k.magic()&&e._time_magic==m.magic())a=this._space.get(e._index_stateChunk);else{c&&d.lock();var a=e.time(),r=e.id(),g=e.world(),f=this.resolve_world(this.globalWorldOrderChunk,d,a,g);if(f!=k.world()){var h=this._space.getAndMark(b.mwg.chunk.ChunkType.TIME_TREE_CHUNK,f,b.mwg.core.CoreConstants.NULL_LONG,r);null!=h&&(this._space.unmark(k.index()),k=h)}h=k.previousOrEqual(a);h!=m.time()&&
(h=this._space.getAndMark(b.mwg.chunk.ChunkType.TIME_TREE_CHUNK,f,h,r),null!=h&&(this._space.unmark(m.index()),m=h));h=m.previousOrEqual(a);f==g&&h==a?(e._world_magic=-1,e._time_magic=-1,e._super_time_magic=-1):(e._world_magic=d.magic(),e._time_magic=m.magic(),e._super_time_magic=k.magic(),e._index_superTimeTree=k.index(),e._index_timeTree=m.index());a=this._space.get(e._index_stateChunk);if(f!=a.world()||h!=a.time())k=this._space.getAndMark(b.mwg.chunk.ChunkType.STATE_CHUNK,f,h,r),null!=k&&(this._space.unmark(a.index()),
a=k);e._index_stateChunk=a.index();c&&d.unlock()}}c&&e.cacheUnlock();return a};f.prototype.alignState=function(e){e.cacheLock();if(e._dead)throw e.cacheUnlock(),Error(b.mwg.core.CoreConstants.DEAD_NODE_ERROR+" node id: "+e.id());if(-1==e._world_magic&&-1==e._time_magic&&-1==e._super_time_magic){var c=this._space.get(e._index_stateChunk);if(null!=c)return e.cacheUnlock(),c}c=this._space.get(e._index_worldOrder);if(null==c)return e.cacheUnlock(),null;c.lock();var a=e.world(),d=e.time(),k=e.id(),m=this.internal_resolveState(e,
!1);if(-1==e._world_magic&&-1==e._time_magic&&-1==e._super_time_magic)return c.unlock(),e.cacheUnlock(),m;var r=this._space.createAndMark(b.mwg.chunk.ChunkType.STATE_CHUNK,a,d,k);r.loadFrom(m);e._world_magic=-1;e._super_time_magic=-1;e._time_magic=-1;e._index_stateChunk=r.index();this._space.unmark(m.index());if(m.world()==a||c.get(a)!=b.mwg.core.CoreConstants.NULL_LONG){var m=this._space.get(e._index_superTimeTree),g=this._space.get(e._index_timeTree),f=m.size(),h=2*b.mwg.core.CoreConstants.SCALE_1;
f>h&&(h=2*b.mwg.core.CoreConstants.SCALE_2);f>h&&(h=2*b.mwg.core.CoreConstants.SCALE_3);f>h&&(h=2*b.mwg.core.CoreConstants.SCALE_4);g.insert(d);if(g.size()==h){var n=new Float64Array([-1]);g.range(b.mwg.core.CoreConstants.BEGINNING_OF_TIME,b.mwg.core.CoreConstants.END_OF_TIME,g.size()/2,function(d){n[0]=d});var p=this._space.createAndMark(b.mwg.chunk.ChunkType.TIME_TREE_CHUNK,a,n[0],k);g.range(b.mwg.core.CoreConstants.BEGINNING_OF_TIME,b.mwg.core.CoreConstants.END_OF_TIME,g.size()/2,function(d){p.unsafe_insert(d)});
this._space.notifyUpdate(p.index());m.insert(n[0]);g.clearAt(n[0]);d<n[0]?this._space.unmark(p.index()):(e._index_timeTree=p.index(),this._space.unmark(g.index()))}}else m=this._space.createAndMark(b.mwg.chunk.ChunkType.TIME_TREE_CHUNK,a,b.mwg.core.CoreConstants.NULL_LONG,k),m.insert(d),k=this._space.createAndMark(b.mwg.chunk.ChunkType.TIME_TREE_CHUNK,a,d,k),k.insert(d),c.put(a,d),this._space.unmark(e._index_timeTree),this._space.unmark(e._index_superTimeTree),e._index_timeTree=k.index(),e._index_superTimeTree=
m.index();c.unlock();e.cacheUnlock();return r};f.prototype.newState=function(e,c,a){e.cacheLock();a=new b.mwg.core.CoreNode(c,a,e.id(),e.graph());a._index_worldOrder=e._index_worldOrder;a._index_superTimeTree=e._index_superTimeTree;a._index_timeTree=e._index_timeTree;a._index_stateChunk=e._index_stateChunk;a._time_magic=e._time_magic;a._super_time_magic=e._super_time_magic;a._world_magic=e._world_magic;c=this.alignState(a);e._index_worldOrder=a._index_worldOrder;e._index_superTimeTree=a._index_superTimeTree;
e._index_timeTree=a._index_timeTree;e._index_stateChunk=a._index_stateChunk;e._time_magic=a._time_magic;e._super_time_magic=a._super_time_magic;e._world_magic=a._world_magic;e.cacheUnlock();return c};f.prototype.resolveTimepoints=function(e,c,a,d){var k=this;this._space.getOrLoadAndMark(b.mwg.chunk.ChunkType.WORLD_ORDER_CHUNK,0,0,e.id(),function(m){if(null==m)d(new Float64Array(0));else{for(var r=new Int32Array([b.mwg.core.CoreConstants.MAP_INITIAL_CAPACITY]),g=[new Float64Array(r[0])],f=0,h=e.world();h!=
b.mwg.core.CoreConstants.NULL_LONG;){var n=m.get(h);if(n!=b.mwg.core.CoreConstants.NULL_LONG)if(n<=c){g[0][f]=h;f++;break}else n>a||(g[0][f]=h,f++,f==r[0]&&(n=new Float64Array(2*r[0]),java.lang.System.arraycopy(g[0],0,n,0,r[0]),g[0]=n,r[0]*=2)),h=k.globalWorldOrderChunk.get(h);else h=k.globalWorldOrderChunk.get(h)}k.resolveTimepointsFromWorlds(k.globalWorldOrderChunk,m,e,c,a,g[0],f,d)}})};f.prototype.resolveTimepointsFromWorlds=function(e,c,a,d,k,m,r,g){var f=this;e=new Float64Array(3*r);for(var h=
new Int8Array(r),n=0;n<r;n++)e[3*n]=m[n],e[3*n+1]=b.mwg.core.CoreConstants.NULL_LONG,e[3*n+2]=a.id(),h[n]=b.mwg.chunk.ChunkType.TIME_TREE_CHUNK;this.getOrLoadAndMarkAll(h,e,function(e){if(null==e)f._space.unmark(c.index()),g(new Float64Array(0));else{for(var h=new Int32Array([b.mwg.core.CoreConstants.MAP_INITIAL_CAPACITY]),n=[new Float64Array(h[0])],p=[new Float64Array(h[0])],q=new Int32Array([0]),t=k,D=function(d){var a=e[d];if(null!=a){d=c.get(m[d]);var k=t;a.range(d,t,b.mwg.core.CoreConstants.END_OF_TIME,
function(d){if(d!=k&&(n[0][q[0]]=d,p[0][q[0]]=a.world(),q[0]++,h[0]==q[0])){d=new Float64Array(2*h[0]);var b=new Float64Array(2*h[0]);java.lang.System.arraycopy(n[0],0,d,0,h[0]);java.lang.System.arraycopy(p[0],0,b,0,h[0]);n[0]=d;p[0]=b;h[0]*=2}});t=d}f._space.unmark(a.index())},v=0;v<r;v++)D(v);f.resolveTimepointsFromSuperTimes(c,a,d,k,p[0],n[0],q[0],g)}})};f.prototype.resolveTimepointsFromSuperTimes=function(e,c,a,d,k,m,r,g){for(var f=this,h=new Float64Array(3*r),n=new Int8Array(r),p=0;p<r;p++)h[3*
p]=k[p],h[3*p+1]=m[p],h[3*p+2]=c.id(),n[p]=b.mwg.chunk.ChunkType.TIME_TREE_CHUNK;this.getOrLoadAndMarkAll(n,h,function(m){if(null==m)f._space.unmark(e.index()),g(new Float64Array(0));else{for(var c=new Int32Array([b.mwg.core.CoreConstants.MAP_INITIAL_CAPACITY]),h=[new Float64Array(c[0])],n=new Int32Array([0]),p=d,B=function(d){var g=m[d];if(null!=g){var B=e.get(k[d]);B<a&&(B=a);var q=p;g.range(B,p,b.mwg.core.CoreConstants.END_OF_TIME,function(d){d!=q&&(h[0][n[0]]=d,n[0]++,c[0]==n[0]&&(d=new Float64Array(2*
c[0]),java.lang.System.arraycopy(h[0],0,d,0,c[0]),h[0]=d,c[0]*=2))});d<r-1&&k[d+1]!=k[d]&&(p=B)}f._space.unmark(g.index())},q=0;q<r;q++)B(q);n[0]!=c[0]&&(B=new Float64Array(n[0]),java.lang.System.arraycopy(h[0],0,B,0,n[0]),h[0]=B);f._space.unmark(e.index());g(h[0])}})};f.prototype.stringToHash=function(e,c){var a=b.mwg.utility.HashHelper.hash(e);if(c){var d=this.dictionary.get(0);null==d&&(d=this.dictionary.getOrCreate(0,b.mwg.Type.STRING_TO_LONG_MAP));d.containsHash(a)||d.put(e,a)}return a};f.prototype.hashToString=
function(b){var c=this.dictionary.get(0);return null!=c?c.getByHash(b):null};f.KEY_SIZE=3;return f}();f.MWGResolver=t;(function(f){(function(e){var c=function(){function a(d){this._back=new Int8Array(d)}a.prototype.get=function(d){return this._back[d]};a.prototype.set=function(d,a){this._back[d]=a};return a}();e.HeapAtomicByteArray=c;c=function(){function a(d,k){this._graph=k;this._maxEntries=d;this._hashEntries=d*a.HASH_LOAD_FACTOR;this._lru=new b.mwg.core.chunk.heap.HeapFixedStack(d,!0);this._dirtiesStack=
new b.mwg.core.chunk.heap.HeapFixedStack(d,!1);this._hashNext=new java.util.concurrent.atomic.AtomicIntegerArray(d);this._hash=new java.util.concurrent.atomic.AtomicIntegerArray(this._hashEntries);for(var m=0;m<d;m++)this._hashNext.set(m,-1);for(m=0;m<this._hashEntries;m++)this._hash.set(m,-1);this._chunkValues=new java.util.concurrent.atomic.AtomicReferenceArray(d);this._chunkWorlds=new java.util.concurrent.atomic.AtomicLongArray(this._maxEntries);this._chunkTimes=new java.util.concurrent.atomic.AtomicLongArray(this._maxEntries);
this._chunkIds=new java.util.concurrent.atomic.AtomicLongArray(this._maxEntries);this._chunkTypes=new b.mwg.core.chunk.heap.HeapAtomicByteArray(this._maxEntries);this._chunkMarks=new java.util.concurrent.atomic.AtomicLongArray(this._maxEntries);for(m=0;m<this._maxEntries;m++)this._chunkMarks.set(m,0)}a.prototype.graph=function(){return this._graph};a.prototype.worldByIndex=function(d){return this._chunkWorlds.get(d)};a.prototype.timeByIndex=function(d){return this._chunkTimes.get(d)};a.prototype.idByIndex=
function(d){return this._chunkIds.get(d)};a.prototype.getAndMark=function(d,a,m,c){for(var e=b.mwg.utility.HashHelper.tripleHash(d,a,m,c,this._hashEntries),e=this._hash.get(e),f=-1;-1!=e;)if(this._chunkTypes.get(e)==d&&this._chunkWorlds.get(e)==a&&this._chunkTimes.get(e)==m&&this._chunkIds.get(e)==c){0<this.mark(e)&&(f=e);break}else e=this._hashNext.get(e);return-1!=f?this._chunkValues.get(f):null};a.prototype.get=function(d){return this._chunkValues.get(d)};a.prototype.getOrLoadAndMark=function(d,
a,m,c,e){var f=this,h=this.getAndMark(d,a,m,c);if(null!=h)e(h);else{var n=this.graph().newBuffer();b.mwg.utility.KeyHelper.keyToBuffer(n,d,a,m,c);this.graph().storage().get(n,function(b){if(null!=b&&0<b.length()){var h=f.createAndMark(d,a,m,c);h.load(b);b.free();e(h)}else n.free(),e(null)})}};a.prototype.getOrLoadAndMarkAll=function(d,a){for(var m=this,c=d.length/b.mwg.Constants.KEY_SIZE,e=Array(c),f=null,h=0,n=null,p=0;p<c;p++){var u=p*b.mwg.Constants.KEY_SIZE;if(-1!=d[u]){var q=this.getAndMark(d[u],
d[u+1],d[u+2],d[u+3]);null!=q?e[p]=q:(null==f&&(f=new Int32Array(c),n=this.graph().newBuffer()),f[h]=p,0!=h&&n.write(b.mwg.Constants.BUFFER_SEP),b.mwg.utility.KeyHelper.keyToBuffer(n,d[u],d[u+1],d[u+2],d[u+3]),h++)}else e[p]=null}if(null!=f){var t=f;this.graph().storage().get(n,function(c){for(var r=c.iterator(),f=0;r.hasNext();){var h=r.next(),l=t[f],n=l*b.mwg.Constants.KEY_SIZE;0<h.length()?(n=m.createAndMark(d[n],d[n+1],d[n+2],d[n+3]),n.load(h),e[l]=n):e[l]=null;f++}c.free();a(e)})}else a(e)};
a.prototype.mark=function(d){var a,b;do a=this._chunkMarks.get(d),b=-1!=a?a+1:a;while(!this._chunkMarks.compareAndSet(d,a,b));0==a&&1==b&&this._lru.dequeue(d);return b};a.prototype.unmark=function(d){var a,b;do a=this._chunkMarks.get(d),0<a?b=a-1:(console.error("WARNING: DOUBLE UNMARK"),b=a);while(!this._chunkMarks.compareAndSet(d,a,b));1==a&&0==b&&this._lru.enqueue(d)};a.prototype.free=function(d){};a.prototype.createAndMark=function(d,a,m,c){for(var e=-1,f=b.mwg.utility.HashHelper.tripleHash(d,
a,m,c,this._hashEntries),h=this._hash.get(f);0<=h;){if(d==this._chunkTypes.get(h)&&a==this._chunkWorlds.get(h)&&m==this._chunkTimes.get(h)&&c==this._chunkIds.get(h)){e=h;break}h=this._hashNext.get(h)}if(-1!=e){var n;do h=this._chunkMarks.get(e),n=-1!=h?h+1:h;while(!this._chunkMarks.compareAndSet(e,h,n));if(n==h+1)return this._chunkValues.get(e)}for(e=-1;-1==e&&(h=this._lru.dequeueTail(),-1!=h);)this._chunkMarks.compareAndSet(h,0,-1)&&(e=h);if(-1==e)throw Error("mwDB crashed, cache is full, please avoid to much retention of nodes or augment cache capacity! available:"+
this.available());n=null;switch(d){case b.mwg.chunk.ChunkType.STATE_CHUNK:n=new b.mwg.core.chunk.heap.HeapStateChunk(this,e);break;case b.mwg.chunk.ChunkType.WORLD_ORDER_CHUNK:n=new b.mwg.core.chunk.heap.HeapWorldOrderChunk(this,e);break;case b.mwg.chunk.ChunkType.TIME_TREE_CHUNK:n=new b.mwg.core.chunk.heap.HeapTimeTreeChunk(this,e);break;case b.mwg.chunk.ChunkType.GEN_CHUNK:n=new b.mwg.core.chunk.heap.HeapGenChunk(this,c,e)}if(null!=this._chunkValues.get(e)){for(var p=this._chunkWorlds.get(e),u=
this._chunkTimes.get(e),q=this._chunkIds.get(e),t=this._chunkTypes.get(e),x=b.mwg.utility.HashHelper.tripleHash(t,p,u,q,this._hashEntries),h=this._hash.get(x),z=-1;0<=h&&(t!=this._chunkTypes.get(h)||p!=this._chunkWorlds.get(h)||u!=this._chunkTimes.get(h)||q!=this._chunkIds.get(h));)z=h,h=this._hashNext.get(h);-1==z?(p=this._hashNext.get(h),this._hash.set(x,p)):-1==h?this._hashNext.set(z,-1):this._hashNext.set(z,this._hashNext.get(h));this._hashNext.set(h,-1)}this._chunkValues.set(e,n);this._chunkMarks.set(e,
1);this._chunkTypes.set(e,d);this._chunkWorlds.set(e,a);this._chunkTimes.set(e,m);this._chunkIds.set(e,c);this._hashNext.set(e,this._hash.get(f));this._hash.set(f,e);return n};a.prototype.notifyUpdate=function(d){this._dirtiesStack.enqueue(d)&&this.mark(d)};a.prototype.save=function(d){for(var a=this._graph.newBuffer(),m=!0;0!=this._dirtiesStack.size();){var c=this._dirtiesStack.dequeueTail(),e=this._chunkValues.get(c);m?m=!1:a.write(b.mwg.Constants.BUFFER_SEP);b.mwg.utility.KeyHelper.keyToBuffer(a,
this._chunkTypes.get(c),this._chunkWorlds.get(c),this._chunkTimes.get(c),this._chunkIds.get(c));a.write(b.mwg.Constants.BUFFER_SEP);try{e.save(a),this.unmark(c)}catch(f){if(f instanceof Error)console.error(f);else throw f;}}this.graph().storage().put(a,function(b){a.free();null!=d&&d(b)})};a.prototype.clear=function(){};a.prototype.freeAll=function(){};a.prototype.available=function(){return this._lru.size()};a.prototype.printMarked=function(){for(var d=0;d<this._chunkValues.length();d++)if(null!=
this._chunkValues.get(d)&&0!=this._chunkMarks.get(d))switch(this._chunkTypes.get(d)){case b.mwg.chunk.ChunkType.STATE_CHUNK:console.log("STATE("+this._chunkWorlds.get(d)+","+this._chunkTimes.get(d)+","+this._chunkIds.get(d)+")->marks->"+this._chunkMarks.get(d));break;case b.mwg.chunk.ChunkType.TIME_TREE_CHUNK:console.log("TIME_TREE("+this._chunkWorlds.get(d)+","+this._chunkTimes.get(d)+","+this._chunkIds.get(d)+")->marks->"+this._chunkMarks.get(d));break;case b.mwg.chunk.ChunkType.WORLD_ORDER_CHUNK:console.log("WORLD_ORDER("+
this._chunkWorlds.get(d)+","+this._chunkTimes.get(d)+","+this._chunkIds.get(d)+")->marks->"+this._chunkMarks.get(d));break;case b.mwg.chunk.ChunkType.GEN_CHUNK:console.log("GENERATOR("+this._chunkWorlds.get(d)+","+this._chunkTimes.get(d)+","+this._chunkIds.get(d)+")->marks->"+this._chunkMarks.get(d))}};a.HASH_LOAD_FACTOR=4;return a}();e.HeapChunkSpace=c;c=function(){function a(d,a){this._capacity=d;this._next=new Int32Array(d);this._prev=new Int32Array(d);this._last=this._first=-1;java.util.Arrays.fill(this._next,
0,d,-1);java.util.Arrays.fill(this._prev,0,d,-1);if(a){for(var b=0;b<d;b++){var c=this._last;this._prev[b]=c;this._last=b;-1==this._first?this._first=b:this._next[c]=b}this._count=d}else this._count=0}a.prototype.enqueue=function(d){if(this._count>=this._capacity||this._first==d||this._last==d||-1!=this._prev[d]||-1!=this._next[d])return!1;var a=this._last;this._prev[d]=a;this._last=d;-1==this._first?this._first=d:this._next[a]=d;this._count++;return!0};a.prototype.dequeueTail=function(){var d=this._first;
if(-1==d)return-1;var a=this._next[d];this._next[d]=-1;this._prev[d]=-1;this._first=a;-1==a?this._last=-1:this._prev[a]=-1;this._count--;return d};a.prototype.dequeue=function(d){var a=this._prev[d],b=this._next[d];if(-1==a&&-1==b)return!1;if(-1==a){d=this._first;if(-1==d)return!1;a=this._next[d];this._next[d]=-1;this._prev[d]=-1;this._first=a;-1==a?this._last=-1:this._prev[a]=-1;--this._count}else if(-1==b){d=this._last;if(-1==d)return!1;a=this._prev[d];this._prev[d]=-1;this._next[d]=-1;this._last=
a;-1==a?this._first=-1:this._next[a]=-1;--this._count}else this._next[a]=b,this._prev[b]=a,this._prev[d]=-1,this._next[d]=-1,this._count--;return!0};a.prototype.free=function(){};a.prototype.size=function(){return this._count};return a}();e.HeapFixedStack=c;c=function(){function a(d,a,c){this._index=c;this._space=d;this._prefix=Long.fromNumber(a).shiftLeft(b.mwg.Constants.LONG_SIZE-b.mwg.Constants.PREFIX_SIZE);this._seed=-1}a.prototype.save=function(d){b.mwg.utility.Base64.encodeLongToBuffer(this._seed,
d);this._dirty=!1};a.prototype.load=function(d){if(null!=d&&0!=d.length()){d=b.mwg.utility.Base64.decodeToLongWithBounds(d,0,d.length());var a=this._seed;this._seed=d;-1==a||a==this._seed||null==this._space||this._dirty||(this._dirty=!0,this._space.notifyUpdate(this._index))}};a.prototype.newKey=function(){if(this._seed==b.mwg.Constants.KEY_PREFIX_MASK)throw Error("Object Index could not be created because it exceeded the capacity of the current prefix. Ask for a new prefix.");-1==this._seed&&(this._seed=
0);this._seed++;this._space&&this._space.notifyUpdate(this._index);var d=this._prefix.add(this._seed).toNumber();if(d>=b.mwg.Constants.NULL_LONG)throw Error("Object Index exceeds the maximum JavaScript number capacity. (2^"+b.mwg.Constants.LONG_SIZE+")");return d};a.prototype.index=function(){return this._index};a.prototype.world=function(){return this._space.worldByIndex(this._index)};a.prototype.time=function(){return this._space.timeByIndex(this._index)};a.prototype.id=function(){return this._space.idByIndex(this._index)};
a.prototype.chunkType=function(){return b.mwg.chunk.ChunkType.GEN_CHUNK};return a}();e.HeapGenChunk=c;c=function(){function a(d){this.capacity=this.mapSize=0;this.hashs=this.nexts=this.values=this.keys=null;this.parent=d}a.prototype.key=function(d){return this.keys[d]};a.prototype.setKey=function(d,a){this.keys[d]=a};a.prototype.value=function(d){return this.values[d]};a.prototype.setValue=function(d,a){this.values[d]=a};a.prototype.next=function(d){return this.nexts[d]};a.prototype.setNext=function(d,
a){this.nexts[d]=a};a.prototype.hash=function(d){return this.hashs[d]};a.prototype.setHash=function(d,a){this.hashs[d]=a};a.prototype.reallocate=function(d){if(d>this.capacity){var a=new Float64Array(d);null!=this.keys&&java.lang.System.arraycopy(this.keys,0,a,0,this.capacity);this.keys=a;a=new Float64Array(d);null!=this.values&&java.lang.System.arraycopy(this.values,0,a,0,this.capacity);this.values=a;var a=new Int32Array(d),c=new Int32Array(2*d);java.util.Arrays.fill(a,0,d,-1);java.util.Arrays.fill(c,
0,2*d,-1);this.hashs=c;this.nexts=a;for(a=0;a<this.mapSize;a++)c=b.mwg.utility.HashHelper.longHash(this.key(a),2*d),this.setNext(a,this.hash(c)),this.setHash(c,a);this.capacity=d}};a.prototype.cloneFor=function(d){d=new b.mwg.core.chunk.heap.HeapLongLongArrayMap(d);d.mapSize=this.mapSize;d.capacity=this.capacity;if(null!=this.keys){var a=new Float64Array(this.capacity);java.lang.System.arraycopy(this.keys,0,a,0,this.capacity);d.keys=a}null!=this.values&&(a=new Float64Array(this.capacity),java.lang.System.arraycopy(this.values,
0,a,0,this.capacity),d.values=a);null!=this.nexts&&(a=new Int32Array(this.capacity),java.lang.System.arraycopy(this.nexts,0,a,0,this.capacity),d.nexts=a);null!=this.hashs&&(a=new Int32Array(2*this.capacity),java.lang.System.arraycopy(this.hashs,0,a,0,2*this.capacity),d.hashs=a);return d};a.prototype.get=function(d){var a=new Float64Array(0);if(null!=this.keys){for(var c=b.mwg.utility.HashHelper.longHash(d,2*this.capacity),e=0,g=0,c=this.hash(c);0<=c;){if(d==this.key(c)){if(g==e){var e=0==e?1:2*e,
f=new Float64Array(e);java.lang.System.arraycopy(a,0,f,0,a.length);a=f}a[g]=this.value(c);g++}c=this.next(c)}g!=e&&(d=new Float64Array(g),java.lang.System.arraycopy(a,0,d,0,g),a=d)}return a};a.prototype.contains=function(d,a){var c=!1;if(null!=this.keys)for(var e=b.mwg.utility.HashHelper.longHash(d,2*this.capacity),e=this.hash(e);0<=e&&!c;)d==this.key(e)&&a==this.value(e)&&(c=!0),e=this.next(e);return c};a.prototype.each=function(d){this.unsafe_each(d)};a.prototype.unsafe_each=function(d){for(var a=
0;a<this.mapSize;a++)d(this.key(a),this.value(a))};a.prototype.size=function(){return this.mapSize};a.prototype.remove=function(d,a){if(null!=this.keys&&0!=this.mapSize){for(var c=2*this.capacity,e=b.mwg.utility.HashHelper.longHash(d,c),g=this.hash(e),e=-1;0<=g;){if(d==this.key(g)&&a==this.value(g)){e=g;break}g=this.next(g)}if(-1!=e){var f=b.mwg.utility.HashHelper.longHash(d,c),g=this.hash(f);if(g==e)this.setHash(f,this.next(g));else for(;-1!=g;){var h=this.next(g);if(h==e){this.setNext(g,this.next(h));
break}g=h}f=this.mapSize-1;if(f!=e)if(g=this.key(f),this.setKey(e,g),this.setValue(e,this.value(f)),this.setNext(e,this.next(f)),c=b.mwg.utility.HashHelper.longHash(g,c),g=this.hash(c),g==f)this.setHash(c,e);else for(;-1!=g;){h=this.next(g);if(h==f){this.setNext(g,e);break}g=h}this.mapSize--;this.parent.declareDirty()}}};a.prototype.put=function(d,a){if(null==this.keys)this.reallocate(b.mwg.Constants.MAP_INITIAL_CAPACITY),this.setKey(0,d),this.setValue(0,a),this.setHash(b.mwg.utility.HashHelper.longHash(d,
2*this.capacity),0),this.setNext(0,-1),this.mapSize++,this.parent.declareDirty();else{for(var c=b.mwg.utility.HashHelper.longHash(d,2*this.capacity),e=c=this.hash(c),g=-1;0<=e;){if(d==this.key(e)&&a==this.value(e)){g=e;break}e=this.next(e)}-1==g&&(e=this.mapSize,e==this.capacity&&this.reallocate(2*this.capacity),this.setKey(e,d),this.setValue(e,a),this.setHash(b.mwg.utility.HashHelper.longHash(d,2*this.capacity),e),this.setNext(e,c),this.mapSize++,this.parent.declareDirty())}};return a}();e.HeapLongLongArrayMap=
c;c=function(){function a(d){this.capacity=this.mapSize=0;this.hashs=this.nexts=this.values=this.keys=null;this.parent=d}a.prototype.key=function(d){return this.keys[d]};a.prototype.setKey=function(d,a){this.keys[d]=a};a.prototype.value=function(d){return this.values[d]};a.prototype.setValue=function(d,a){this.values[d]=a};a.prototype.next=function(d){return this.nexts[d]};a.prototype.setNext=function(d,a){this.nexts[d]=a};a.prototype.hash=function(d){return this.hashs[d]};a.prototype.setHash=function(d,
a){this.hashs[d]=a};a.prototype.reallocate=function(d){if(d>this.capacity){var a=new Float64Array(d);null!=this.keys&&java.lang.System.arraycopy(this.keys,0,a,0,this.capacity);this.keys=a;a=new Float64Array(d);null!=this.values&&java.lang.System.arraycopy(this.values,0,a,0,this.capacity);this.values=a;var a=new Int32Array(d),c=new Int32Array(2*d);java.util.Arrays.fill(a,0,d,-1);java.util.Arrays.fill(c,0,2*d,-1);this.hashs=c;this.nexts=a;for(a=0;a<this.mapSize;a++)c=b.mwg.utility.HashHelper.longHash(this.key(a),
2*d),this.setNext(a,this.hash(c)),this.setHash(c,a);this.capacity=d}};a.prototype.cloneFor=function(d){d=new b.mwg.core.chunk.heap.HeapLongLongMap(d);d.mapSize=this.mapSize;d.capacity=this.capacity;if(null!=this.keys){var a=new Float64Array(this.capacity);java.lang.System.arraycopy(this.keys,0,a,0,this.capacity);d.keys=a}null!=this.values&&(a=new Float64Array(this.capacity),java.lang.System.arraycopy(this.values,0,a,0,this.capacity),d.values=a);null!=this.nexts&&(a=new Int32Array(this.capacity),java.lang.System.arraycopy(this.nexts,
0,a,0,this.capacity),d.nexts=a);null!=this.hashs&&(a=new Int32Array(2*this.capacity),java.lang.System.arraycopy(this.hashs,0,a,0,2*this.capacity),d.hashs=a);return d};a.prototype.get=function(d){var a=b.mwg.Constants.NULL_LONG;if(null!=this.keys)for(var c=b.mwg.utility.HashHelper.longHash(d,2*this.capacity),c=this.hash(c);0<=c;){if(d==this.key(c)){a=this.value(c);break}c=this.next(c)}return a};a.prototype.each=function(d){this.unsafe_each(d)};a.prototype.unsafe_each=function(d){for(var a=0;a<this.mapSize;a++)d(this.key(a),
this.value(a))};a.prototype.size=function(){return this.mapSize};a.prototype.remove=function(d){if(null!=this.keys&&0!=this.mapSize){for(var a=2*this.capacity,c=b.mwg.utility.HashHelper.longHash(d,a),e=this.hash(c),c=-1;0<=e;){if(d==this.key(e)){c=e;break}e=this.next(e)}if(-1!=c){d=b.mwg.utility.HashHelper.longHash(d,a);e=this.hash(d);if(e==c)this.setHash(d,this.next(e));else for(;-1!=e;){var g=this.next(e);if(g==c){this.setNext(e,this.next(g));break}e=g}d=this.mapSize-1;if(d!=c)if(e=this.key(d),
this.setKey(c,e),this.setValue(c,this.value(d)),this.setNext(c,this.next(d)),a=b.mwg.utility.HashHelper.longHash(e,a),e=this.hash(a),e==d)this.setHash(a,c);else for(;-1!=e;){g=this.next(e);if(g==d){this.setNext(e,c);break}e=g}this.mapSize--;this.parent.declareDirty()}}};a.prototype.put=function(d,a){if(null==this.keys)this.reallocate(b.mwg.Constants.MAP_INITIAL_CAPACITY),this.setKey(0,d),this.setValue(0,a),this.setHash(b.mwg.utility.HashHelper.longHash(d,2*this.capacity),0),this.setNext(0,-1),this.mapSize++;
else{for(var c=b.mwg.utility.HashHelper.longHash(d,2*this.capacity),e=c=this.hash(c),g=-1;0<=e;){if(d==this.key(e)){g=e;break}e=this.next(e)}-1==g?(e=this.mapSize,e==this.capacity&&this.reallocate(2*this.capacity),this.setKey(e,d),this.setValue(e,a),this.setHash(b.mwg.utility.HashHelper.longHash(d,2*this.capacity),e),this.setNext(e,c),this.mapSize++,this.parent.declareDirty()):this.value(g)!=a&&(this.setValue(g,a),this.parent.declareDirty())}};return a}();e.HeapLongLongMap=c;c=function(){function a(d,
a){this.aligned=!0;this.parent=d;null!=a?(this.aligned=!1,this._back=a._back,this._size=a._size):(this._back=null,this._size=0)}a.prototype.allocate=function(d){d=new Float64Array(d);null!=this._back&&java.lang.System.arraycopy(this._back,0,d,0,this._back.length);this._back=d};a.prototype.size=function(){return this._size};a.prototype.get=function(d){return this._back[d]};a.prototype.set=function(d,a){this._back[d]=a};a.prototype.unsafe_get=function(d){return this._back[d]};a.prototype.add=function(d){if(!this.aligned){var a=
new Float64Array(this._back.length);java.lang.System.arraycopy(this._back,0,a,0,this._back.length);this._back=a;this.aligned=!0}null==this._back?(this._back=new Float64Array(b.mwg.Constants.MAP_INITIAL_CAPACITY),this._back[0]=d,this._size=1):(this._size==this._back.length&&(a=new Float64Array(2*this._back.length),java.lang.System.arraycopy(this._back,0,a,0,this._size),this._back=a),this._back[this._size]=d,this._size++);this.parent.declareDirty();return this};a.prototype.remove=function(d){if(!this.aligned){var a=
new Float64Array(this._back.length);java.lang.System.arraycopy(this._back,0,a,0,this._back.length);this._back=a;this.aligned=!0}for(var a=-1,b=0;b<this._size;b++)if(this._back[b]==d){a=b;break}-1!=a&&(0==this._size-1?(this._back=null,this._size=0):(d=new Float64Array(this._size-1),java.lang.System.arraycopy(this._back,0,d,0,a),java.lang.System.arraycopy(this._back,a+1,d,a,this._size-a-1),this._back=d,this._size--));return this};a.prototype.clear=function(){this._size=0;this.aligned?null!=this._back&&
java.util.Arrays.fill(this._back,0,this._back.length,-1):(this._back=null,this.aligned=!0);return this};a.prototype.toString=function(){var d=new java.lang.StringBuilder;d.append("[");for(var a=0;a<this._size;a++)0!=a&&d.append(","),d.append(this._back[a]);d.append("]");return d.toString()};return a}();e.HeapRelationship=c;c=function(){function a(d,a){this._space=d;this._index=a;this._type=this._hash=this._next=null;this._capacity=this._size=0;this._dirty=!1}a.prototype.world=function(){return this._space.worldByIndex(this._index)};
a.prototype.time=function(){return this._space.timeByIndex(this._index)};a.prototype.id=function(){return this._space.idByIndex(this._index)};a.prototype.chunkType=function(){return b.mwg.chunk.ChunkType.STATE_CHUNK};a.prototype.index=function(){return this._index};a.prototype.get=function(d){return this.internal_get(d)};a.prototype.internal_find=function(d){if(0!=this._size)if(null==this._hash)for(var a=0;a<this._size;a++){if(this._k[a]==d)return a}else for(a=b.mwg.utility.HashHelper.longHash(d,
2*this._capacity),a=this._hash[a];0<=a;){if(d==this._k[a])return a;a=this._next[a]}return-1};a.prototype.internal_get=function(d){if(0==this._size)return null;var a=this.internal_find(d);if(-1!=a&&(d=this._v[a],null!=d))switch(this._type[a]){case b.mwg.Type.DOUBLE_ARRAY:return a=new Float64Array(d.length),java.lang.System.arraycopy(d,0,a,0,d.length),a;case b.mwg.Type.LONG_ARRAY:return a=new Float64Array(d.length),java.lang.System.arraycopy(d,0,a,0,d.length),a;case b.mwg.Type.INT_ARRAY:return a=new Int32Array(d.length),
java.lang.System.arraycopy(d,0,a,0,d.length),a;default:return d}return null};a.prototype.set=function(d,a,c){if(null!=c){if(a==b.mwg.Type.STRING&&"string"!==typeof c)throw Error("mwDB usage error, set method called with type "+b.mwg.Type.typeName(a)+" while param object is "+c);if(a==b.mwg.Type.BOOL&&"boolean"!==typeof c)throw Error("mwDB usage error, set method called with type "+b.mwg.Type.typeName(a)+" while param object is "+c);if((a==b.mwg.Type.DOUBLE||a==b.mwg.Type.LONG||a==b.mwg.Type.INT)&&
"number"!==typeof c)throw Error("mwDB usage error, set method called with type "+b.mwg.Type.typeName(a)+" while param object is "+c);if(a==b.mwg.Type.DOUBLE_ARRAY&&!(c instanceof Float64Array))throw Error("mwDB usage error, set method called with type "+b.mwg.Type.typeName(a)+" while param object is "+c);if(a==b.mwg.Type.LONG_ARRAY&&!(c instanceof Float64Array))throw Error("mwDB usage error, set method called with type "+b.mwg.Type.typeName(a)+" while param object is "+c);if(a==b.mwg.Type.INT_ARRAY&&
!(c instanceof Int32Array))throw Error("mwDB usage error, set method called with type "+b.mwg.Type.typeName(a)+" while param object is "+c);if(a==b.mwg.Type.STRING_TO_LONG_MAP&&"object"!==typeof c)throw Error("mwDB usage error, set method called with type "+b.mwg.Type.typeName(a)+" while param object is "+c);if(a==b.mwg.Type.LONG_TO_LONG_MAP&&"boolean"!==typeof c)throw Error("mwDB usage error, set method called with type "+b.mwg.Type.typeName(a)+" while param object is "+c);if(a==b.mwg.Type.LONG_TO_LONG_ARRAY_MAP&&
"boolean"!==typeof c)throw Error("mwDB usage error, set method called with type "+b.mwg.Type.typeName(a)+" while param object is "+c);}this.internal_set(d,a,c,!0,!1)};a.prototype.setFromKey=function(d,a,b){this.internal_set(this._space.graph().resolver().stringToHash(d,!0),a,b,!0,!1)};a.prototype.getFromKey=function(d){return this.internal_get(this._space.graph().resolver().stringToHash(d,!1))};a.prototype.getFromKeyWithDefault=function(d,a){var b=this.getFromKey(d);return null==b?a:b};a.prototype.getWithDefault=
function(d,a){var b=this.get(d);return null==b?a:b};a.prototype.getType=function(d){if(0==this._size)return-1;if(null==this._hash)for(var a=0;a<this._capacity;a++){if(this._k[a]==d)return this._type[a]}else for(a=b.mwg.utility.HashHelper.longHash(d,2*this._capacity),a=this._hash[a];0<=a;){if(d==this._k[a])return this._type[a];a=this._next[a]}return-1};a.prototype.getTypeFromKey=function(d){return this.getType(this._space.graph().resolver().stringToHash(d,!1))};a.prototype.getOrCreate=function(d,a){var c=
this.internal_find(d);if(-1!=c&&this._type[c]==a)return this._v[c];c=null;switch(a){case b.mwg.Type.RELATION:c=new b.mwg.core.chunk.heap.HeapRelationship(this,null);break;case b.mwg.Type.STRING_TO_LONG_MAP:c=new b.mwg.core.chunk.heap.HeapStringLongMap(this);break;case b.mwg.Type.LONG_TO_LONG_MAP:c=new b.mwg.core.chunk.heap.HeapLongLongMap(this);break;case b.mwg.Type.LONG_TO_LONG_ARRAY_MAP:c=new b.mwg.core.chunk.heap.HeapLongLongArrayMap(this)}this.internal_set(d,a,c,!0,!1);return c};a.prototype.getOrCreateFromKey=
function(d,a){return this.getOrCreate(this._space.graph().resolver().stringToHash(d,!0),a)};a.prototype.declareDirty=function(){null==this._space||this._dirty||(this._dirty=!0,this._space.notifyUpdate(this._index))};a.prototype.save=function(d){b.mwg.utility.Base64.encodeIntToBuffer(this._size,d);for(var a=0;a<this._size;a++)if(null!=this._v[a]){var c=this._v[a];if(null!=c)switch(d.write(b.mwg.core.CoreConstants.CHUNK_SEP),b.mwg.utility.Base64.encodeLongToBuffer(this._k[a],d),d.write(b.mwg.core.CoreConstants.CHUNK_SUB_SEP),
b.mwg.utility.Base64.encodeIntToBuffer(this._type[a],d),d.write(b.mwg.core.CoreConstants.CHUNK_SUB_SEP),this._type[a]){case b.mwg.Type.STRING:b.mwg.utility.Base64.encodeStringToBuffer(c,d);break;case b.mwg.Type.BOOL:this._v[a]?d.write(b.mwg.core.CoreConstants.BOOL_TRUE):d.write(b.mwg.core.CoreConstants.BOOL_FALSE);break;case b.mwg.Type.LONG:b.mwg.utility.Base64.encodeLongToBuffer(c,d);break;case b.mwg.Type.DOUBLE:b.mwg.utility.Base64.encodeDoubleToBuffer(c,d);break;case b.mwg.Type.INT:b.mwg.utility.Base64.encodeIntToBuffer(c,
d);break;case b.mwg.Type.DOUBLE_ARRAY:var e=c;b.mwg.utility.Base64.encodeIntToBuffer(e.length,d);for(c=0;c<e.length;c++)d.write(b.mwg.core.CoreConstants.CHUNK_SUB_SUB_SEP),b.mwg.utility.Base64.encodeDoubleToBuffer(e[c],d);break;case b.mwg.Type.RELATION:e=c;b.mwg.utility.Base64.encodeIntToBuffer(e.size(),d);for(c=0;c<e.size();c++)d.write(b.mwg.core.CoreConstants.CHUNK_SUB_SUB_SEP),b.mwg.utility.Base64.encodeLongToBuffer(e.unsafe_get(c),d);break;case b.mwg.Type.LONG_ARRAY:e=c;b.mwg.utility.Base64.encodeIntToBuffer(e.length,
d);for(c=0;c<e.length;c++)d.write(b.mwg.core.CoreConstants.CHUNK_SUB_SUB_SEP),b.mwg.utility.Base64.encodeLongToBuffer(e[c],d);break;case b.mwg.Type.INT_ARRAY:e=c;b.mwg.utility.Base64.encodeIntToBuffer(e.length,d);for(c=0;c<e.length;c++)d.write(b.mwg.core.CoreConstants.CHUNK_SUB_SUB_SEP),b.mwg.utility.Base64.encodeIntToBuffer(e[c],d);break;case b.mwg.Type.STRING_TO_LONG_MAP:b.mwg.utility.Base64.encodeLongToBuffer(c.size(),d);c.unsafe_each(function(a,k){d.write(b.mwg.core.CoreConstants.CHUNK_SUB_SUB_SEP);
b.mwg.utility.Base64.encodeStringToBuffer(a,d);d.write(b.mwg.core.CoreConstants.CHUNK_SUB_SUB_SUB_SEP);b.mwg.utility.Base64.encodeLongToBuffer(k,d)});break;case b.mwg.Type.LONG_TO_LONG_MAP:b.mwg.utility.Base64.encodeLongToBuffer(c.size(),d);c.unsafe_each(function(a,k){d.write(b.mwg.core.CoreConstants.CHUNK_SUB_SUB_SEP);b.mwg.utility.Base64.encodeLongToBuffer(a,d);d.write(b.mwg.core.CoreConstants.CHUNK_SUB_SUB_SUB_SEP);b.mwg.utility.Base64.encodeLongToBuffer(k,d)});break;case b.mwg.Type.LONG_TO_LONG_ARRAY_MAP:b.mwg.utility.Base64.encodeLongToBuffer(c.size(),
d),c.unsafe_each(function(a,k){d.write(b.mwg.core.CoreConstants.CHUNK_SUB_SUB_SEP);b.mwg.utility.Base64.encodeLongToBuffer(a,d);d.write(b.mwg.core.CoreConstants.CHUNK_SUB_SUB_SUB_SEP);b.mwg.utility.Base64.encodeLongToBuffer(k,d)})}}this._dirty=!1};a.prototype.each=function(d){for(var a=0;a<this._size;a++)null!=this._v[a]&&d(this._k[a],this._type[a],this._v[a])};a.prototype.loadFrom=function(d){if(null!=d){this._capacity=d._capacity;this._size=d._size;if(null!=d._k){var a=new Float64Array(this._capacity);
java.lang.System.arraycopy(d._k,0,a,0,this._capacity);this._k=a}null!=d._type&&(a=new Int8Array(this._capacity),java.lang.System.arraycopy(d._type,0,a,0,this._capacity),this._type=a);null!=d._next&&(a=new Int32Array(this._capacity),java.lang.System.arraycopy(d._next,0,a,0,this._capacity),this._next=a);null!=d._hash&&(a=new Int32Array(2*this._capacity),java.lang.System.arraycopy(d._hash,0,a,0,2*this._capacity),this._hash=a);if(null!=d._v)for(this._v=Array(this._capacity),a=0;a<this._size;a++)switch(d._type[a]){case b.mwg.Type.LONG_TO_LONG_MAP:null!=
d._v[a]&&(this._v[a]=d._v[a].cloneFor(this));break;case b.mwg.Type.LONG_TO_LONG_ARRAY_MAP:null!=d._v[a]&&(this._v[a]=d._v[a].cloneFor(this));break;case b.mwg.Type.STRING_TO_LONG_MAP:null!=d._v[a]&&(this._v[a]=d._v[a].cloneFor(this));break;case b.mwg.Type.RELATION:null!=d._v[a]&&(this._v[a]=new b.mwg.core.chunk.heap.HeapRelationship(this,d._v[a]));break;default:this._v[a]=d._v[a]}}};a.prototype.internal_set=function(d,a,c,e,f){var l=null;if(null!=c)try{switch(a){case b.mwg.Type.BOOL:l=c;break;case b.mwg.Type.DOUBLE:l=
c;break;case b.mwg.Type.LONG:l=c;break;case b.mwg.Type.INT:l=c;break;case b.mwg.Type.STRING:l=c;break;case b.mwg.Type.RELATION:l=c;break;case b.mwg.Type.DOUBLE_ARRAY:var h=new Float64Array(c.length);java.lang.System.arraycopy(c,0,h,0,c.length);l=h;break;case b.mwg.Type.LONG_ARRAY:var n=new Float64Array(c.length);java.lang.System.arraycopy(c,0,n,0,c.length);l=n;break;case b.mwg.Type.INT_ARRAY:var p=new Int32Array(c.length);java.lang.System.arraycopy(c,0,p,0,c.length);l=p;break;case b.mwg.Type.STRING_TO_LONG_MAP:l=
c;break;case b.mwg.Type.LONG_TO_LONG_MAP:l=c;break;case b.mwg.Type.LONG_TO_LONG_ARRAY_MAP:l=c;break;default:throw Error("Internal Exception, unknown type");}}catch(u){if(u instanceof Error)throw Error("mwDB usage error, set method called with type "+b.mwg.Type.typeName(a)+" while param object is "+c);throw u;}if(null==this._k)null!=l&&(this._capacity=b.mwg.Constants.MAP_INITIAL_CAPACITY,this._k=new Float64Array(this._capacity),this._v=Array(this._capacity),this._type=new Int8Array(this._capacity),
this._k[0]=d,this._v[0]=l,this._type[0]=a,this._size=1);else{p=n=c=-1;if(null==this._hash)for(h=0;h<this._size;h++){if(this._k[h]==d){c=h;break}}else for(p=b.mwg.utility.HashHelper.longHash(d,2*this._capacity),h=this._hash[p];-1!=h;){if(this._k[h]==d){c=h;break}n=h;h=this._next[h]}if(-1!=c){if(e||a!=this._type[c])if(null==l){null!=this._hash&&(-1!=n?this._next[n]=this._next[c]:this._hash[p]=-1);d=this._size-1;if(c==d)this._k[c]=-1,this._v[c]=null,this._type[c]=-1;else if(this._k[c]=this._k[d],this._v[c]=
this._v[d],this._type[c]=this._type[d],null!=this._hash)if(this._next[c]=this._next[d],a=b.mwg.utility.HashHelper.longHash(this._k[c],2*this._capacity),h=this._hash[a],h==d)this._hash[a]=c;else for(;-1!=h;){if(this._next[h]==d){this._next[h]=c;break}h=this._next[h]}this._size--}else this._v[c]=l,this._type[c]!=a&&(this._type[c]=a);f||this.declareDirty()}else if(this._size<this._capacity)this._k[this._size]=d,this._v[this._size]=l,this._type[this._size]=a,null!=this._hash&&(this._next[this._size]=
this._hash[p],this._hash[p]=this._size),this._size++,this.declareDirty();else{e=2*this._capacity;c=new Float64Array(e);java.lang.System.arraycopy(this._k,0,c,0,this._capacity);this._k=c;c=Array(e);java.lang.System.arraycopy(this._v,0,c,0,this._capacity);this._v=c;c=new Int8Array(e);java.lang.System.arraycopy(this._type,0,c,0,this._capacity);this._type=c;this._capacity=e;this._k[this._size]=d;this._v[this._size]=l;this._type[this._size]=a;this._size++;this._hash=new Int32Array(2*this._capacity);java.util.Arrays.fill(this._hash,
0,2*this._capacity,-1);this._next=new Int32Array(this._capacity);java.util.Arrays.fill(this._next,0,this._capacity,-1);for(h=0;h<this._size;h++)d=b.mwg.utility.HashHelper.longHash(this._k[h],2*this._capacity),this._next[h]=this._hash[d],this._hash[d]=h;f||this.declareDirty()}}};a.prototype.allocate=function(d){if(!(d<=this._capacity)){var a=new Float64Array(d);null!=this._k&&java.lang.System.arraycopy(this._k,0,a,0,this._capacity);this._k=a;a=Array(d);null!=this._v&&java.lang.System.arraycopy(this._v,
0,a,0,this._capacity);this._v=a;a=new Int8Array(d);null!=this._type&&java.lang.System.arraycopy(this._type,0,a,0,this._capacity);this._type=a;this._capacity=d;this._hash=new Int32Array(2*this._capacity);java.util.Arrays.fill(this._hash,0,2*this._capacity,-1);this._next=new Int32Array(this._capacity);java.util.Arrays.fill(this._next,0,this._capacity,-1);for(d=0;d<this._size;d++)a=b.mwg.utility.HashHelper.longHash(this._k[d],2*this._capacity),this._next[d]=this._hash[a],this._hash[a]=d}};a.prototype.load=
function(d){if(null!=d&&0!=d.length()){for(var a=null==this._k,c=0,e=d.length(),f=-1,l=b.mwg.core.CoreConstants.NULL_LONG,h=-1,n=!0,p=null,u=null,q=null,t=null,x=null,z=null,D=null,v=-1,A=0,w=b.mwg.core.CoreConstants.NULL_LONG,C=null;c<e;){var F=d.read(c);if(F==b.mwg.core.CoreConstants.CHUNK_SEP)if(n)n=!1,f=b.mwg.utility.Base64.decodeToIntWithBounds(d,0,c),this.allocate(Math.pow(2,Math.ceil(Math.log(f)/Math.log(2)))),f=c+1;else{if(-1!=h){v=null;switch(h){case b.mwg.Type.BOOL:d.read(f)==b.mwg.core.CoreConstants.BOOL_FALSE?
v=!1:d.read(f)==b.mwg.core.CoreConstants.BOOL_TRUE&&(v=!0);break;case b.mwg.Type.STRING:v=b.mwg.utility.Base64.decodeToStringWithBounds(d,f,c);break;case b.mwg.Type.DOUBLE:v=b.mwg.utility.Base64.decodeToDoubleWithBounds(d,f,c);break;case b.mwg.Type.LONG:v=b.mwg.utility.Base64.decodeToLongWithBounds(d,f,c);break;case b.mwg.Type.INT:v=b.mwg.utility.Base64.decodeToIntWithBounds(d,f,c);break;case b.mwg.Type.DOUBLE_ARRAY:null==p?p=new Float64Array(b.mwg.utility.Base64.decodeToIntWithBounds(d,f,c)):p[A]=
b.mwg.utility.Base64.decodeToDoubleWithBounds(d,f,c);v=p;break;case b.mwg.Type.LONG_ARRAY:null==u?u=new Float64Array(b.mwg.utility.Base64.decodeToIntWithBounds(d,f,c)):u[A]=b.mwg.utility.Base64.decodeToLongWithBounds(d,f,c);v=u;break;case b.mwg.Type.INT_ARRAY:null==q?q=new Int32Array(b.mwg.utility.Base64.decodeToIntWithBounds(d,f,c)):q[A]=b.mwg.utility.Base64.decodeToIntWithBounds(d,f,c);v=q;break;case b.mwg.Type.RELATION:null==t?(t=new b.mwg.core.chunk.heap.HeapRelationship(this,null),t.allocate(b.mwg.utility.Base64.decodeToIntWithBounds(d,
f,c))):t.add(b.mwg.utility.Base64.decodeToLongWithBounds(d,f,c));v=t;break;case b.mwg.Type.STRING_TO_LONG_MAP:null!=C&&x.put(C,b.mwg.utility.Base64.decodeToLongWithBounds(d,f,c));v=x;break;case b.mwg.Type.LONG_TO_LONG_MAP:w!=b.mwg.core.CoreConstants.NULL_LONG&&z.put(w,b.mwg.utility.Base64.decodeToLongWithBounds(d,f,c));v=z;break;case b.mwg.Type.LONG_TO_LONG_ARRAY_MAP:w!=b.mwg.core.CoreConstants.NULL_LONG&&D.put(w,b.mwg.utility.Base64.decodeToLongWithBounds(d,f,c)),v=D}null!=v&&this.internal_set(l,
h,v,!0,a)}f=c+1;l=b.mwg.core.CoreConstants.NULL_LONG;v=h=-1;A=0;w=b.mwg.core.CoreConstants.NULL_LONG;C=null}else if(F==b.mwg.core.CoreConstants.CHUNK_SUB_SEP)l==b.mwg.core.CoreConstants.NULL_LONG?(l=b.mwg.utility.Base64.decodeToLongWithBounds(d,f,c),f=c+1):-1==h&&(h=b.mwg.utility.Base64.decodeToIntWithBounds(d,f,c),f=c+1);else if(F==b.mwg.core.CoreConstants.CHUNK_SUB_SUB_SEP){if(-1==v)switch(v=b.mwg.utility.Base64.decodeToLongWithBounds(d,f,c),h){case b.mwg.Type.DOUBLE_ARRAY:p=new Float64Array(v);
break;case b.mwg.Type.LONG_ARRAY:u=new Float64Array(v);break;case b.mwg.Type.INT_ARRAY:q=new Int32Array(v);break;case b.mwg.Type.RELATION:t=new b.mwg.core.chunk.heap.HeapRelationship(this,null);t.allocate(v);break;case b.mwg.Type.STRING_TO_LONG_MAP:x=new b.mwg.core.chunk.heap.HeapStringLongMap(this);x.reallocate(v);break;case b.mwg.Type.LONG_TO_LONG_MAP:z=new b.mwg.core.chunk.heap.HeapLongLongMap(this);z.reallocate(v);break;case b.mwg.Type.LONG_TO_LONG_ARRAY_MAP:D=new b.mwg.core.chunk.heap.HeapLongLongArrayMap(this),
D.reallocate(v)}else switch(h){case b.mwg.Type.DOUBLE_ARRAY:p[A]=b.mwg.utility.Base64.decodeToDoubleWithBounds(d,f,c);A++;break;case b.mwg.Type.RELATION:t.add(b.mwg.utility.Base64.decodeToLongWithBounds(d,f,c));break;case b.mwg.Type.LONG_ARRAY:u[A]=b.mwg.utility.Base64.decodeToLongWithBounds(d,f,c);A++;break;case b.mwg.Type.INT_ARRAY:q[A]=b.mwg.utility.Base64.decodeToIntWithBounds(d,f,c);A++;break;case b.mwg.Type.STRING_TO_LONG_MAP:null!=C&&(x.put(C,b.mwg.utility.Base64.decodeToLongWithBounds(d,f,
c)),C=null);break;case b.mwg.Type.LONG_TO_LONG_MAP:w!=b.mwg.core.CoreConstants.NULL_LONG&&(z.put(w,b.mwg.utility.Base64.decodeToLongWithBounds(d,f,c)),w=b.mwg.core.CoreConstants.NULL_LONG);break;case b.mwg.Type.LONG_TO_LONG_ARRAY_MAP:w!=b.mwg.core.CoreConstants.NULL_LONG&&(D.put(w,b.mwg.utility.Base64.decodeToLongWithBounds(d,f,c)),w=b.mwg.core.CoreConstants.NULL_LONG)}f=c+1}else if(F==b.mwg.core.CoreConstants.CHUNK_SUB_SUB_SUB_SEP){switch(h){case b.mwg.Type.STRING_TO_LONG_MAP:null==C?C=b.mwg.utility.Base64.decodeToStringWithBounds(d,
f,c):(x.put(C,b.mwg.utility.Base64.decodeToLongWithBounds(d,f,c)),C=null);break;case b.mwg.Type.LONG_TO_LONG_MAP:w==b.mwg.core.CoreConstants.NULL_LONG?w=b.mwg.utility.Base64.decodeToLongWithBounds(d,f,c):(z.put(w,b.mwg.utility.Base64.decodeToLongWithBounds(d,f,c)),w=b.mwg.core.CoreConstants.NULL_LONG);break;case b.mwg.Type.LONG_TO_LONG_ARRAY_MAP:w==b.mwg.core.CoreConstants.NULL_LONG?w=b.mwg.utility.Base64.decodeToLongWithBounds(d,f,c):(D.put(w,b.mwg.utility.Base64.decodeToLongWithBounds(d,f,c)),w=
b.mwg.core.CoreConstants.NULL_LONG)}f=c+1}c++}if(-1!=h){v=null;switch(h){case b.mwg.Type.BOOL:d.read(f)==b.mwg.core.CoreConstants.BOOL_FALSE?v=!1:d.read(f)==b.mwg.core.CoreConstants.BOOL_TRUE&&(v=!0);break;case b.mwg.Type.STRING:v=b.mwg.utility.Base64.decodeToStringWithBounds(d,f,c);break;case b.mwg.Type.DOUBLE:v=b.mwg.utility.Base64.decodeToDoubleWithBounds(d,f,c);break;case b.mwg.Type.LONG:v=b.mwg.utility.Base64.decodeToLongWithBounds(d,f,c);break;case b.mwg.Type.INT:v=b.mwg.utility.Base64.decodeToIntWithBounds(d,
f,c);break;case b.mwg.Type.DOUBLE_ARRAY:null==p?p=new Float64Array(b.mwg.utility.Base64.decodeToIntWithBounds(d,f,c)):p[A]=b.mwg.utility.Base64.decodeToDoubleWithBounds(d,f,c);v=p;break;case b.mwg.Type.LONG_ARRAY:null==u?u=new Float64Array(b.mwg.utility.Base64.decodeToIntWithBounds(d,f,c)):u[A]=b.mwg.utility.Base64.decodeToLongWithBounds(d,f,c);v=u;break;case b.mwg.Type.INT_ARRAY:null==q?q=new Int32Array(b.mwg.utility.Base64.decodeToIntWithBounds(d,f,c)):q[A]=b.mwg.utility.Base64.decodeToIntWithBounds(d,
f,c);v=q;break;case b.mwg.Type.RELATION:null!=t&&t.add(b.mwg.utility.Base64.decodeToIntWithBounds(d,f,c));v=t;break;case b.mwg.Type.STRING_TO_LONG_MAP:null!=C&&x.put(C,b.mwg.utility.Base64.decodeToLongWithBounds(d,f,c));v=x;break;case b.mwg.Type.LONG_TO_LONG_MAP:w!=b.mwg.core.CoreConstants.NULL_LONG&&z.put(w,b.mwg.utility.Base64.decodeToLongWithBounds(d,f,c));v=z;break;case b.mwg.Type.LONG_TO_LONG_ARRAY_MAP:w!=b.mwg.core.CoreConstants.NULL_LONG&&D.put(w,b.mwg.utility.Base64.decodeToLongWithBounds(d,
f,c)),v=D}null!=v&&this.internal_set(l,h,v,!0,a)}}};return a}();e.HeapStateChunk=c;c=function(){function a(d){this.capacity=this.mapSize=0;this.hashs=this.nexts=this.values=this.keysH=this.keys=null;this.parent=d}a.prototype.key=function(d){return this.keys[d]};a.prototype.setKey=function(d,a){this.keys[d]=a};a.prototype.keyH=function(d){return this.keysH[d]};a.prototype.setKeyH=function(d,a){this.keysH[d]=a};a.prototype.value=function(d){return this.values[d]};a.prototype.setValue=function(d,a){this.values[d]=
a};a.prototype.next=function(d){return this.nexts[d]};a.prototype.setNext=function(d,a){this.nexts[d]=a};a.prototype.hash=function(d){return this.hashs[d]};a.prototype.setHash=function(d,a){this.hashs[d]=a};a.prototype.reallocate=function(d){if(d>this.capacity){var a=Array(d);null!=this.keys&&java.lang.System.arraycopy(this.keys,0,a,0,this.capacity);this.keys=a;a=new Float64Array(d);null!=this.keysH&&java.lang.System.arraycopy(this.keysH,0,a,0,this.capacity);this.keysH=a;a=new Float64Array(d);null!=
this.values&&java.lang.System.arraycopy(this.values,0,a,0,this.capacity);this.values=a;var a=new Int32Array(d),c=new Int32Array(2*d);java.util.Arrays.fill(a,0,d,-1);java.util.Arrays.fill(c,0,2*d,-1);this.hashs=c;this.nexts=a;for(a=0;a<this.mapSize;a++)c=b.mwg.utility.HashHelper.longHash(this.keyH(a),2*d),this.setNext(a,this.hash(c)),this.setHash(c,a);this.capacity=d}};a.prototype.cloneFor=function(d){d=new b.mwg.core.chunk.heap.HeapStringLongMap(d);d.mapSize=this.mapSize;d.capacity=this.capacity;
if(null!=this.keys){var a=Array(this.capacity);java.lang.System.arraycopy(this.keys,0,a,0,this.capacity);d.keys=a}null!=this.keysH&&(a=new Float64Array(this.capacity),java.lang.System.arraycopy(this.keysH,0,a,0,this.capacity),d.keysH=a);null!=this.values&&(a=new Float64Array(this.capacity),java.lang.System.arraycopy(this.values,0,a,0,this.capacity),d.values=a);null!=this.nexts&&(a=new Int32Array(this.capacity),java.lang.System.arraycopy(this.nexts,0,a,0,this.capacity),d.nexts=a);null!=this.hashs&&
(a=new Int32Array(2*this.capacity),java.lang.System.arraycopy(this.hashs,0,a,0,2*this.capacity),d.hashs=a);return d};a.prototype.getValue=function(d){var a=b.mwg.Constants.NULL_LONG;if(null!=this.keys){d=b.mwg.utility.HashHelper.hash(d);for(var c=b.mwg.utility.HashHelper.longHash(d,2*this.capacity),c=this.hash(c);0<=c;){if(d==this.keyH(c)){a=this.value(c);break}c=this.next(c)}}return a};a.prototype.getByHash=function(d){var a=null;if(null!=this.keys)for(var c=b.mwg.utility.HashHelper.longHash(d,2*
this.capacity),c=this.hash(c);0<=c;){if(d==this.keyH(c)){a=this.key(c);break}c=this.next(c)}return a};a.prototype.containsHash=function(d){var a=!1;if(null!=this.keys)for(var c=b.mwg.utility.HashHelper.longHash(d,2*this.capacity),c=this.hash(c);0<=c;){if(d==this.keyH(c)){a=!0;break}c=this.next(c)}return a};a.prototype.each=function(d){this.unsafe_each(d)};a.prototype.unsafe_each=function(d){for(var a=0;a<this.mapSize;a++)d(this.key(a),this.value(a))};a.prototype.size=function(){return this.mapSize};
a.prototype.remove=function(d){if(null!=this.keys&&0!=this.mapSize){for(var a=b.mwg.utility.HashHelper.hash(d),c=2*this.capacity,e=b.mwg.utility.HashHelper.longHash(a,c),f=this.hash(e),e=-1;0<=f;){if(d==this.key(f)){e=f;break}f=this.next(f)}if(-1!=e){d=b.mwg.utility.HashHelper.longHash(a,c);f=this.hash(d);if(f==e)this.setHash(d,this.next(f));else for(;-1!=f;){a=this.next(f);if(a==e){this.setNext(f,this.next(a));break}f=a}d=this.mapSize-1;if(d!=e)if(f=this.key(d),a=this.keyH(d),this.setKey(e,f),this.setKeyH(e,
a),this.setValue(e,this.value(d)),this.setNext(e,this.next(d)),c=b.mwg.utility.HashHelper.longHash(a,c),f=this.hash(c),f==d)this.setHash(c,e);else for(;-1!=f;){a=this.next(f);if(a==d){this.setNext(f,e);break}f=a}this.mapSize--;this.parent.declareDirty()}}};a.prototype.put=function(d,a){var c=b.mwg.utility.HashHelper.hash(d);if(null==this.keys)this.reallocate(b.mwg.Constants.MAP_INITIAL_CAPACITY),this.setKey(0,d),this.setKeyH(0,c),this.setValue(0,a),this.setHash(b.mwg.utility.HashHelper.longHash(c,
2*this.capacity),0),this.setNext(0,-1),this.mapSize++;else{for(var e=b.mwg.utility.HashHelper.longHash(c,2*this.capacity),f=e=this.hash(e),l=-1;0<=f;){if(d==this.key(f)){l=f;break}f=this.next(f)}-1==l?(f=this.mapSize,f==this.capacity&&this.reallocate(2*this.capacity),this.setKey(f,d),this.setKeyH(f,c),this.setValue(f,a),this.setHash(b.mwg.utility.HashHelper.longHash(c,2*this.capacity),f),this.setNext(f,e),this.mapSize++,this.parent.declareDirty()):this.value(l)!=a&&(this.setValue(l,a),this.parent.declareDirty())}};
return a}();e.HeapStringLongMap=c;c=function(){function a(d,a){this._root=-1;this._size=0;this._space=d;this._index=a;this._magic=0;this._dirty=!1}a.prototype.world=function(){return this._space.worldByIndex(this._index)};a.prototype.time=function(){return this._space.timeByIndex(this._index)};a.prototype.id=function(){return this._space.idByIndex(this._index)};a.prototype.size=function(){return this._size};a.prototype.range=function(d,a,b,c){var e=0;for(a=this.internal_previousOrEqual_index(a);-1!=
a&&this.key(a)>=d&&e<b;)c(this.key(a)),e++,a=this.previous(a)};a.prototype.save=function(d){b.mwg.utility.Base64.encodeLongToBuffer(this._size,d);d.write(b.mwg.core.CoreConstants.CHUNK_SEP);for(var a=!0,c=0;c<this._size;c++)a?a=!1:d.write(b.mwg.core.CoreConstants.CHUNK_SUB_SEP),b.mwg.utility.Base64.encodeLongToBuffer(this._k[c],d);this._dirty=!1};a.prototype.load=function(d){if(null!=d&&0!=d.length()){for(var a=null==this._k,c=!1,e=0,f=0,l=d.length();e<l;){var h=d.read(e);h==b.mwg.core.CoreConstants.CHUNK_SUB_SEP?
(f=this.internal_insert(b.mwg.utility.Base64.decodeToLongWithBounds(d,f,e)),c=c||f,f=e+1):h==b.mwg.core.CoreConstants.CHUNK_SEP&&(this.reallocate(b.mwg.utility.Base64.decodeToLongWithBounds(d,f,e)),f=e+1);e++}d=this.internal_insert(b.mwg.utility.Base64.decodeToLongWithBounds(d,f,e));!c&&!d||a||this._dirty||(this._dirty=!0,null!=this._space&&this._space.notifyUpdate(this._index))}};a.prototype.index=function(){return this._index};a.prototype.previousOrEqual=function(d){d=this.internal_previousOrEqual_index(d);
return-1!=d?this.key(d):b.mwg.core.CoreConstants.NULL_LONG};a.prototype.magic=function(){return this._magic};a.prototype.insert=function(d){this.internal_insert(d)&&this.internal_set_dirty()};a.prototype.unsafe_insert=function(d){this.internal_insert(d)};a.prototype.chunkType=function(){return b.mwg.chunk.ChunkType.TIME_TREE_CHUNK};a.prototype.clearAt=function(d){var c=this._k;this._k=new Float64Array(this._k.length);this._back_meta=new Int32Array(this._k.length*a.META_SIZE);this._colors=[];this._root=
-1;for(var e=this._size,f=this._size=0;f<e;f++)c[f]!=b.mwg.core.CoreConstants.NULL_LONG&&c[f]<d&&this.internal_insert(c[f]);this.internal_set_dirty()};a.prototype.reallocate=function(d){var b=new Float64Array(d);null!=this._k&&java.lang.System.arraycopy(this._k,0,b,0,this._size);var c=[];if(null!=this._colors){java.lang.System.arraycopy(this._colors,0,c,0,this._size);for(var e=this._size;e<d;e++)c[e]=!1}var f=new Int32Array(d*a.META_SIZE);if(null!=this._back_meta)for(java.lang.System.arraycopy(this._back_meta,
0,f,0,this._size*a.META_SIZE),e=this._size*a.META_SIZE;e<d*a.META_SIZE;e++)f[e]=-1;this._back_meta=f;this._k=b;this._colors=c};a.prototype.key=function(d){return-1==d?-1:this._k[d]};a.prototype.setKey=function(d,a){this._k[d]=a};a.prototype.left=function(d){return-1==d?-1:this._back_meta[d*a.META_SIZE]};a.prototype.setLeft=function(d,b){this._back_meta[d*a.META_SIZE]=b};a.prototype.right=function(d){return-1==d?-1:this._back_meta[d*a.META_SIZE+1]};a.prototype.setRight=function(d,b){this._back_meta[d*
a.META_SIZE+1]=b};a.prototype.parent=function(d){return-1==d?-1:this._back_meta[d*a.META_SIZE+2]};a.prototype.setParent=function(d,b){this._back_meta[d*a.META_SIZE+2]=b};a.prototype.color=function(d){return-1==d?!0:this._colors[d]};a.prototype.setColor=function(d,a){this._colors[d]=a};a.prototype.grandParent=function(d){return-1==d?-1:-1!=this.parent(d)?this.parent(this.parent(d)):-1};a.prototype.sibling=function(d){return-1==this.parent(d)?-1:d==this.left(this.parent(d))?this.right(this.parent(d)):
this.left(this.parent(d))};a.prototype.uncle=function(d){return-1!=this.parent(d)?this.sibling(this.parent(d)):-1};a.prototype.previous=function(d){if(-1!=this.left(d)){for(d=this.left(d);-1!=this.right(d);)d=this.right(d);return d}if(-1!=this.parent(d)){if(d!=this.right(this.parent(d)))for(;-1!=this.parent(d)&&d==this.left(this.parent(d));)d=this.parent(d);return this.parent(d)}return-1};a.prototype.internal_previousOrEqual_index=function(d){var a=this._root;if(-1==a)return a;for(;-1!=a;){if(d==
this.key(a))return a;if(d>this.key(a))if(-1!=this.right(a))a=this.right(a);else return a;else if(-1!=this.left(a))a=this.left(a);else{for(d=this.parent(a);-1!=d&&a==this.left(d);)a=d,d=this.parent(d);return d}}return-1};a.prototype.rotateLeft=function(a){var b=this.right(a);this.replaceNode(a,b);this.setRight(a,this.left(b));-1!=this.left(b)&&this.setParent(this.left(b),a);this.setLeft(b,a);this.setParent(a,b)};a.prototype.rotateRight=function(a){var b=this.left(a);this.replaceNode(a,b);this.setLeft(a,
this.right(b));-1!=this.right(b)&&this.setParent(this.right(b),a);this.setRight(b,a);this.setParent(a,b)};a.prototype.replaceNode=function(a,b){-1==this.parent(a)?this._root=b:a==this.left(this.parent(a))?this.setLeft(this.parent(a),b):this.setRight(this.parent(a),b);-1!=b&&this.setParent(b,this.parent(a))};a.prototype.insertCase1=function(a){-1==this.parent(a)?this.setColor(a,!0):this.insertCase2(a)};a.prototype.insertCase2=function(a){this.color(this.parent(a))||this.insertCase3(a)};a.prototype.insertCase3=
function(a){this.color(this.uncle(a))?this.insertCase4(a):(this.setColor(this.parent(a),!0),this.setColor(this.uncle(a),!0),this.setColor(this.grandParent(a),!1),this.insertCase1(this.grandParent(a)))};a.prototype.insertCase4=function(a){a==this.right(this.parent(a))&&this.parent(a)==this.left(this.grandParent(a))?(this.rotateLeft(this.parent(a)),a=this.left(a)):a==this.left(this.parent(a))&&this.parent(a)==this.right(this.grandParent(a))&&(this.rotateRight(this.parent(a)),a=this.right(a));this.insertCase5(a)};
a.prototype.insertCase5=function(a){this.setColor(this.parent(a),!0);this.setColor(this.grandParent(a),!1);a==this.left(this.parent(a))&&this.parent(a)==this.left(this.grandParent(a))?this.rotateRight(this.grandParent(a)):this.rotateLeft(this.grandParent(a))};a.prototype.internal_insert=function(a){if(null==this._k||this._k.length==this._size){var c=this._size,c=0==c?b.mwg.Constants.MAP_INITIAL_CAPACITY:2*c;this.reallocate(c)}c=this._size;if(0==c)this.setKey(c,a),this.setColor(c,!1),this.setLeft(c,
-1),this.setRight(c,-1),this.setParent(c,-1),this._root=c,this._size=1;else{for(var e=this._root;;){if(a==this.key(e))return!1;if(a<this.key(e))if(-1==this.left(e)){this.setKey(c,a);this.setColor(c,!1);this.setLeft(c,-1);this.setRight(c,-1);this.setParent(c,-1);this.setLeft(e,c);this._size++;break}else e=this.left(e);else if(-1==this.right(e)){this.setKey(c,a);this.setColor(c,!1);this.setLeft(c,-1);this.setRight(c,-1);this.setParent(c,-1);this.setRight(e,c);this._size++;break}else e=this.right(e)}this.setParent(c,
e)}this.insertCase1(c);return!0};a.prototype.internal_set_dirty=function(){this._magic+=1;null==this._space||this._dirty||(this._dirty=!0,this._space.notifyUpdate(this._index))};a.META_SIZE=3;return a}();e.HeapTimeTreeChunk=c;c=function(){function a(a,c){this._index=c;this._space=a;this._magic=this._lock=0;this._extra=b.mwg.core.CoreConstants.NULL_LONG;this._capacity=this._size=0;this._hash=this._next=this._kv=null;this._dirty=!1}a.prototype.world=function(){return this._space.worldByIndex(this._index)};
a.prototype.time=function(){return this._space.timeByIndex(this._index)};a.prototype.id=function(){return this._space.idByIndex(this._index)};a.prototype.extra=function(){return this._extra};a.prototype.setExtra=function(a){this._extra=a};a.prototype.lock=function(){};a.prototype.unlock=function(){};a.prototype.magic=function(){return this._magic};a.prototype.each=function(a){for(var b=0;b<this._size;b++)a(this._kv[2*b],this._kv[2*b+1])};a.prototype.get=function(a){if(0<this._size)for(var c=b.mwg.utility.HashHelper.longHash(a,
2*this._capacity),c=this._hash[c];0<=c;){if(a==this._kv[2*c])return this._kv[2*c+1];c=this._next[c]}return b.mwg.core.CoreConstants.NULL_LONG};a.prototype.put=function(a,b){this.internal_put(a,b,!0)};a.prototype.internal_put=function(a,c,e){if(0<this._capacity){for(var f=b.mwg.utility.HashHelper.longHash(a,2*this._capacity),g=this._hash[f],l=-1;0<=g;){if(a==this._kv[2*g]){l=g;break}g=this._next[g]}-1==l?(this._capacity==this._size&&(this.resize(2*this._capacity),f=b.mwg.utility.HashHelper.longHash(a,
2*this._capacity)),this._kv[2*this._size]=a,this._kv[2*this._size+1]=c,this._next[this._size]=this._hash[f],this._hash[f]=this._size,this._size++,this._magic+=1,e&&!this._dirty&&(this._dirty=!0,null!=this._space&&this._space.notifyUpdate(this._index))):this._kv[2*l+1]!=c&&(this._kv[2*l+1]=c,this._magic+=1,e&&!this._dirty&&(this._dirty=!0,null!=this._space&&this._space.notifyUpdate(this._index)))}else this._capacity=b.mwg.Constants.MAP_INITIAL_CAPACITY,this._next=new Int32Array(this._capacity),java.util.Arrays.fill(this._next,
0,this._capacity,-1),this._hash=new Int32Array(2*this._capacity),java.util.Arrays.fill(this._hash,0,2*this._capacity,-1),this._kv=new Float64Array(2*this._capacity),this._size=1,this._kv[0]=a,this._kv[1]=c,this._hash[b.mwg.utility.HashHelper.longHash(a,2*this._capacity)]=0,e&&!this._dirty&&(this._dirty=!0,null!=this._space&&this._space.notifyUpdate(this._index))};a.prototype.resize=function(a){if(a>this._capacity){if(null==this._kv)this._kv=new Float64Array(2*a),this._hash=new Int32Array(2*a),this._next=
new Int32Array(a),this._capacity=a,java.util.Arrays.fill(this._next,0,a,-1),java.util.Arrays.fill(this._hash,0,2*a,-1);else{var c=new Float64Array(2*a);java.lang.System.arraycopy(this._kv,0,c,0,2*this._size);var e=new Int32Array(a),f=new Int32Array(2*a);java.util.Arrays.fill(e,0,a,-1);java.util.Arrays.fill(f,0,2*a,-1);for(var g=0;g<this._size;g++){var l=b.mwg.utility.HashHelper.longHash(c[2*g],2*a);e[g]=f[l];f[l]=g}this._capacity=a;this._hash=f;this._next=e;this._kv=c}return!0}return!1};a.prototype.load=
function(a){if(null!=a&&0!=a.length()){for(var c=null==this._kv,e=0,f=a.length(),g=!1,l=0,h=b.mwg.core.CoreConstants.NULL_LONG;e<f;)a.read(e)==b.mwg.core.CoreConstants.CHUNK_SEP?(g?this._extra=b.mwg.utility.Base64.decodeToLongWithBounds(a,l,e):(this.resize(b.mwg.utility.Base64.decodeToLongWithBounds(a,0,e)),g=!0),l=e+1):a.read(e)==b.mwg.core.CoreConstants.CHUNK_SUB_SEP?(h!=b.mwg.core.CoreConstants.NULL_LONG&&(l=b.mwg.utility.Base64.decodeToLongWithBounds(a,l,e),this.internal_put(h,l,!c),h=b.mwg.core.CoreConstants.NULL_LONG),
l=e+1):a.read(e)==b.mwg.core.CoreConstants.CHUNK_SUB_SUB_SEP&&(h=b.mwg.utility.Base64.decodeToLongWithBounds(a,l,e),l=e+1),e++;h!=b.mwg.core.CoreConstants.NULL_LONG&&(l=b.mwg.utility.Base64.decodeToLongWithBounds(a,l,e),this.internal_put(h,l,!c))}};a.prototype.index=function(){return this._index};a.prototype.remove=function(a){throw Error("Not implemented yet!!!");};a.prototype.size=function(){return this._size};a.prototype.chunkType=function(){return b.mwg.chunk.ChunkType.WORLD_ORDER_CHUNK};a.prototype.save=
function(a){b.mwg.utility.Base64.encodeLongToBuffer(this._size,a);a.write(b.mwg.core.CoreConstants.CHUNK_SEP);this._extra!=b.mwg.core.CoreConstants.NULL_LONG&&(b.mwg.utility.Base64.encodeLongToBuffer(this._extra,a),a.write(b.mwg.core.CoreConstants.CHUNK_SEP));for(var c=!0,e=0;e<this._size;e++)c||a.write(b.mwg.core.CoreConstants.CHUNK_SUB_SEP),c=!1,b.mwg.utility.Base64.encodeLongToBuffer(this._kv[2*e],a),a.write(b.mwg.core.CoreConstants.CHUNK_SUB_SUB_SEP),b.mwg.utility.Base64.encodeLongToBuffer(this._kv[2*
e+1],a);this._dirty=!1};return a}();e.HeapWorldOrderChunk=c})(f.heap||(f.heap={}))})(f.chunk||(f.chunk={}));(function(f){var e=function(){function c(){}c.prototype.slice=function(a,d){var b=d-a+1,c=new Int8Array(b);java.lang.System.arraycopy(this.buffer,a,c,0,b);return c};c.prototype.write=function(a){if(null==this.buffer)this.buffer=new Int8Array(b.mwg.core.CoreConstants.MAP_INITIAL_CAPACITY),this.buffer[0]=a,this.writeCursor=1;else if(this.writeCursor==this.buffer.length){var d=new Int8Array(2*
this.buffer.length);java.lang.System.arraycopy(this.buffer,0,d,0,this.buffer.length);d[this.writeCursor]=a;this.writeCursor++;this.buffer=d}else this.buffer[this.writeCursor]=a,this.writeCursor++};c.prototype.getNewSize=function(a,d){for(;a<d;)a*=2;return a};c.prototype.writeAll=function(a){if(null==this.buffer){var d=this.getNewSize(b.mwg.core.CoreConstants.MAP_INITIAL_CAPACITY,a.length);this.buffer=new Int8Array(d);java.lang.System.arraycopy(a,0,this.buffer,0,a.length);this.writeCursor=a.length}else this.writeCursor+
a.length>this.buffer.length?(d=this.getNewSize(this.buffer.length,this.buffer.length+a.length),d=new Int8Array(d),java.lang.System.arraycopy(this.buffer,0,d,0,this.buffer.length),java.lang.System.arraycopy(a,0,d,this.writeCursor,a.length),this.buffer=d):java.lang.System.arraycopy(a,0,this.buffer,this.writeCursor,a.length),this.writeCursor+=a.length};c.prototype.read=function(a){return this.buffer[a]};c.prototype.data=function(){var a=new Int8Array(this.writeCursor);null!=this.buffer&&java.lang.System.arraycopy(this.buffer,
0,a,0,this.writeCursor);return a};c.prototype.length=function(){return this.writeCursor};c.prototype.free=function(){this.buffer=null};c.prototype.iterator=function(){return new b.mwg.utility.DefaultBufferIterator(this)};c.prototype.removeLast=function(){this.writeCursor--};c.prototype.toString=function(){return String.fromCharCode.apply(null,this.data())};return c}();f.HeapBuffer=e;e=function(){function c(){}c.prototype.newSpace=function(a,d){return new b.mwg.core.chunk.heap.HeapChunkSpace(a,d)};
c.prototype.newBuffer=function(){return new b.mwg.core.memory.HeapBuffer};return c}();f.HeapMemoryFactory=e})(f.memory||(f.memory={}));(function(f){var e=function(){function c(){this.last=this.first=null}c.prototype.add=function(a){a=new b.mwg.core.scheduler.JobQueue.JobQueueElem(a,null);null==this.first?this.first=a:this.last._next=a;this.last=a};c.prototype.poll=function(){var a=this.first;this.first=this.first._next;return a._ptr};return c}();f.JobQueue=e;(function(b){var a=function(){return function(a,
b){this._ptr=a;this._next=b}}();b.JobQueueElem=a})(e=f.JobQueue||(f.JobQueue={}));e=function(){function b(){}b.prototype.dispatch=function(a,d){d()};b.prototype.start=function(){};b.prototype.stop=function(){};b.prototype.workers=function(){return 1};return b}();f.NoopScheduler=e;e=function(){function c(){this.queue=new b.mwg.core.scheduler.JobQueue;this.wip=new java.util.concurrent.atomic.AtomicInteger(0)}c.prototype.dispatch=function(a,d){this.queue.add(d);if(0==this.wip.getAndIncrement()){do{var b=
this.queue.poll();null!=b&&b()}while(0<this.wip.decrementAndGet())}};c.prototype.start=function(){};c.prototype.stop=function(){};c.prototype.workers=function(){return 1};return c}();f.TrampolineScheduler=e})(f.scheduler||(f.scheduler={}));(function(f){var e=function(c){function a(a,b){c.call(this);this._relationName=a;this._variableNameToAdd=b}__extends(a,c);a.prototype.eval=function(a){var c=a.result(),e=a.variable(a.template(this._variableNameToAdd));if(null!=c&&null!=e)for(var f=a.template(this._relationName),
c=c.iterator(),g=c.next();null!=g;){if(g instanceof b.mwg.plugin.AbstractNode)for(var l=e.iterator(),h=l.next();null!=h;)h instanceof b.mwg.plugin.AbstractNode&&g.add(f,h),h=l.next();g=c.next()}a.continueTask()};a.prototype.toString=function(){return"add('"+this._relationName+"'"+b.mwg.Constants.QUERY_SEP+"'"+this._variableNameToAdd+"')"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionAdd=e;e=function(c){function a(a,b){c.call(this);this._relationName=a;this._variableNameTarget=b}__extends(a,
c);a.prototype.eval=function(a){var c=a.result(),e=a.variable(a.template(this._variableNameTarget));if(null!=c&&null!=e)for(var f=a.template(this._relationName),c=c.iterator(),g=c.next();null!=g;){if(g instanceof b.mwg.plugin.AbstractNode)for(var l=e.iterator(),h=l.next();null!=h;)h instanceof b.mwg.plugin.AbstractNode&&h.add(f,g),h=l.next();g=c.next()}a.continueTask()};a.prototype.toString=function(){return"addTo('"+this._relationName+"'"+b.mwg.Constants.QUERY_SEP+"'"+this._variableNameTarget+"')"};
return a}(b.mwg.plugin.AbstractTaskAction);f.ActionAddTo=e;e=function(b){function a(a,e){b.call(this);this._name=a;this._global=e}__extends(a,b);a.prototype.eval=function(a){var b=a.result();this._global?a.addToGlobalVariable(a.template(this._name),b):a.addToVariable(a.template(this._name),b);a.continueTask()};a.prototype.toString=function(){return this._global?"addToGlobalVar('"+this._name+"')":"addToVar('"+this._name+"')"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionAddToVar=e;e=function(b){function a(a,
e){b.call(this);this._name=a;this._global=e}__extends(a,b);a.prototype.eval=function(a){var b=a.result();this._global?a.setGlobalVariable(a.template(this._name),b):a.setVariable(a.template(this._name),b);a.continueTask()};a.prototype.toString=function(){return this._global?"asGlobalVar('"+this._name+"')":"asVar('"+this._name+"')"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionAsVar=e;e=function(b){function a(){b.apply(this,arguments)}__extends(a,b);a.prototype.eval=function(a){a.continueWith(a.newResult())};
a.prototype.toString=function(){return"clear()"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionClear=e;e=function(b){function a(a){b.call(this);this._name=a}__extends(a,b);a.prototype.eval=function(a){var b=a.result();a.defineVariable(a.template(this._name),b);a.continueTask()};a.prototype.toString=function(){return"defineVar('"+this._name+"')"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionDefineVar=e;e=function(c){function a(a,b){c.call(this);this._cond=b;this._then=a}__extends(a,c);a.prototype.eval=
function(a){var c=this,e=this,f=Array(1);f[0]=function(g){var l=a._result;a._result=g;c._cond(a)?(null!=l&&l.free(),e._then.executeFrom(a,a._result,b.mwg.plugin.SchedulerAffinity.SAME_THREAD,f[0])):(null!=l&&l.free(),a.continueWith(g))};this._then.executeFrom(a,a._result,b.mwg.plugin.SchedulerAffinity.SAME_THREAD,f[0])};a.prototype.toString=function(){return"doWhile()"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionDoWhile=e;e=function(c){function a(a){c.call(this);this._subTask=a}__extends(a,
c);a.prototype.eval=function(a){var c=this,e=this,f=a.result();if(null==f)a.continueTask();else{var g=f.iterator(),l=a.newResult();l.allocate(f.size());var h=Array(1),n=Array(1);h[0]=function(c){if(null!=c)for(var k=0;k<c.size();k++)l.add(c.get(k));n[0].free();var f=g.nextWithIndex();n[0]=null!=f?a.wrap(f.right()):null;null==f?a.continueWith(l):e._subTask.executeFromUsing(a,n[0],b.mwg.plugin.SchedulerAffinity.SAME_THREAD,function(a){a.defineVariable("i",f.left())},h[0])};var p=g.nextWithIndex();null!=
p?(n[0]=a.wrap(p.right()),a.graph().scheduler().dispatch(b.mwg.plugin.SchedulerAffinity.SAME_THREAD,function(){c._subTask.executeFromUsing(a,n[0],b.mwg.plugin.SchedulerAffinity.SAME_THREAD,function(a){a.defineVariable("i",p.left())},h[0])})):a.continueWith(l)}};a.prototype.toString=function(){return"flatMap()"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionFlatmap=e;e=function(c){function a(a){c.call(this);this._subTask=a}__extends(a,c);a.prototype.eval=function(a){var c=this,e=a.result(),f=
a.wrap(null),g=e.iterator(),e=e.size();if(-1==e)throw Error("Foreach on non array structure are not supported yet!");f.allocate(e);var l=a.graph().newCounter(e),h=Array(1);h[0]=function(){var e=g.nextWithIndex();null!=e&&c._subTask.executeFromUsing(a,a.wrap(e.right()),b.mwg.plugin.SchedulerAffinity.ANY_LOCAL_THREAD,function(a){a.defineVariable("i",e.left())},function(a){if(null!=a)for(var d=0;d<a.size();d++)f.add(a.get(d));l.count();h[0]()})};for(var e=a.graph().scheduler().workers(),n=0;n<e;n++)h[0]();
l.then(function(){a.continueWith(f)})};a.prototype.toString=function(){return"flatMapPar()"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionFlatmapPar=e;e=function(c){function a(a){c.call(this);this._subTask=a}__extends(a,c);a.prototype.eval=function(a){var c=this,e=a.result();if(null==e)a.continueTask();else{var f=e.iterator(),g=Array(1);g[0]=function(e){null!=e&&e.free();var m=f.nextWithIndex();null==m?a.continueTask():c._subTask.executeFromUsing(a,a.wrap(m.right()),b.mwg.plugin.SchedulerAffinity.SAME_THREAD,
function(a){a.defineVariable("i",m.left())},g[0])};var l=f.nextWithIndex();null!=l?this._subTask.executeFromUsing(a,a.wrap(l.right()),b.mwg.plugin.SchedulerAffinity.SAME_THREAD,function(a){a.defineVariable("i",l.left())},g[0]):a.continueTask()}};a.prototype.toString=function(){return"foreach()"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionForeach=e;e=function(c){function a(a){c.call(this);this._subTask=a}__extends(a,c);a.prototype.eval=function(a){var c=this,e=a.result(),f=e.iterator(),e=e.size();
if(-1==e)throw Error("Foreach on non array structure are not supported yet!");var g=a.graph().newCounter(e),l=Array(1);l[0]=function(){var e=f.nextWithIndex();null!=e&&c._subTask.executeFromUsing(a,a.wrap(e.right()),b.mwg.plugin.SchedulerAffinity.ANY_LOCAL_THREAD,function(a){a.defineVariable("i",e.left())},function(a){null!=a&&a.free();g.count();l[0]()})};for(var e=a.graph().scheduler().workers(),h=0;h<e;h++)l[0]();g.then(function(){a.continueTask()})};a.prototype.toString=function(){return"foreachPar()"};
return a}(b.mwg.plugin.AbstractTaskAction);f.ActionForeachPar=e;e=function(c){function a(a,b){c.call(this);this._indexName=a;this._query=b}__extends(a,c);a.prototype.eval=function(a){var b=a.template(this._indexName),c=a.template(this._query);a.graph().find(a.world(),a.time(),b,c,function(b){a.continueWith(a.wrap(b))})};a.prototype.toString=function(){return"fromIndex('"+this._indexName+"'"+b.mwg.Constants.QUERY_SEP+"'"+this._query+"')"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionFromIndex=
e;e=function(b){function a(a){b.call(this);this._indexName=a}__extends(a,b);a.prototype.eval=function(a){var b=a.template(this._indexName);a.graph().findAll(a.world(),a.time(),b,function(b){a.continueWith(a.wrap(b))})};a.prototype.toString=function(){return"fromIndexAll('"+this._indexName+"')"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionFromIndexAll=e;e=function(b){function a(a,e){b.call(this);this._name=a;this._index=e}__extends(a,b);a.prototype.eval=function(a){var b=a.template(this._name),
b=-1!=this._index?a.wrap(a.variable(b).get(this._index)):a.variable(b);null!=b&&(b=b.clone());a.continueWith(b)};a.prototype.toString=function(){return"fromVar('"+this._name+"')"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionFromVar=e;e=function(c){function a(a){c.call(this);this._name=a}__extends(a,c);a.prototype.eval=function(a){var c=a.newResult(),e=a.template(this._name),f=a.result();if(null!=f){for(var g=f.size(),l=a.graph().newCounter(g),h=function(a){var d=f.get(a);d instanceof b.mwg.plugin.AbstractNode?
d.type(e)==b.mwg.Type.RELATION?d.rel(e,function(a){if(null!=a)for(var b=0;b<a.length;b++)c.add(a[b]);d.free();l.count()}):(a=d.get(e),null!=a&&c.add(a),d.free(),l.count()):(c.add(d),l.count())},n=0;n<g;n++)h(n);l.then(function(){f.clear();a.continueWith(c)})}else a.continueTask()};a.prototype.toString=function(){return"get('"+this._name+"')"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionGet=e;e=function(c){function a(a,b){c.call(this);this._condition=a;this._action=b}__extends(a,c);a.prototype.eval=
function(a){this._condition(a)?this._action.executeFrom(a,a.result(),b.mwg.plugin.SchedulerAffinity.SAME_THREAD,function(b){a.continueWith(b)}):a.continueTask()};a.prototype.toString=function(){return"ifThen()"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionIfThen=e;e=function(c){function a(a,b,e){c.call(this);this._condition=a;this._thenSub=b;this._elseSub=e}__extends(a,c);a.prototype.eval=function(a){this._condition(a)?this._thenSub.executeFrom(a,a.result(),b.mwg.plugin.SchedulerAffinity.SAME_THREAD,
function(b){a.continueWith(b)}):this._elseSub.executeFrom(a,a.result(),b.mwg.plugin.SchedulerAffinity.SAME_THREAD,function(b){a.continueWith(b)})};a.prototype.toString=function(){return"ifThen()"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionIfThenElse=e;e=function(c){function a(a,b,e){c.call(this);this._indexName=a;this._flatKeyAttributes=b;this._isIndexation=e}__extends(a,c);a.prototype.eval=function(a){for(var c=a.result(),e=a.template(this._indexName),f=a.template(this._flatKeyAttributes),
g=new b.mwg.core.utility.CoreDeferCounter(c.size()),l=function(a){if(a)g.count();else throw Error("Error during indexation of node with id "+c.get(0).id());},h=0;h<c.size();h++){var n=c.get(h);n instanceof b.mwg.plugin.AbstractNode?this._isIndexation?a.graph().index(e,n,f,l):a.graph().unindex(e,n,f,l):g.count()}g.then(function(){a.continueTask()})};a.prototype.toString=function(){return this._isIndexation?"indexNode('"+this._indexName+"','"+this._flatKeyAttributes+"')":"unindexNode('"+this._indexName+
"','"+this._flatKeyAttributes+"')"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionIndexOrUnindexNode=e;e=function(c){function a(a,b,e,f,g){c.call(this);this._indexName=e;this._flatKeyAttributes=f;this._isIndexation=g;this._world=a;this._time=b}__extends(a,c);a.prototype.eval=function(a){for(var c=a.result(),e=java.lang.Long.parseLong(a.template(this._world)),f=java.lang.Long.parseLong(a.template(this._time)),g=a.template(this._indexName),l=a.template(this._flatKeyAttributes),h=new b.mwg.core.utility.CoreDeferCounter(c.size()),
n=function(a){if(a)h.count();else throw Error("Error during indexation of node with id "+c.get(0).id());},p=0;p<c.size();p++){var q=c.get(p);q instanceof b.mwg.plugin.AbstractNode?this._isIndexation?a.graph().indexAt(e,f,g,q,l,n):a.graph().unindexAt(e,f,g,q,l,n):h.count()}h.then(function(){a.continueTask()})};a.prototype.toString=function(){return this._isIndexation?"indexNodeAt('"+this._world+"','"+this._time+"',''"+this._indexName+"','"+this._flatKeyAttributes+"')":"unindexNodeAt('"+this._world+
"','"+this._time+"',''"+this._indexName+"','"+this._flatKeyAttributes+"')"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionIndexOrUnindexNodeAt=e;e=function(b){function a(){b.apply(this,arguments)}__extends(a,b);a.prototype.eval=function(a){a.graph().indexes(a.world(),a.time(),function(b){a.continueWith(a.wrap(b))})};a.prototype.toString=function(){return"indexesNames()"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionIndexesNames=e;e=function(b){function a(a){b.call(this);this._value=a}__extends(a,
b);a.prototype.eval=function(a){a.continueWith(a.wrap(this._value).clone())};a.prototype.toString=function(){return"inject()"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionInject=e;e=function(c){function a(a){c.call(this);this._subTask=a}__extends(a,c);a.prototype.eval=function(a){var c=a.result();this._subTask.executeFrom(a,c,b.mwg.plugin.SchedulerAffinity.SAME_THREAD,function(b){null!=b&&b.free();a.continueWith(c)})};a.prototype.toString=function(){return"subTask()"};return a}(b.mwg.plugin.AbstractTaskAction);
f.ActionIsolate=e;e=function(c){function a(a){c.call(this);this._time=a}__extends(a,c);a.prototype.eval=function(a){var c=a.template(this._time),e;try{e=java.lang.Long.parseLong(c)}catch(f){if(f instanceof Error)c=parseFloat(c),e=0>c?Math.ceil(c):Math.floor(c);else throw f;}for(var r=a.result(),g=new b.mwg.core.utility.CoreDeferCounter(r.size()),c=r.size(),l=function(a){var d=r.get(a);d instanceof b.mwg.plugin.AbstractNode?d.jump(e,function(b){d.free();r.set(a,b);g.count()}):g.count()},h=0;h<c;h++)l(h);
g.then(function(){a.continueTask()})};a.prototype.toString=function(){return"jump('"+this._time+"')"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionJump=e;e=function(c){function a(a,b,e,f){c.call(this);this._indexedRelation=a;this._flatKeyAttributes=b;this._isIndexation=f;this._varNodeToAdd=e}__extends(a,c);a.prototype.eval=function(a){var c=a.result(),e=a.template(this._indexedRelation),f=a.template(this._flatKeyAttributes),g=a.variable(this._varNodeToAdd);if(0==g.size())throw Error("Error while adding a new node in a local index: '"+
this._varNodeToAdd+"' does not contain any element.");for(var l=new b.mwg.core.utility.CoreDeferCounter(c.size()*g.size()),h=function(a){if(a)l.count();else throw Error("Error during indexation of node with id "+c.get(0).id());},n=0;n<c.size();n++)for(var p=c.get(n),q=0;q<g.size();q++){var t=g.get(q);t instanceof b.mwg.plugin.AbstractNode&&p instanceof b.mwg.plugin.AbstractNode?this._isIndexation?p.index(e,t,f,h):p.unindex(e,t,f,h):l.count()}l.then(function(){a.continueTask()})};return a}(b.mwg.plugin.AbstractTaskAction);
f.ActionLocalIndexOrUnindex=e;e=function(b){function a(a){b.call(this);this._id=a}__extends(a,b);a.prototype.eval=function(a){var b=java.lang.Long.parseLong(a.template(this._id));a.graph().lookup(a.world(),a.time(),b,function(b){a.continueWith(a.wrap(b))})};a.prototype.toString=function(){return"lookup('"+this._id+'")'};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionLookup=e;e=function(b){function a(a){b.call(this);this._ids=a}__extends(a,b);a.prototype.eval=function(a){var b=a.template(this._ids).trim();
0===b.lastIndexOf("[",0)&&(b=b.substring(1,b.length-1));for(var b=b.split(","),c=new Float64Array(b.length),e=0;e<b.length;e++)c[e]=java.lang.Long.parseLong(b[e]);a.graph().lookupAll(a.world(),a.time(),c,function(b){a.continueWith(a.wrap(b))})};a.prototype.toString=function(){return"lookup('"+this._ids+'")'};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionLookupAll=e;e=function(c){function a(a,b,e){c.call(this);this._subTask=e;this._lower=a;this._upper=b}__extends(a,c);a.prototype.eval=function(a){var c=
a.template(this._lower),e=a.template(this._upper),c=parseFloat(a.template(c)),f=parseFloat(a.template(e)),g=a.result(),l=this,h=new java.util.concurrent.atomic.AtomicInteger(c);if(0<=f-c){var n=Array(1);n[0]=function(c){var e=h.getAndIncrement();null!=c&&c.free();e>f?a.continueTask():l._subTask.executeFromUsing(a,g,b.mwg.plugin.SchedulerAffinity.SAME_THREAD,function(a){a.defineVariable("i",e)},n[0])};this._subTask.executeFromUsing(a,g,b.mwg.plugin.SchedulerAffinity.SAME_THREAD,function(a){a.defineVariable("i",
h.getAndIncrement())},n[0])}else a.continueTask()};a.prototype.toString=function(){return"loop('"+this._lower+"','"+this._upper+"')"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionLoop=e;e=function(c){function a(a,b,e){c.call(this);this._subTask=e;this._lower=a;this._upper=b}__extends(a,c);a.prototype.eval=function(a){var c=a.template(this._lower),e=a.template(this._upper),c=parseFloat(a.template(c)),e=parseFloat(a.template(e)),f=a.result(),g=a.newResult();if(0<e-c){for(var l=a.graph().newCounter(e-
c+1),h=function(c){n._subTask.executeFromUsing(a,f,b.mwg.plugin.SchedulerAffinity.ANY_LOCAL_THREAD,function(a){a.defineVariable("i",c)},function(a){if(null!=a&&0<a.size())for(var b=0;b<a.size();b++)g.add(a.get(b));l.count()})},n=this;c<=e;c++)h(c);l.then(function(){a.continueWith(g)})}else a.continueWith(g)};a.prototype.toString=function(){return"loopPar('"+this._lower+"','"+this._upper+"')"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionLoopPar=e;e=function(b){function a(a){b.call(this);this._map=
a}__extends(a,b);a.prototype.eval=function(a){for(var b=a.result(),c=a.wrap(null),e=b.size(),f=0;f<e;f++)c.add(this._map(b.get(f)));a.continueWith(c)};a.prototype.toString=function(){return"map()"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionMap=e;e=function(c){function a(a){c.call(this);this._expression=a;this._engine=b.mwg.core.task.math.CoreMathExpressionEngine.parse(a)}__extends(a,c);a.prototype.eval=function(a){for(var c=a.result(),e=a.newResult(),f=c.size(),g=0;g<f;g++){var l=c.get(g),
h=new java.util.HashMap;h.put("PI",Math.PI);h.put("TRUE",1);h.put("FALSE",0);l instanceof b.mwg.plugin.AbstractNode?(e.add(this._engine.eval(l,a,h)),l.free()):e.add(this._engine.eval(null,a,h))}c.clear();a.continueWith(e)};a.prototype.toString=function(){return"math('"+this._expression+"')"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionMath=e;e=function(b){function a(a){b.call(this);this._typeNode=a}__extends(a,b);a.prototype.eval=function(a){var b;null==this._typeNode?b=a.graph().newNode(a.world(),
a.time()):(b=a.template(this._typeNode),b=a.graph().newTypedNode(a.world(),a.time(),b));a.continueWith(a.wrap(b))};a.prototype.toString=function(){return null!=this._typeNode?"newTypedNode('"+this._typeNode+"')":"newNode()"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionNewNode=e;e=function(c){function a(a,b){c.call(this);this.subAction=null;this._actionName=a;this._flatParams=b}__extends(a,c);a.prototype.eval=function(a){var c=a.template(this._actionName),e=a.template(this._flatParams),f=a.graph().taskAction(c);
if(null==f)throw Error("Unknown task action: "+c);for(var g=b.mwg.core.CoreConstants.MAP_INITIAL_CAPACITY,c=Array(g),l=0,h=0,n=e.length,p=0;h<n;){if(e.charAt(h)==b.mwg.Constants.QUERY_SEP){var q=e.substring(p,h);if(0<q.length){if(l>=g){var t=2*g,p=Array(t);java.lang.System.arraycopy(c,0,p,0,g);c=p;g=t}c[l]=q;l++}p=h+1}h++}e=e.substring(p,h);0<e.length&&(l>=g&&(p=Array(2*g),java.lang.System.arraycopy(c,0,p,0,g),c=p),c[l]=e,l++);l<c.length&&(e=Array(l),java.lang.System.arraycopy(c,0,e,0,l),c=e);this.subAction=
f(c);null!=this.subAction?this.subAction.eval(a):a.continueTask()};a.prototype.toString=function(){return this._actionName+"("+this._flatParams+")"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionPlugin=e;e=function(b){function a(a,e){b.call(this);this._name=a;this._withLineBreak=e}__extends(a,b);a.prototype.eval=function(a){console.log(a.template(this._name));a.continueTask()};a.prototype.toString=function(){return"print('"+this._name+"')"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionPrint=
e;e=function(c){function a(a){c.call(this);this._filter=a}__extends(a,c);a.prototype.eval=function(a){for(var c=this,e=a.result(),f=a.newResult(),g=0;g<e.size();g++)if(e.get(g)instanceof b.mwg.plugin.AbstractNode){var l=e.get(g);a.graph().resolver().resolveState(l).each(function(b,e,m){if(-1==c._filter||e==c._filter)e=a.graph().resolver().hashToString(b),null!=e?f.add(e):f.add(b)});l.free()}e.clear();a.continueWith(f)};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionProperties=e;e=function(c){function a(a,
b){c.call(this);this._relationName=a;this._variableNameToRemove=b}__extends(a,c);a.prototype.eval=function(a){var c=a.result(),e=a.variable(a.template(this._variableNameToRemove));if(null!=c&&null!=e)for(var f=a.template(this._relationName),c=c.iterator(),g=c.next();null!=g;){if(g instanceof b.mwg.plugin.AbstractNode)for(var l=e.iterator(),h=l.next();null!=h;)h instanceof b.mwg.plugin.AbstractNode&&g.remove(f,h),h=l.next();g=c.next()}a.continueTask()};a.prototype.toString=function(){return"remove('"+
this._relationName+"'"+b.mwg.Constants.QUERY_SEP+"'"+this._variableNameToRemove+"')"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionRemove=e;e=function(c){function a(a){c.call(this);this._propertyName=a}__extends(a,c);a.prototype.eval=function(a){var c=a.result();if(null!=c)for(var e=a.template(this._propertyName),f=0;f<c.size();f++){var g=c.get(f);g instanceof b.mwg.plugin.AbstractNode&&g.removeProperty(e)}a.continueTask()};a.prototype.toString=function(){return"removeProperty('"+this._propertyName+
"')"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionRemoveProperty=e;e=function(b){function a(){b.apply(this,arguments)}__extends(a,b);a.prototype.eval=function(a){a.graph().save(function(b){a.continueTask()})};a.prototype.toString=function(){return"save()"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionSave=e;e=function(c){function a(a){c.call(this);this._filter=a}__extends(a,c);a.prototype.eval=function(a){for(var c=a.result(),e=a.newResult(),f=c.size(),g=0;g<f;g++){var l=c.get(g);l instanceof
b.mwg.plugin.AbstractNode?this._filter(l)?e.add(l):l.free():e.add(l)}c.clear();a.continueWith(e)};a.prototype.toString=function(){return"select()"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionSelect=e;e=function(c){function a(a){c.call(this);this._filter=a}__extends(a,c);a.prototype.eval=function(a){for(var c=a.result(),e=a.wrap(null),c=c.iterator(),f=c.next();null!=f;)this._filter(f,a)&&(f instanceof b.mwg.plugin.AbstractNode?e.add(f.graph().cloneNode(f)):e.add(f)),f=c.next();a.continueWith(e)};
a.prototype.toString=function(){return"selectObject()"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionSelectObject=e;e=function(c){function a(a,b,e,f){c.call(this);this._relationName=a;this._variableNameToSet=e;this._propertyType=b;this._force=f}__extends(a,c);a.prototype.eval=function(a){var c=a.result(),e=a.template(this._relationName);if(null!=c){var f;f=a.template(this._variableNameToSet);switch(this._propertyType){case b.mwg.Type.BOOL:f=this.parseBoolean(f.toString());break;case b.mwg.Type.INT:f=
b.mwg.core.task.TaskHelper.parseInt(f.toString());break;case b.mwg.Type.DOUBLE:f=parseFloat(f.toString());break;case b.mwg.Type.LONG:f=java.lang.Long.parseLong(f.toString());break}for(var g=0;g<c.size();g++){var l=c.get(g);l instanceof b.mwg.plugin.AbstractNode&&(this._force?l.forceProperty(e,this._propertyType,f):l.setProperty(e,this._propertyType,f))}}a.continueTask()};a.prototype.toString=function(){return"setProperty('"+this._relationName+"'"+b.mwg.Constants.QUERY_SEP+"'"+this._propertyType+"'"+
b.mwg.Constants.QUERY_SEP+"'"+this._variableNameToSet+"')"};a.prototype.parseBoolean=function(a){a=a.toLowerCase();return"true"===a||"1"===a};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionSetProperty=e;e=function(b){function a(a){b.call(this);this._splitPattern=a}__extends(a,b);a.prototype.eval=function(a){for(var b=a.template(this._splitPattern),c=a.result(),e=a.wrap(null),f=0;f<c.size();f++){var l=c.get(0);if(l instanceof String)if(l=l.split(b),1==c.size())for(var h=0;h<l.length;h++)e.add(l[h]);
else e.add(l)}a.continueWith(e)};a.prototype.toString=function(){return"split('"+this._splitPattern+"')"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionSplit=e;e=function(c){function a(a){c.call(this);this._subTask=a}__extends(a,c);a.prototype.eval=function(a){var c=a.result();this._subTask.executeFrom(a,c,b.mwg.plugin.SchedulerAffinity.SAME_THREAD,function(b){a.continueWith(b)})};a.prototype.toString=function(){return"subTask()"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionSubTask=e;
e=function(c){function a(a){c.call(this);this._subTasks=a}__extends(a,c);a.prototype.eval=function(a){var c=this,e=a.result(),f=new java.util.concurrent.atomic.AtomicInteger(0),g=this._subTasks.length,l=a.newResult(),h=Array(1);h[0]=function(n){var p=f.getAndIncrement();if(null!=n)for(var q=0;q<n.size();q++){var t=n.get(q);null!=t&&l.add(t)}p<g?c._subTasks[p].executeFrom(a,e,b.mwg.plugin.SchedulerAffinity.SAME_THREAD,h[0]):a.continueWith(l)};var n=f.getAndIncrement();n<g?this._subTasks[n].executeFrom(a,
e,b.mwg.plugin.SchedulerAffinity.SAME_THREAD,h[0]):a.continueWith(l)};a.prototype.toString=function(){return"subTasks()"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionSubTasks=e;e=function(c){function a(a){c.call(this);this._subTasks=a}__extends(a,c);a.prototype.eval=function(a){var c=a.result(),e=a.newResult(),f=this._subTasks.length;e.allocate(f);for(var g=a.graph().newCounter(f),l=function(f){h._subTasks[f].executeFrom(a,c,b.mwg.plugin.SchedulerAffinity.ANY_LOCAL_THREAD,function(a){e.set(f,
a);g.count()})},h=this,n=0;n<f;n++)l(n);g.then(function(){a.continueWith(e)})};a.prototype.toString=function(){return"subTasksPar()"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionSubTasksPar=e;e=function(b){function a(a){b.call(this);this._varName=a}__extends(a,b);a.prototype.eval=function(a){var b=a.template(this._varName);a.setTime(java.lang.Long.parseLong(b));a.continueTask()};a.prototype.toString=function(){return"setTime('"+this._varName+"')"};return a}(b.mwg.plugin.AbstractTaskAction);
f.ActionTime=e;e=function(c){function a(a){c.call(this);this._name=a}__extends(a,c);a.prototype.eval=function(a){var c=a.result();if(null!=c){for(var e=c.size(),f=!0,g=b.mwg.Constants.NULL_LONG,l=b.mwg.Constants.NULL_LONG,h=0;h<e;h++){var n=c.get(h);if(n instanceof b.mwg.plugin.AbstractNode)if(l==b.mwg.Constants.NULL_LONG)l=n.time(),g=n.world();else if(n.world()!=g||n.time()!=l){f=!1;break}}var p=a.template(this._name);if(f){f=new java.util.ArrayList;for(h=0;h<e;h++)if(n=c.get(h),n instanceof b.mwg.plugin.AbstractNode){if(n.type(p)==
b.mwg.Type.RELATION){var q=n.get(p);if(null!=q)for(var t=0;t<q.size();t++)f.add(q.get(t))}n.free()}c.clear();e=new Float64Array(f.size());for(h=0;h<f.size();h++)e[h]=f.get(h);a.graph().lookupAll(g,l,e,function(b){a.continueWith(a.wrap(b))})}else{for(var E=a.newResult(),x=a.graph().newCounter(e),g=function(a){var d=c.get(a);d instanceof b.mwg.plugin.AbstractNode?d.rel(p,function(a){if(null!=a)for(var b=0;b<a.length;b++)E.add(a[b]);d.free();x.count()}):(E.add(d),x.count())},h=0;h<e;h++)g(h);x.then(function(){c.clear();
a.continueWith(E)})}}else a.continueTask()};a.prototype.toString=function(){return"traverse('"+this._name+"')"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionTraverse=e;e=function(c){function a(a){for(var b=[],e=1;e<arguments.length;e++)b[e-1]=arguments[e];c.call(this);this._queryParams=b;this._indexName=a;this._resolvedQueryParams=Array(b.length)}__extends(a,c);a.prototype.eval=function(a){for(var c=a.wrap(null),e=a.template(this._indexName),f=0;f<this._queryParams.length;f++)this._resolvedQueryParams[f]=
a.template(this._queryParams[f]);var g=a.graph().newQuery();g.setWorld(a.world());g.setTime(a.time());g.setIndexName(e);for(f=0;f<this._resolvedQueryParams.length;f+=2)g.add(this._resolvedQueryParams[f],this._resolvedQueryParams[f+1]);var l=a.result();if(null!=l){for(var e=l.size(),h=a.graph().newCounter(e),n=function(a){var d=l.get(a);d instanceof b.mwg.plugin.AbstractNode?d.findByQuery(g,function(a){if(null!=a)for(var b=0;b<a.length;b++)null!=a[b]&&c.add(a[b]);d.free();h.count()}):(c.add(d),h.count())},
f=0;f<e;f++)n(f);h.then(function(){l.clear();a.continueWith(c)})}else a.continueTask()};a.prototype.toString=function(){return"traverseIndex('"+this._indexName+b.mwg.core.CoreConstants.QUERY_SEP+java.lang.String.join(",",this._resolvedQueryParams)+"')"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionTraverseIndex=e;e=function(c){function a(a){c.call(this);this._indexName=a}__extends(a,c);a.prototype.eval=function(a){var c=a.wrap(null),e=a.template(this._indexName),f=a.result();if(null!=f){for(var g=
f.size(),l=a.graph().newCounter(g),h=function(a){var d=f.get(a);d instanceof b.mwg.plugin.AbstractNode?d.findAll(e,function(a){if(null!=a)for(var b=0;b<a.length;b++)null!=a[b]&&c.add(a[b]);d.free();l.count()}):(c.add(d),l.count())},n=0;n<g;n++)h(n);l.then(function(){f.clear();a.continueWith(c)})}else a.continueTask()};a.prototype.toString=function(){return"traverseIndexAll('"+this._indexName+"')"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionTraverseIndexAll=e;e=function(c){function a(a){c.call(this);
this._name=a}__extends(a,c);a.prototype.eval=function(a){var c=a.template(this._name),e=a.result();if(null!=e){for(var f=a.newResult(),g=e.size(),l=a.graph().newCounter(g),h=0;h<g;h++){var n=e.get(h);n instanceof b.mwg.plugin.AbstractNode?n.type(c)==b.mwg.Type.RELATION?n.rel(c,function(a){if(null!=a)for(var b=0;b<a.length;b++)f.add(a[b]);l.count()}):(f.add(n.graph().cloneNode(n)),l.count()):(f.add(n),l.count())}l.then(function(){a.continueWith(f)})}else a.continueTask()};a.prototype.toString=function(){return"traverseOrKeep('"+
this._name+"')"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionTraverseOrKeep=e;e=function(c){function a(a,b){c.call(this);this._cond=a;this._then=b}__extends(a,c);a.prototype.eval=function(a){var c=this,e=this,f=Array(1);f[0]=function(g){var l=a._result;a._result=g;c._cond(a)?(null!=l&&l.free(),e._then.executeFrom(a,a._result,b.mwg.plugin.SchedulerAffinity.SAME_THREAD,f[0])):(null!=l&&l.free(),a.continueWith(g))};this._cond(a)?this._then.executeFrom(a,a._result,b.mwg.plugin.SchedulerAffinity.SAME_THREAD,
f[0]):a.continueTask()};a.prototype.toString=function(){return"whileDo()"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionWhileDo=e;e=function(c){function a(a,b){c.call(this);this._patternTemplate=b;this._name=a}__extends(a,c);a.prototype.toString=function(){return"with('"+this._name+"'"+b.mwg.Constants.QUERY_SEP+"'"+this._patternTemplate+"')"};a.prototype.eval=function(a){for(var c=new RegExp(a.template(this._patternTemplate)),e=a.result(),f=a.newResult(),g=e.size(),l=0;l<g;l++){var h=e.get(l);
if(h instanceof b.mwg.plugin.AbstractNode){var n=h.get(this._name);null!=n&&c.test(n.toString())&&f.add(h.graph().cloneNode(h))}else f.add(h)}a.continueWith(f)};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionWith=e;e=function(c){function a(a,b){c.call(this);this._patternTemplate=b;this._name=a}__extends(a,c);a.prototype.toString=function(){return"without('"+this._name+"'"+b.mwg.Constants.QUERY_SEP+"'"+this._patternTemplate+"')"};a.prototype.eval=function(a){for(var c=new RegExp(a.template(this._patternTemplate)),
e=a.result(),f=a.newResult(),g=e.size(),l=0;l<g;l++){var h=e.get(l);if(h instanceof b.mwg.plugin.AbstractNode){var n=h.get(this._name);null!=n&&c.test(n.toString())||f.add(h.graph().cloneNode(h))}else f.add(h)}a.continueWith(f)};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionWithout=e;e=function(b){function a(a){b.call(this);this._varName=a}__extends(a,b);a.prototype.eval=function(a){var b=a.template(this._varName);a.setWorld(java.lang.Long.parseLong(b));a.continueTask()};a.prototype.toString=
function(){return"setWorld('"+this._varName+"')"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionWorld=e;e=function(b){function a(a){b.call(this);this._wrapped=a}__extends(a,b);a.prototype.eval=function(a){this._wrapped(a)};a.prototype.toString=function(){return"then()"};return a}(b.mwg.plugin.AbstractTaskAction);f.ActionWrapper=e;e=function(){function c(){this._hookFactory=this._last=this._first=null}c.prototype.addAction=function(a){null==this._first?this._last=this._first=a:(this._last.setNext(a),
this._last=a)};c.prototype.setWorld=function(a){this.addAction(new b.mwg.core.task.ActionWorld(a));return this};c.prototype.setTime=function(a){this.addAction(new b.mwg.core.task.ActionTime(a));return this};c.prototype.fromIndex=function(a,d){if(null==a)throw Error("indexName should not be null");if(null==d)throw Error("query should not be null");this.addAction(new b.mwg.core.task.ActionFromIndex(a,d));return this};c.prototype.fromIndexAll=function(a){if(null==a)throw Error("indexName should not be null");
this.addAction(new b.mwg.core.task.ActionFromIndexAll(a));return this};c.prototype.indexNode=function(a,d){this.addAction(new b.mwg.core.task.ActionIndexOrUnindexNode(a,d,!0));return this};c.prototype.indexNodeAt=function(a,d,c,e){this.addAction(new b.mwg.core.task.ActionIndexOrUnindexNodeAt(a,d,c,e,!0));return this};c.prototype.localIndex=function(a,d,c){this.addAction(new b.mwg.core.task.ActionLocalIndexOrUnindex(a,d,c,!0));return this};c.prototype.unindexNodeAt=function(a,d,c,e){this.addAction(new b.mwg.core.task.ActionIndexOrUnindexNodeAt(a,
d,c,e,!0));return this};c.prototype.unindexNode=function(a,d){this.addAction(new b.mwg.core.task.ActionIndexOrUnindexNode(a,d,!1));return this};c.prototype.localUnindex=function(a,d,c){this.addAction(new b.mwg.core.task.ActionLocalIndexOrUnindex(a,d,c,!1));return this};c.prototype.indexesNames=function(){this.addAction(new b.mwg.core.task.ActionIndexesNames);return this};c.prototype.selectWith=function(a,d){if(null==d)throw Error("pattern should not be null");this.addAction(new b.mwg.core.task.ActionWith(a,
d));return this};c.prototype.selectWithout=function(a,d){if(null==d)throw Error("pattern should not be null");this.addAction(new b.mwg.core.task.ActionWithout(a,d));return this};c.prototype.asGlobalVar=function(a){if(null==a)throw Error("variableName should not be null");this.addAction(new b.mwg.core.task.ActionAsVar(a,!0));return this};c.prototype.asVar=function(a){if(null==a)throw Error("variableName should not be null");this.addAction(new b.mwg.core.task.ActionAsVar(a,!1));return this};c.prototype.defineVar=
function(a){if(null==a)throw Error("variableName should not be null");this.addAction(new b.mwg.core.task.ActionDefineVar(a));return this};c.prototype.addToGlobalVar=function(a){if(null==a)throw Error("variableName should not be null");this.addAction(new b.mwg.core.task.ActionAddToVar(a,!0));return this};c.prototype.addToVar=function(a){if(null==a)throw Error("variableName should not be null");this.addAction(new b.mwg.core.task.ActionAddToVar(a,!1));return this};c.prototype.fromVar=function(a){if(null==
a)throw Error("variableName should not be null");this.addAction(new b.mwg.core.task.ActionFromVar(a,-1));return this};c.prototype.fromVarAt=function(a,d){if(null==a)throw Error("variableName should not be null");this.addAction(new b.mwg.core.task.ActionFromVar(a,d));return this};c.prototype.select=function(a){if(null==a)throw Error("filter should not be null");this.addAction(new b.mwg.core.task.ActionSelect(a));return this};c.prototype.selectObject=function(a){if(null==a)throw Error("filterFunction should not be null");
this.addAction(new b.mwg.core.task.ActionSelectObject(a));return this};c.prototype.selectWhere=function(a){throw Error("Not implemented yet");};c.prototype.get=function(a){this.addAction(new b.mwg.core.task.ActionGet(a));return this};c.prototype.traverse=function(a){this.addAction(new b.mwg.core.task.ActionTraverse(a));return this};c.prototype.traverseOrKeep=function(a){this.addAction(new b.mwg.core.task.ActionTraverseOrKeep(a));return this};c.prototype.traverseIndex=function(a){for(var d=[],c=1;c<
arguments.length;c++)d[c-1]=arguments[c];if(null==a)throw Error("indexName should not be null");if(0!=d.length%2)throw Error('The number of arguments in the queryParams MUST be even, because it should be a sequence of "key","value". Current size: '+d.length);this.addAction(new ((e=b.mwg.core.task.ActionTraverseIndex).bind.apply(e,[void 0].concat([a],d))));return this;var e};c.prototype.traverseIndexAll=function(a){if(null==a)throw Error("indexName should not be null");this.addAction(new b.mwg.core.task.ActionTraverseIndexAll(a));
return this};c.prototype.map=function(a){if(null==a)throw Error("mapFunction should not be null");this.addAction(new b.mwg.core.task.ActionMap(a));return this};c.prototype.group=function(a){throw Error("Not implemented yet");};c.prototype.groupWhere=function(a){throw Error("Not implemented yet");};c.prototype.inject=function(a){if(null==a)throw Error("inputValue should not be null");this.addAction(new b.mwg.core.task.ActionInject(a));return this};c.prototype.subTask=function(a){if(null==a)throw Error("subTask should not be null");
this.addAction(new b.mwg.core.task.ActionSubTask(a));return this};c.prototype.isolate=function(a){if(null==a)throw Error("subTask should not be null");this.addAction(new b.mwg.core.task.ActionIsolate(a));return this};c.prototype.subTasks=function(a){if(null==a)throw Error("subTask should not be null");this.addAction(new b.mwg.core.task.ActionSubTasks(a));return this};c.prototype.subTasksPar=function(a){if(null==a)throw Error("subTask should not be null");this.addAction(new b.mwg.core.task.ActionSubTasksPar(a));
return this};c.prototype.ifThen=function(a,d){if(null==a)throw Error("condition should not be null");if(null==d)throw Error("subTask should not be null");this.addAction(new b.mwg.core.task.ActionIfThen(a,d));return this};c.prototype.ifThenElse=function(a,d,c){if(null==a)throw Error("condition should not be null");if(null==d)throw Error("thenSub should not be null");if(null==c)throw Error("elseSub should not be null");this.addAction(new b.mwg.core.task.ActionIfThenElse(a,d,c));return this};c.prototype.whileDo=
function(a,d){this.addAction(new b.mwg.core.task.ActionWhileDo(a,d));return this};c.prototype.doWhile=function(a,d){this.addAction(new b.mwg.core.task.ActionDoWhile(a,d));return this};c.prototype.then=function(a){if(null==a)throw Error("action should not be null");this.addAction(new b.mwg.core.task.ActionWrapper(a));return this};c.prototype.foreach=function(a){if(null==a)throw Error("subTask should not be null");this.addAction(new b.mwg.core.task.ActionForeach(a));return this};c.prototype.flatmap=
function(a){if(null==a)throw Error("subTask should not be null");this.addAction(new b.mwg.core.task.ActionFlatmap(a));return this};c.prototype.foreachPar=function(a){if(null==a)throw Error("subTask should not be null");this.addAction(new b.mwg.core.task.ActionForeachPar(a));return this};c.prototype.flatmapPar=function(a){if(null==a)throw Error("subTask should not be null");this.addAction(new b.mwg.core.task.ActionFlatmapPar(a));return this};c.prototype.save=function(){this.addAction(new b.mwg.core.task.ActionSave);
return this};c.prototype.clear=function(){this.addAction(new b.mwg.core.task.ActionClear);return this};c.prototype.lookup=function(a){this.addAction(new b.mwg.core.task.ActionLookup(a));return this};c.prototype.lookupAll=function(a){this.addAction(new b.mwg.core.task.ActionLookupAll(a));return this};c.prototype.execute=function(a,b){this.executeWith(a,null,b)};c.prototype.executeSync=function(a){var b=a.newSyncCounter(1);this.executeWith(a,null,b.wrap());return b.waitResult()};c.prototype.executeWith=
function(a,d,c){var e=this;if(null!=this._first){var f=void 0,f=d instanceof b.mwg.core.task.CoreTaskResult?d.clone():new b.mwg.core.task.CoreTaskResult(d,!0);d=null;null!=this._hookFactory?d=this._hookFactory.newHook():null!=a.taskHookFactory()&&(d=a.taskHookFactory().newHook());var g=new b.mwg.core.task.CoreTaskContext(null,f,a,d,c);a.scheduler().dispatch(b.mwg.plugin.SchedulerAffinity.SAME_THREAD,function(){g.execute(e._first)})}else null!=c&&c(this.emptyResult())};c.prototype.prepareWith=function(a,
d,c){d=d instanceof b.mwg.core.task.CoreTaskResult?d.clone():new b.mwg.core.task.CoreTaskResult(d,!0);var e=null;null!=this._hookFactory?e=this._hookFactory.newHook():null!=a.taskHookFactory()&&(e=a.taskHookFactory().newHook());return new b.mwg.core.task.CoreTaskContext(null,d,a,e,c)};c.prototype.executeUsing=function(a){var d=this;null!=this._first?a.graph().scheduler().dispatch(b.mwg.plugin.SchedulerAffinity.SAME_THREAD,function(){a.execute(d._first)}):null!=a._callback&&a._callback(this.emptyResult())};
c.prototype.executeFrom=function(a,d,c,e){var f=this;if(null!=this._first){var g=new b.mwg.core.task.CoreTaskContext(a,d.clone(),a.graph(),a.hook(),e);a.graph().scheduler().dispatch(c,function(){g.execute(f._first)})}else null!=e&&e(this.emptyResult())};c.prototype.executeFromUsing=function(a,d,c,e,f){var g=this;if(null!=this._first){var l=new b.mwg.core.task.CoreTaskContext(a,d.clone(),a.graph(),a.hook(),f);null!=e&&e(l);a.graph().scheduler().dispatch(c,function(){l.execute(g._first)})}else null!=
f&&f(this.emptyResult())};c.prototype.action=function(a,d){if(null==a)throw Error("name should not be null");if(null==d)throw Error("flatParams should not be null");this.addAction(new b.mwg.core.task.ActionPlugin(a,d));return this};c.prototype.parse=function(a){if(null==a)throw Error("flat should not be null");for(var d=0,c=a.length,e=0,f=null,g=!1,l=!1;d<c;){switch(a.charAt(d)){case "'":for(l=!0;d<c&&"'"!=a.charAt(d);)d++;break;case b.mwg.Constants.TASK_SEP:g||(f=a.substring(e,d),this.action("get",
f));f=null;l=!1;e=d+1;break;case b.mwg.Constants.TASK_PARAM_OPEN:f=a.substring(e,d);e=d+1;break;case b.mwg.Constants.TASK_PARAM_CLOSE:g=l?a.substring(e+1,d-1):a.substring(e,d),this.action(f,g),f=null,e=d+1,g=!0}d++}g||(f=a.substring(e,d),0<f.length&&this.action("get",f));return this};c.prototype.newNode=function(){this.addAction(new b.mwg.core.task.ActionNewNode(null));return this};c.prototype.newTypedNode=function(a){this.addAction(new b.mwg.core.task.ActionNewNode(a));return this};c.prototype.setProperty=
function(a,d,c){if(null==a)throw Error("propertyName should not be null");if(null==c)throw Error("variableNameToSet should not be null");this.addAction(new b.mwg.core.task.ActionSetProperty(a,d,c,!1));return this};c.prototype.forceProperty=function(a,d,c){if(null==a)throw Error("propertyName should not be null");if(null==c)throw Error("variableNameToSet should not be null");this.addAction(new b.mwg.core.task.ActionSetProperty(a,d,c,!0));return this};c.prototype.removeProperty=function(a){if(null==
a)throw Error("propertyName should not be null");this.addAction(new b.mwg.core.task.ActionRemoveProperty(a));return this};c.prototype.add=function(a,d){if(null==a)throw Error("relationName should not be null");if(null==d)throw Error("variableNameToAdd should not be null");this.addAction(new b.mwg.core.task.ActionAdd(a,d));return this};c.prototype.addTo=function(a,d){if(null==a)throw Error("relationName should not be null");if(null==d)throw Error("variableNameTarget should not be null");this.addAction(new b.mwg.core.task.ActionAddTo(a,
d));return this};c.prototype.propertiesWithTypes=function(a){this.addAction(new b.mwg.core.task.ActionProperties(a));return this};c.prototype.properties=function(){this.addAction(new b.mwg.core.task.ActionProperties(-1));return this};c.prototype.remove=function(a,d){if(null==a)throw Error("relationName should not be null");if(null==d)throw Error("variableNameToRemove should not be null");this.addAction(new b.mwg.core.task.ActionRemove(a,d));return this};c.prototype.jump=function(a){if(null==a)throw Error("time should not be null");
this.addAction(new b.mwg.core.task.ActionJump(a));return this};c.prototype.math=function(a){this.addAction(new b.mwg.core.task.ActionMath(a));return this};c.prototype.split=function(a){this.addAction(new b.mwg.core.task.ActionSplit(a));return this};c.prototype.loop=function(a,d,c){this.addAction(new b.mwg.core.task.ActionLoop(a,d,c));return this};c.prototype.loopPar=function(a,d,c){this.addAction(new b.mwg.core.task.ActionLoopPar(a,d,c));return this};c.prototype.print=function(a){this.addAction(new b.mwg.core.task.ActionPrint(a,
!1));return this};c.prototype.println=function(a){this.addAction(new b.mwg.core.task.ActionPrint(a,!0));return this};c.prototype.hook=function(a){this._hookFactory=a;return this};c.prototype.emptyResult=function(){return new b.mwg.core.task.CoreTaskResult(null,!1)};c.prototype.mathConditional=function(a){return(new b.mwg.core.task.math.MathConditional(a)).conditional()};c.fillDefault=function(a){a.put("get",function(a){if(1!=a.length)throw Error("get action need one parameter");return new b.mwg.core.task.ActionGet(a[0])});
a.put("math",function(a){if(1!=a.length)throw Error("math action need one parameter");return new b.mwg.core.task.ActionMath(a[0])});a.put("traverse",function(a){if(1!=a.length)throw Error("traverse action need one parameter");return new b.mwg.core.task.ActionTraverse(a[0])});a.put("traverseOrKeep",function(a){if(1!=a.length)throw Error("traverseOrKeep action need one parameter");return new b.mwg.core.task.ActionTraverseOrKeep(a[0])});a.put("fromIndexAll",function(a){if(1!=a.length)throw Error("fromIndexAll action need one parameter");
return new b.mwg.core.task.ActionFromIndexAll(a[0])});a.put("fromIndex",function(a){if(2!=a.length)throw Error("fromIndex action need two parameter");return new b.mwg.core.task.ActionFromIndex(a[0],a[1])});a.put("with",function(a){if(2!=a.length)throw Error("with action need two parameter");return new b.mwg.core.task.ActionWith(a[0],a[1])});a.put("without",function(a){if(2!=a.length)throw Error("without action need two parameter");return new b.mwg.core.task.ActionWithout(a[0],a[1])})};return c}();
f.CoreTask=e;e=function(){function c(a,b,c,e,f){this._nextVariables=this._localVariables=null;this._hook=e;null!=a?(this._time=a.time(),this._world=a.world()):this._time=this._world=0;this._graph=c;this._parent=a;this._globalVariables=null==a?new java.util.ConcurrentHashMap:a.globalVariables();this._result=b;this._callback=f}c.prototype.graph=function(){return this._graph};c.prototype.world=function(){return this._world};c.prototype.setWorld=function(a){this._world=a};c.prototype.time=function(){return this._time};
c.prototype.setTime=function(a){this._time=a};c.prototype.variable=function(a){var b=this._globalVariables.get(a);null==b&&(b=this.internal_deep_resolve(a));return b};c.prototype.internal_deep_resolve=function(a){var b=null;null!=this._localVariables&&(b=this._localVariables.get(a));if(null==b&&null!=this._parent){var c=this._parent;return null!=c._nextVariables&&(b=c._nextVariables.get(a),null!=b)?b:c.internal_deep_resolve(a)}return b};c.prototype.wrap=function(a){return new b.mwg.core.task.CoreTaskResult(a,
!1)};c.prototype.wrapClone=function(a){return new b.mwg.core.task.CoreTaskResult(a,!0)};c.prototype.newResult=function(){return new b.mwg.core.task.CoreTaskResult(null,!1)};c.prototype.declareVariable=function(a){null==this._localVariables&&(this._localVariables=new java.util.HashMap);this._localVariables.put(a,new b.mwg.core.task.CoreTaskResult(null,!1))};c.prototype.lazyWrap=function(a){return a instanceof b.mwg.core.task.CoreTaskResult?a:this.wrap(a)};c.prototype.defineVariable=function(a,b){null==
this._localVariables&&(this._localVariables=new java.util.HashMap);this._localVariables.put(a,this.lazyWrap(b).clone())};c.prototype.defineVariableForSubTask=function(a,b){null==this._nextVariables&&(this._nextVariables=new java.util.HashMap);this._nextVariables.put(a,this.lazyWrap(b).clone())};c.prototype.setGlobalVariable=function(a,b){var c=this._globalVariables.put(a,this.lazyWrap(b).clone());null!=c&&c.free()};c.prototype.setVariable=function(a,b){var c=this.internal_deep_resolve_map(a);null==
c&&(null==this._localVariables&&(this._localVariables=new java.util.HashMap),c=this._localVariables);c=c.put(a,this.lazyWrap(b).clone());null!=c&&c.free()};c.prototype.internal_deep_resolve_map=function(a){if(null!=this._localVariables){var b=this._localVariables.get(a);if(null!=b)return this._localVariables}return null!=this._parent?(b=this._parent,null!=b._nextVariables&&(b=b._nextVariables.get(a),null!=b)?this._localVariables:this._parent.internal_deep_resolve_map(a)):null};c.prototype.addToGlobalVariable=
function(a,d){var c=this._globalVariables.get(a);null==c&&(c=new b.mwg.core.task.CoreTaskResult(null,!1),this._globalVariables.put(a,c));if(null!=d)if(d instanceof b.mwg.core.task.CoreTaskResult)for(var e=0;e<d.size();e++){var f=d.get(e);f instanceof b.mwg.plugin.AbstractNode?c.add(f.graph().cloneNode(f)):c.add(f)}else d instanceof b.mwg.plugin.AbstractNode?(f=d,c.add(f.graph().cloneNode(f))):c.add(d)};c.prototype.addToVariable=function(a,d){var c=this.internal_deep_resolve_map(a);null==c&&(null==
this._localVariables&&(this._localVariables=new java.util.HashMap),c=this._localVariables);var e=c.get(a);null==e&&(e=new b.mwg.core.task.CoreTaskResult(null,!1),c.put(a,e));if(null!=d)if(d instanceof b.mwg.core.task.CoreTaskResult)for(c=0;c<d.size();c++){var f=d.get(c);f instanceof b.mwg.plugin.AbstractNode?e.add(f.graph().cloneNode(f)):e.add(f)}else d instanceof b.mwg.plugin.AbstractNode?(f=d,e.add(f.graph().cloneNode(f))):e.add(d)};c.prototype.globalVariables=function(){return this._globalVariables};
c.prototype.nextVariables=function(){return this._globalVariables};c.prototype.variables=function(){return this._localVariables};c.prototype.result=function(){return this._result};c.prototype.resultAsNodes=function(){return this._result};c.prototype.resultAsStrings=function(){return this._result};c.prototype.continueWith=function(a){var b=this._result;null!=b&&b!=a&&b.free();this._result=a;this.continueTask()};c.prototype.continueTask=function(){null!=this._hook&&this._hook.afterAction(this._current,
this);var a=this._current.next();this._current=a;if(null==a){if(null!=this._localVariables)for(var a=this._localVariables.keySet(),b=a.toArray(Array(a.size())),a=0;a<b.length;a++)this._localVariables.get(b[a]).free();if(null!=this._nextVariables)for(a=this._nextVariables.keySet(),b=a.toArray(Array(a.size())),a=0;a<b.length;a++)this._nextVariables.get(b[a]).free();if(null==this._parent)for(a=this._globalVariables.keySet(),b=a.toArray(Array(a.size())),a=0;a<b.length;a++)this._globalVariables.get(b[a]).free();
null!=this._hook&&(null==this._parent?this._hook.end(this):this._hook.afterTask(this));null!=this._callback?this._callback(this._result):null!=this._result&&this._result.free()}else null!=this._hook&&this._hook.beforeAction(a,this),a.eval(this)};c.prototype.execute=function(a){this._current=a;null!=this._hook&&(null==this._parent?this._hook.start(this):this._hook.beforeTask(this._parent,this),this._hook.beforeAction(this._current,this));this._current.eval(this)};c.prototype.template=function(a){if(null==
a)return null;for(var d=0,c=null,e=-1;d<a.length;){var f=a.charAt(d),g="0",l="0";0<d&&(g=a.charAt(d-1));d+1<a.length&&(l=a.charAt(d+1));if("{"==f&&"{"==g)e=d+1;else if(-1!=e&&"}"==f&&"}"==g){null==c&&(c=new java.lang.StringBuilder,c.append(a.substring(0,e-2)));e=a.substring(e,d-1).trim();if(0<e.length&&"="==e.charAt(0)){e=b.mwg.core.task.math.CoreMathExpressionEngine.parse(e.substring(1)).eval(null,this,new java.util.HashMap)+"";for(f=e.length-1;0<=f;f--)if("."==e.charAt(f)){e=e.substring(0,f);break}else if("0"!=
e.charAt(f))break;c.append(e)}else{g=-1;if("]"==e.charAt(e.length-1)){l=-1;for(f=e.length-3;0<=f;f--)if("["==e.charAt(f)){l=f+1;break}if(-1!=l&&(g=b.mwg.core.task.TaskHelper.parseInt(e.substring(l,e.length-1)),e=e.substring(0,l-1),0>g))throw Error("Array index out of range: "+g);}f=this.variable(e);null==f&&"result"===e&&(f=this.result());if(null!=f)if(1==f.size()||-1!=g)e=-1==g?f.get(0):f.get(g),c.append(e);else{e=f.iterator();c.append("[");f=!0;for(g=e.next();null!=g;)f?f=!1:c.append(","),c.append(g),
g=e.next();c.append("]")}}e=-1}else-1!=e||null==c||"{"==f&&"{"==l||c.append(a.charAt(d));d++}return null==c?a:c.toString()};c.prototype.hook=function(){return this._hook};c.prototype.toString=function(){return"{result:"+this._result.toString()+"}"};return c}();f.CoreTaskContext=e;e=function(){function c(a,d){this._size=this._capacity=0;if(Array.isArray(a))if(this._capacity=this._size=a.length,this._backend=Array(this._size),d)for(var c=0;c<this._size;c++){var e=a[c];this._backend[c]=e instanceof b.mwg.plugin.AbstractNode?
e.graph().cloneNode(e):e}else java.lang.System.arraycopy(a,0,this._backend,0,this._size);else if(a instanceof Float64Array){e=a;this._backend=Array(e.length);for(c=0;c<e.length;c++)this._backend[c]=e[c];this._size=this._capacity=this._backend.length}else if(a instanceof Int32Array){e=a;this._backend=Array(e.length);for(c=0;c<e.length;c++)this._backend[c]=e[c];this._size=this._capacity=this._backend.length}else if(a instanceof Float64Array){e=a;this._backend=Array(e.length);for(c=0;c<e.length;c++)this._backend[c]=
e[c];this._size=this._capacity=this._backend.length}else if(a instanceof java.util.ArrayList){this._backend=Array(a.size());for(c=0;c<a.size();c++)this._backend[c]=a.get(c);this._size=this._capacity=this._backend.length}else if(a instanceof b.mwg.core.task.CoreTaskResult){if(this._size=a._size,this._capacity=a._capacity,null!=a._backend)if(this._backend=Array(a._backend.length),d)for(c=0;c<this._size;c++)e=a._backend[c],this._backend[c]=e instanceof b.mwg.plugin.AbstractNode?e.graph().cloneNode(e):
e;else java.lang.System.arraycopy(a._backend,0,this._backend,0,this._size)}else null!=a&&(this._backend=Array(1),this._size=this._capacity=1,this._backend[0]=a instanceof b.mwg.plugin.AbstractNode?d?a.graph().cloneNode(a):a:a)}c.prototype.asArray=function(){var a=Array(this._size);null!=this._backend&&java.lang.System.arraycopy(this._backend,0,a,0,this._size);return a};c.prototype.iterator=function(){return new b.mwg.core.task.CoreTaskResultIterator(this._backend)};c.prototype.get=function(a){return a<
this._size?this._backend[a]:null};c.prototype.set=function(a,b){a>=this._capacity&&this.extendTil(a);this._backend[a]=b;a>=this._size&&this._size++};c.prototype.allocate=function(a){if(a>=this._capacity)if(null==this._backend)this._backend=Array(a),this._capacity=a;else throw Error("Not implemented yet!!!");};c.prototype.add=function(a){this._size>=this._capacity&&this.extendTil(this._size);this.set(this._size,a)};c.prototype.clear=function(){this._backend=null;this._size=this._capacity=0};c.prototype.clone=
function(){return new b.mwg.core.task.CoreTaskResult(this,!0)};c.prototype.free=function(){for(var a=0;a<this._capacity;a++)this._backend[a]instanceof b.mwg.plugin.AbstractNode&&this._backend[a].free()};c.prototype.size=function(){return this._size};c.prototype.extendTil=function(a){if(this._capacity<=a){var b=2*this._capacity;b<=a&&(b=a+1);a=Array(b);null!=this._backend&&java.lang.System.arraycopy(this._backend,0,a,0,this._size);this._backend=a;this._capacity=b}};c.prototype.toString=function(){return this.toJson(!0)};
c.prototype.toJson=function(a){a=new java.lang.StringBuilder;a.append("[");for(var b=0;b<this._size;b++){0!=b&&a.append(",");var c=this._backend[b];null!=c&&a.append(c.toString())}a.append("]");return a.toString()};return c}();f.CoreTaskResult=e;e=function(){function c(a){this._current=new java.util.concurrent.atomic.AtomicInteger(0);this._backend=null!=a?a:[];this._size=this._backend.length}c.prototype.next=function(){var a=this._current.getAndIncrement();return a<this._size?this._backend[a]:null};
c.prototype.nextWithIndex=function(){var a=this._current.getAndIncrement();return a<this._size?null!=this._backend[a]?new b.mwg.utility.Tuple(a,this._backend[a]):null:null};return c}();f.CoreTaskResultIterator=e;e=function(){function c(){}c.flatNodes=function(a,d){if(a instanceof b.mwg.plugin.AbstractNode)return[a];if(Array.isArray(a)){for(var c=[],e=0;e<a.length;e++)if(a[e]instanceof b.mwg.plugin.AbstractNode){var f=Array(c.length+1);java.lang.System.arraycopy(c,0,f,0,c.length);f[c.length]=a[e];
c=f}else if(Array.isArray(a[e])){var g=b.mwg.core.task.TaskHelper.flatNodes(a[e],d),f=Array(c.length+g.length);java.lang.System.arraycopy(c,0,f,0,c.length);java.lang.System.arraycopy(g,0,f,c.length,g.length);c=f}else if(d)throw Error("[ActionIndexOrUnindexNode] The array in result contains an element with wrong type. Expected type: AbstractNode. Actual type: "+a[e]);return c}if(d)throw Error("[ActionIndexOrUnindexNode] Wrong type of result. Expected type is AbstractNode or an array of AbstractNode.Actual type is "+
a);return[]};c.parseInt=function(a){return parseInt(a)};return c}();f.TaskHelper=e;(function(c){var a=function(){function a(b){this._cacheAST=this.buildAST(this.shuntingYard(b))}a.parse=function(a){return new b.mwg.core.task.math.CoreMathExpressionEngine(a)};a.isNumber=function(a){return!isNaN(+a)};a.isDigit=function(a){a=a.charCodeAt(0);return 48<=a&&57>=a?!0:!1};a.isLetter=function(a){a=a.charCodeAt(0);return 65<=a&&90>=a||97<=a&&122>=a?!0:!1};a.isWhitespace=function(a){a=a.charCodeAt(0);return 9<=
a&&13>=a||32==a||133==a||160==a?!0:!1};a.prototype.shuntingYard=function(a){var c=new java.util.ArrayList,d=new java.util.Stack;a=new b.mwg.core.task.math.MathExpressionTokenizer(a);for(var e=null,f=null;a.hasNext();){var h=a.next();if(b.mwg.core.task.math.MathEntities.getINSTANCE().functions.keySet().contains(h.toUpperCase()))d.push(h),e=h;else if(","===h){for(;!d.isEmpty()&&"("!==d.peek();)c.add(d.pop());if(d.isEmpty())throw Error("Parse error for function '"+e+"'");}else if(b.mwg.core.task.math.MathEntities.getINSTANCE().operators.keySet().contains(h)){for(var f=
b.mwg.core.task.math.MathEntities.getINSTANCE().operators.get(h),n=d.isEmpty()?null:d.peek();b.mwg.core.task.math.MathEntities.getINSTANCE().operators.keySet().contains(n)&&(f.isLeftAssoc()&&f.getPrecedence()<=b.mwg.core.task.math.MathEntities.getINSTANCE().operators.get(n).getPrecedence()||f.getPrecedence()<b.mwg.core.task.math.MathEntities.getINSTANCE().operators.get(n).getPrecedence());)c.add(d.pop()),n=d.isEmpty()?null:d.peek();d.push(h)}else if("("===h){if(null!=f&&b.mwg.core.task.math.CoreMathExpressionEngine.isNumber(f))throw Error("Missing operator at character position "+
a.getPos());d.push(h)}else if(")"===h){for(;!d.isEmpty()&&"("!==d.peek();)c.add(d.pop());if(d.isEmpty())throw Error("Mismatched parentheses");d.pop();!d.isEmpty()&&b.mwg.core.task.math.MathEntities.getINSTANCE().functions.keySet().contains(d.peek().toUpperCase())&&c.add(d.pop())}else c.add(h);f=h}for(;!d.isEmpty();){a=d.pop();if("("===a||")"===a)throw Error("Mismatched parentheses");c.add(a)}return c};a.prototype.eval=function(a,b,d){if(null==this._cacheAST)throw Error("Call parse before");for(var c=
new java.util.Stack,e=0;e<this._cacheAST.length;e++){var f=this._cacheAST[e];switch(f.type()){case 0:var n=c.pop(),p=c.pop();c.push(f.eval(p,n));break;case 1:n=f;p=new Float64Array(n.getNumParams());for(f=n.getNumParams()-1;0<=f;f--)p[f]=c.pop();c.push(n.eval(p));break;case 2:c.push(f.content());break;case 3:if(n=f,f=null,null!=d&&(f=d.get(n.content())),null!=f)c.push(f);else if("TIME"===n.content())c.push(a.time());else{var q=n.content().trim(),t=p=null;null!=a&&(0<q.length&&"{"==q.charAt(0)&&"}"==
q.charAt(q.length-1)?(p=a.get(n.content().substring(1,q.length-1)),t=n.content().substring(1,q.length-1)):(p=a.get(n.content()),t=n.content()),0<t.length&&"$"==t.charAt(0)&&(t=t.substring(1)));if(null!=b&&null==p)if("]"==q.charAt(q.length-1)){for(var E=-1,x=-1,f=q.length-3;0<=f;f--)if("["==q.charAt(f)){E=f+1;break}-1!=E&&(x=this.parseInt(q.substring(E,q.length-1)),q=q.substring(0,E-1));f=b.variable(q);null==f&&"result"===q&&(f=b.result());null!=f&&f.size()>x&&(p=f.get(x))}else f=b.variable(q),null==
f&&"result"===q&&(f=b.result()),null!=f&&(p=f.get(0));if(null!=p)if(f=this.parseDouble(p.toString()),d.put(t,f),n=p.toString(),"true"===n)c.push(1);else if("false"===n)c.push(0);else try{c.push(f)}catch(z){if(!(z instanceof Error))throw z;}else throw Error("Unknow variable for name "+n.content());}}}a=c.pop();return null==a?0:a};a.prototype.buildAST=function(a){for(var c=Array(a.size()),d=0;d<a.size();d++){var e=a.get(d);if(b.mwg.core.task.math.MathEntities.getINSTANCE().operators.keySet().contains(e))c[d]=
b.mwg.core.task.math.MathEntities.getINSTANCE().operators.get(e);else if(b.mwg.core.task.math.MathEntities.getINSTANCE().functions.keySet().contains(e.toUpperCase()))c[d]=b.mwg.core.task.math.MathEntities.getINSTANCE().functions.get(e.toUpperCase());else if(0<e.length&&b.mwg.core.task.math.CoreMathExpressionEngine.isLetter(e.charAt(0)))c[d]=new b.mwg.core.task.math.MathFreeToken(e);else try{var f=this.parseDouble(e);c[d]=new b.mwg.core.task.math.MathDoubleToken(f)}catch(h){if(h instanceof Error)c[d]=
new b.mwg.core.task.math.MathFreeToken(e);else throw h;}}return c};a.prototype.parseDouble=function(a){return parseFloat(a)};a.prototype.parseInt=function(a){return parseInt(a)};a.decimalSeparator=".";a.minusSign="-";return a}();c.CoreMathExpressionEngine=a;a=function(){function a(c){this._expression=c;this._engine=b.mwg.core.task.math.CoreMathExpressionEngine.parse(c)}a.prototype.conditional=function(){var a=this;return function(b){var c=new java.util.HashMap;c.put("PI",Math.PI);c.put("TRUE",1);
c.put("FALSE",0);return.5<=a._engine.eval(null,b,c)}};a.prototype.toString=function(){return"cond('"+this._expression+"')"};return a}();c.MathConditional=a;a=function(){function a(b){this._content=b}a.prototype.type=function(){return 2};a.prototype.content=function(){return this._content};return a}();c.MathDoubleToken=a;a=function(){function a(){this.operators=new java.util.HashMap;this.operators.put("+",new b.mwg.core.task.math.MathOperation("+",20,!0));this.operators.put("-",new b.mwg.core.task.math.MathOperation("-",
20,!0));this.operators.put("*",new b.mwg.core.task.math.MathOperation("*",30,!0));this.operators.put("/",new b.mwg.core.task.math.MathOperation("/",30,!0));this.operators.put("%",new b.mwg.core.task.math.MathOperation("%",30,!0));this.operators.put("^",new b.mwg.core.task.math.MathOperation("^",40,!1));this.operators.put("&&",new b.mwg.core.task.math.MathOperation("&&",4,!1));this.operators.put("||",new b.mwg.core.task.math.MathOperation("||",2,!1));this.operators.put(">",new b.mwg.core.task.math.MathOperation(">",
10,!1));this.operators.put(">=",new b.mwg.core.task.math.MathOperation(">=",10,!1));this.operators.put("<",new b.mwg.core.task.math.MathOperation("<",10,!1));this.operators.put("<=",new b.mwg.core.task.math.MathOperation("<=",10,!1));this.operators.put("==",new b.mwg.core.task.math.MathOperation("==",7,!1));this.operators.put("!=",new b.mwg.core.task.math.MathOperation("!=",7,!1));this.functions=new java.util.HashMap;this.functions.put("NOT",new b.mwg.core.task.math.MathFunction("NOT",1));this.functions.put("IF",
new b.mwg.core.task.math.MathFunction("IF",3));this.functions.put("RAND",new b.mwg.core.task.math.MathFunction("RAND",0));this.functions.put("SIN",new b.mwg.core.task.math.MathFunction("SIN",1));this.functions.put("COS",new b.mwg.core.task.math.MathFunction("COS",1));this.functions.put("TAN",new b.mwg.core.task.math.MathFunction("TAN",1));this.functions.put("ASIN",new b.mwg.core.task.math.MathFunction("ASIN",1));this.functions.put("ACOS",new b.mwg.core.task.math.MathFunction("ACOS",1));this.functions.put("ATAN",
new b.mwg.core.task.math.MathFunction("ATAN",1));this.functions.put("MAX",new b.mwg.core.task.math.MathFunction("MAX",2));this.functions.put("MIN",new b.mwg.core.task.math.MathFunction("MIN",2));this.functions.put("ABS",new b.mwg.core.task.math.MathFunction("ABS",1));this.functions.put("LOG",new b.mwg.core.task.math.MathFunction("LOG",1));this.functions.put("ROUND",new b.mwg.core.task.math.MathFunction("ROUND",2));this.functions.put("FLOOR",new b.mwg.core.task.math.MathFunction("FLOOR",1));this.functions.put("CEILING",
new b.mwg.core.task.math.MathFunction("CEILING",1));this.functions.put("SQRT",new b.mwg.core.task.math.MathFunction("SQRT",1));this.functions.put("SECONDS",new b.mwg.core.task.math.MathFunction("SECONDS",1));this.functions.put("MINUTES",new b.mwg.core.task.math.MathFunction("MINUTES",1));this.functions.put("HOURS",new b.mwg.core.task.math.MathFunction("HOURS",1));this.functions.put("DAY",new b.mwg.core.task.math.MathFunction("DAY",1));this.functions.put("MONTH",new b.mwg.core.task.math.MathFunction("MONTH",
1));this.functions.put("YEAR",new b.mwg.core.task.math.MathFunction("YEAR",1));this.functions.put("DAYOFWEEK",new b.mwg.core.task.math.MathFunction("DAYOFWEEK",1))}a.getINSTANCE=function(){null==a.INSTANCE&&(a.INSTANCE=new b.mwg.core.task.math.MathEntities);return a.INSTANCE};a.INSTANCE=null;return a}();c.MathEntities=a;a=function(){function a(b){this.pos=0;this.input=b.trim()}a.prototype.hasNext=function(){return this.pos<this.input.length};a.prototype.peekNextChar=function(){return this.pos<this.input.length-
1?this.input.charAt(this.pos+1):"\x00"};a.prototype.next=function(){var a=new java.lang.StringBuilder;if(this.pos>=this.input.length)return this.previousToken=null;for(var c=this.input.charAt(this.pos);b.mwg.core.task.math.CoreMathExpressionEngine.isWhitespace(c)&&this.pos<this.input.length;)c=this.input.charAt(++this.pos);if(b.mwg.core.task.math.CoreMathExpressionEngine.isDigit(c))for(;(b.mwg.core.task.math.CoreMathExpressionEngine.isDigit(c)||c==b.mwg.core.task.math.CoreMathExpressionEngine.decimalSeparator)&&
this.pos<this.input.length;)a.append(this.input.charAt(this.pos++)),c=this.pos==this.input.length?"\x00":this.input.charAt(this.pos);else if(c==b.mwg.core.task.math.CoreMathExpressionEngine.minusSign&&b.mwg.core.task.math.CoreMathExpressionEngine.isDigit(this.peekNextChar())&&("("===this.previousToken||","===this.previousToken||null==this.previousToken||b.mwg.core.task.math.MathEntities.getINSTANCE().operators.keySet().contains(this.previousToken)))a.append(b.mwg.core.task.math.CoreMathExpressionEngine.minusSign),
this.pos++,a.append(this.next());else if(b.mwg.core.task.math.CoreMathExpressionEngine.isLetter(c)||"_"==c||"{"==c||"}"==c||"$"==c){for(;(b.mwg.core.task.math.CoreMathExpressionEngine.isLetter(c)||b.mwg.core.task.math.CoreMathExpressionEngine.isDigit(c)||"_"==c||"{"==c||"}"==c||"$"==c)&&this.pos<this.input.length;)a.append(this.input.charAt(this.pos++)),c=this.pos==this.input.length?"\x00":this.input.charAt(this.pos);if(this.pos<this.input.length&&"["==this.input.charAt(this.pos)){a.append(this.input.charAt(this.pos++));
for(c=this.pos==this.input.length?"\x00":this.input.charAt(this.pos);b.mwg.core.task.math.CoreMathExpressionEngine.isDigit(c)&&this.pos<this.input.length;)a.append(this.input.charAt(this.pos++)),c=this.pos==this.input.length?"\x00":this.input.charAt(this.pos);if("]"!=this.input.charAt(this.pos))throw Error("Error in array definition '"+a+"' at position "+(this.pos-a.length+1));a.append(this.input.charAt(this.pos++))}}else if("("==c||")"==c||","==c)a.append(c),this.pos++;else{for(;!b.mwg.core.task.math.CoreMathExpressionEngine.isLetter(c)&&
!b.mwg.core.task.math.CoreMathExpressionEngine.isDigit(c)&&"_"!=c&&!b.mwg.core.task.math.CoreMathExpressionEngine.isWhitespace(c)&&"("!=c&&")"!=c&&","!=c&&"{"!=c&&"}"!=c&&"$"!=c&&this.pos<this.input.length&&(a.append(this.input.charAt(this.pos)),this.pos++,c=this.pos==this.input.length?"\x00":this.input.charAt(this.pos),c!=b.mwg.core.task.math.CoreMathExpressionEngine.minusSign););if(!b.mwg.core.task.math.MathEntities.getINSTANCE().operators.keySet().contains(a.toString()))throw Error("Unknown operator '"+
a+"' at position "+(this.pos-a.length+1));}return this.previousToken=a.toString()};a.prototype.getPos=function(){return this.pos};return a}();c.MathExpressionTokenizer=a;a=function(){function a(b){this._content=b}a.prototype.content=function(){return this._content};a.prototype.type=function(){return 3};return a}();c.MathFreeToken=a;a=function(){function a(b,c){this.name=b.toUpperCase();this.numParams=c}a.prototype.getName=function(){return this.name};a.prototype.getNumParams=function(){return this.numParams};
a.prototype.eval=function(a){if("NOT"===this.name)return 0==a[0]?1:0;if("IF"===this.name)return 0!=a[0]?a[1]:a[2];if("RAND"===this.name)return Math.random();if("SIN"===this.name)return Math.sin(a[0]);if("COS"===this.name)return Math.cos(a[0]);if("TAN"===this.name)return Math.tan(a[0]);if("ASIN"===this.name)return Math.asin(a[0]);if("ACOS"===this.name)return Math.acos(a[0]);if("ATAN"===this.name)return Math.atan(a[0]);if("MAX"===this.name)return a[0]>a[1]?a[0]:a[1];if("MIN"===this.name)return a[0]<
a[1]?a[0]:a[1];if("ABS"===this.name)return Math.abs(a[0]);if("LOG"===this.name)return Math.log(a[0]);if("ROUND"===this.name){var b=Math.pow(10,a[1]);return Math.round(a[0]*b)/b}return"FLOOR"===this.name?Math.floor(a[0]):"CEILING"===this.name?Math.ceil(a[0]):"SQRT"===this.name?Math.sqrt(a[0]):"SECONDS"===this.name?this.date_to_seconds(a[0]):"MINUTES"===this.name?this.date_to_minutes(a[0]):"HOURS"===this.name?this.date_to_hours(a[0]):"DAY"===this.name?this.date_to_days(a[0]):"MONTH"===this.name?this.date_to_months(a[0]):
"YEAR"===this.name?this.date_to_year(a[0]):"DAYOFWEEK"===this.name?this.date_to_dayofweek(a[0]):0};a.prototype.date_to_seconds=function(a){return(new Date(a)).getSeconds()};a.prototype.date_to_minutes=function(a){return(new Date(a)).getMinutes()};a.prototype.date_to_hours=function(a){return(new Date(a)).getHours()};a.prototype.date_to_days=function(a){return(new Date(a)).getDate()};a.prototype.date_to_months=function(a){return(new Date(a)).getMonth()};a.prototype.date_to_year=function(a){return(new Date(a)).getFullYear()};
a.prototype.date_to_dayofweek=function(a){return(new Date(a)).getDay()};a.prototype.type=function(){return 1};return a}();c.MathFunction=a;a=function(){function a(b,c,d){this.oper=b;this.precedence=c;this.leftAssoc=d}a.prototype.getOper=function(){return this.oper};a.prototype.getPrecedence=function(){return this.precedence};a.prototype.isLeftAssoc=function(){return this.leftAssoc};a.prototype.eval=function(a,b){return"+"===this.oper?a+b:"-"===this.oper?a-b:"*"===this.oper?a*b:"/"===this.oper?a/b:
"%"===this.oper?a%b:"^"===this.oper?Math.pow(a,b):"&&"===this.oper?0!=a&&0!=b?1:0:"||"===this.oper?0!=a||0!=b?1:0:">"===this.oper?a>b?1:0:">="===this.oper?a>=b?1:0:"<"===this.oper?a<b?1:0:"<="===this.oper?a<=b?1:0:"=="===this.oper?a==b?1:0:"!="===this.oper?a!=b?1:0:0};a.prototype.type=function(){return 0};return a}();c.MathOperation=a})(f.math||(f.math={}))})(f.task||(f.task={}));(function(b){var e=function(){function b(a){this._counter=a;this._nb_down=new java.util.concurrent.atomic.AtomicInteger(0)}
b.prototype.count=function(){var a,b;do a=this._nb_down.get(),b=a+1;while(!this._nb_down.compareAndSet(a,b));b==this._counter&&null!=this._end&&this._end()};b.prototype.getCount=function(){return this._nb_down.get()};b.prototype.then=function(a){this._end=a;this._nb_down.get()==this._counter&&null!=a&&a()};b.prototype.wrap=function(){var a=this;return function(b){a.count()}};return b}();b.CoreDeferCounter=e;e=function(){function b(a){this._result=null;this._counter=a;this._nb_down=new java.util.concurrent.atomic.AtomicInteger(0)}
b.prototype.count=function(){this._nb_down.set(this._nb_down.get()+1);this._nb_down.get()==this._counter&&null!=this._end&&this._end()};b.prototype.getCount=function(){return this._nb_down.get()};b.prototype.then=function(a){this._end=a;this._nb_down.get()==this._counter&&null!=a&&a()};b.prototype.wrap=function(){var a=this;return function(b){a._result=b;a.count()}};b.prototype.waitResult=function(){for(;this._nb_down.get()!=this._counter;);return this._result};return b}();b.CoreDeferCounterSync=
e;e=function(){function b(a){this.wrapped=a}b.prototype.get=function(a,b){this.wrapped.get(a,b)};b.prototype.put=function(a,b){console.error("WARNING: PUT TO A READ ONLY STORAGE")};b.prototype.remove=function(a,b){console.error("WARNING: REMOVE TO A READ ONLY STORAGE")};b.prototype.connect=function(a,b){this.wrapped.connect(a,b)};b.prototype.disconnect=function(a){this.wrapped.disconnect(a)};b.prototype.lock=function(a){this.wrapped.lock(a)};b.prototype.unlock=function(a,b){this.wrapped.unlock(a,
b)};return b}();b.ReadOnlyStorage=e})(f.utility||(f.utility={}))})(f.core||(f.core={}))})(b.mwg||(b.mwg={}))})(org||(org={}));
