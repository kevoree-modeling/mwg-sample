var __extends=this&&this.__extends||function(d,v){function x(){this.constructor=d}for(var B in v)v.hasOwnProperty(B)&&(d[B]=v[B]);d.prototype=null===v?Object.create(v):(x.prototype=v.prototype,new x)},org;
(function(d){(function(v){(function(x){var v=function(){function u(){}u.nTreeInsertTo=function(r){return d.mwg.task.Actions.newTask().action(d.mwg.structure.action.NTreeInsertTo.NAME,r)};u.nTreeNearestN=function(r){return d.mwg.task.Actions.newTask().action(d.mwg.structure.action.NTreeNearestN.NAME,r)};u.nTreeNearestWithinRadius=function(r){return d.mwg.task.Actions.newTask().action(d.mwg.structure.action.NTreeNearestWithinRadius.NAME,r)};u.nTreeNearestNWithinRadius=function(r){return d.mwg.task.Actions.newTask().action(d.mwg.structure.action.NTreeNearestNWithinRadius.NAME,
r)};return u}();x.StructureActions=v;v=function(u){function r(){u.call(this);this.declareNodeType(d.mwg.structure.tree.KDTree.NAME,function(e,a,c,b){return new d.mwg.structure.tree.KDTree(e,a,c,b)});this.declareNodeType(d.mwg.structure.tree.NDTree.NAME,function(e,a,c,b){return new d.mwg.structure.tree.NDTree(e,a,c,b)});this.declareNodeType(d.mwg.structure.tree.NDTree2.NAME,function(e,a,c,b){return new d.mwg.structure.tree.NDTree2(e,a,c,b)});this.declareTaskAction(d.mwg.structure.action.NTreeInsertTo.NAME,
function(e){if(1!=e.length)throw Error("Bad param number!");return new d.mwg.structure.action.NTreeInsertTo(e[0])});this.declareTaskAction(d.mwg.structure.action.TraverseById.NAME,function(e){if(1!=e.length)throw Error("Bad param number!");return new d.mwg.structure.action.TraverseById(e[0])});this.declareTaskAction(d.mwg.structure.action.NTreeNearestN.NAME,function(e){if(2>e.length)throw Error("Bad param number!");for(var a=java.lang.Integer.parseInt(e[e.length-1]),c=new Float64Array(e.length-1),
b=0;b<e.length-1;b++)c[b]=parseFloat(e[b]);return new d.mwg.structure.action.NTreeNearestN(c,a)});this.declareTaskAction(d.mwg.structure.action.NTreeNearestWithinRadius.NAME,function(e){if(2>e.length)throw Error("Bad param number!");for(var a=parseFloat(e[e.length-1]),c=new Float64Array(e.length-1),b=0;b<e.length-1;b++)c[b]=parseFloat(e[b]);return new d.mwg.structure.action.NTreeNearestWithinRadius(c,a)});this.declareTaskAction(d.mwg.structure.action.NTreeNearestNWithinRadius.NAME,function(e){if(3>
e.length)throw Error("Bad param number!");for(var a=parseFloat(e[e.length-1]),c=java.lang.Integer.parseInt(e[e.length-2]),b=new Float64Array(e.length-2),m=0;m<e.length-2;m++)b[m]=parseFloat(e[m]);return new d.mwg.structure.action.NTreeNearestNWithinRadius(b,c,a)})}__extends(r,u);return r}(d.mwg.plugin.AbstractPlugin);x.StructurePlugin=v;(function(u){var r=function(e){function a(a){e.call(this);this._variableName=a}__extends(a,e);a.prototype.eval=function(a){var b=a.result(),m=a.variable(a.template(this._variableName));
if(null!=b&&null!=m){for(var g=a.graph().newCounter(b.size()),b=b.iterator(),f=b.next();null!=f;){if(f instanceof d.mwg.plugin.AbstractNode)for(var k=m.iterator(),n=k.next();null!=n;)n instanceof d.mwg.structure.tree.KDTree||n instanceof d.mwg.structure.tree.NDTree?n.insert(f,function(b){g.count()}):g.count(),n=k.next();else g.count();f=b.next()}g.then(function(){a.continueTask()})}else a.continueTask()};a.prototype.toString=function(){return"nTreeInsertTo('"+this._variableName+"')"};a.NAME="nTreeInsertTo";
return a}(d.mwg.plugin.AbstractTaskAction);u.NTreeInsertTo=r;r=function(e){function a(a,b){e.call(this);this._key=a;this._n=b}__extends(a,e);a.prototype.eval=function(a){var b=a.result(),m=a.newResult();if(null!=b){for(var g=a.graph().newCounter(b.size()),b=b.iterator(),f=b.next();null!=f;)f instanceof d.mwg.structure.tree.KDTree||f instanceof d.mwg.structure.tree.NDTree?f.nearestN(this._key,this._n,function(a){for(var b=0;b<a.length;b++)null!=a[b]&&m.add(a[b]);g.count()}):g.count(),f=b.next();g.then(function(){a.continueWith(m)})}else a.continueWith(m)};
a.prototype.toString=function(){return"nTreeNearestN('')"};a.NAME="nTreeNearestN";return a}(d.mwg.plugin.AbstractTaskAction);u.NTreeNearestN=r;r=function(e){function a(a,b,m){e.call(this);this._key=a;this._n=b;this._radius=m}__extends(a,e);a.prototype.eval=function(a){var b=a.result(),m=a.newResult();if(null!=b){for(var g=a.graph().newCounter(b.size()),b=b.iterator(),f=b.next();null!=f;)f instanceof d.mwg.structure.tree.KDTree||f instanceof d.mwg.structure.tree.NDTree?f.nearestNWithinRadius(this._key,
this._n,this._radius,function(a){for(var b=0;b<a.length;b++)null!=a[b]&&m.add(a[b]);g.count()}):g.count(),f=b.next();g.then(function(){a.continueWith(m)})}else a.continueWith(m)};a.prototype.toString=function(){return"nTreeNearestNWithinRadius('')"};a.NAME="nTreeNearestNWithinRadius";return a}(d.mwg.plugin.AbstractTaskAction);u.NTreeNearestNWithinRadius=r;r=function(e){function a(a,b){e.call(this);this._key=a;this._radius=b}__extends(a,e);a.prototype.eval=function(a){var b=a.result(),m=a.newResult();
if(null!=b){for(var g=a.graph().newCounter(b.size()),b=b.iterator(),f=b.next();null!=f;)f instanceof d.mwg.structure.tree.KDTree||f instanceof d.mwg.structure.tree.NDTree?f.nearestWithinRadius(this._key,this._radius,function(a){for(var b=0;b<a.length;b++)null!=a[b]&&m.add(a[b]);g.count()}):g.count(),f=b.next();g.then(function(){a.continueWith(m)})}else a.continueWith(m)};a.prototype.toString=function(){return"nTreeNearestWithinRadius('')"};a.NAME="nTreeNearestWithinRadius";return a}(d.mwg.plugin.AbstractTaskAction);
u.NTreeNearestWithinRadius=r;r=function(e){function a(a){e.call(this);this._name=a}__extends(a,e);a.prototype.eval=function(a){var b=a.wrap(null),m=java.lang.Long.parseLong(a.template(this._name)),g=a.result();if(null!=g){for(var f=g.size(),k=a.graph().newCounter(f),e=function(a){var c=g.get(a);c instanceof d.mwg.plugin.AbstractNode?c.relByIndex(m,function(a){if(null!=a)for(var m=0;m<a.length;m++)b.add(a[m]);c.free();k.count()}):(b.add(c),k.count())},l=0;l<f;l++)e(l);k.then(function(){g.clear();a.continueWith(b)})}else a.continueTask()};
a.prototype.toString=function(){return"traverseById('"+this._name+"')"};a.NAME="traverseById";return a}(d.mwg.plugin.AbstractTaskAction);u.TraverseById=r})(x.action||(x.action={}));(function(u){var r=function(){function e(){}e.instance=function(){null==e.static_instance&&(e.static_instance=new d.mwg.structure.distance.CosineDistance);return e.static_instance};e.prototype.measure=function(a,c){for(var b=0,m=0,d=0,f=0;f<a.length;f++)b+=a[f]*c[f],m+=a[f]*a[f],d+=c[f]*c[f];b/=Math.sqrt(m)*Math.sqrt(d);
0>b&&(b=0);return 1-b};e.prototype.compare=function(a,c){return a<c};e.prototype.getMinValue=function(){return 0};e.prototype.getMaxValue=function(){return java.lang.Double.MAX_VALUE};e.static_instance=null;return e}();u.CosineDistance=r;r=function(){function d(){}d.EUCLIDEAN=0;d.GEODISTANCE=1;d.COSINE=2;return d}();u.Distances=r;r=function(){function e(){}e.instance=function(){null==e.static_instance&&(e.static_instance=new d.mwg.structure.distance.EuclideanDistance);return e.static_instance};e.prototype.measure=
function(a,c){for(var b=0,m=0;m<a.length;m++)b+=(a[m]-c[m])*(a[m]-c[m]);return Math.sqrt(b)};e.prototype.compare=function(a,c){return a<c};e.prototype.getMinValue=function(){return 0};e.prototype.getMaxValue=function(){return java.lang.Double.MAX_VALUE};e.static_instance=null;return e}();u.EuclideanDistance=r;r=function(){function e(){}e.instance=function(){null==e.static_instance&&(e.static_instance=new d.mwg.structure.distance.GeoDistance);return e.static_instance};e.prototype.measure=function(a,
c){var b=d.mwg.structure.distance.GeoDistance.toRadians(c[0]-a[0]),m=d.mwg.structure.distance.GeoDistance.toRadians(c[1]-a[1]),b=Math.sin(b/2)*Math.sin(b/2)+Math.cos(d.mwg.structure.distance.GeoDistance.toRadians(a[0]))*Math.cos(d.mwg.structure.distance.GeoDistance.toRadians(c[0]))*Math.sin(m/2)*Math.sin(m/2);return 12742E3*Math.atan2(Math.sqrt(b),Math.sqrt(1-b))};e.toRadians=function(a){return a*Math.PI/180};e.prototype.compare=function(a,c){return a<c};e.prototype.getMinValue=function(){return 0};
e.prototype.getMaxValue=function(){return java.lang.Double.MAX_VALUE};e.static_instance=null;return e}();u.GeoDistance=r;r=function(){function e(){}e.instance=function(){null==e.static_instance&&(e.static_instance=new d.mwg.structure.distance.PearsonDistance);return e.static_instance};e.prototype.measure=function(a,c){for(var b=0,m=0,d=0,f=0,k=0,e=0;e<a.length;e++)b+=a[e]*c[e],m+=a[e],f+=c[e],d+=a[e]*a[e],k+=c[e]*c[e];e=a.length;return(b-m*f/e)/Math.sqrt((d-m*m/e)*(k-f*f/e))};e.prototype.compare=
function(a,c){return Math.abs(a)>Math.abs(c)};e.prototype.getMinValue=function(){return 1};e.prototype.getMaxValue=function(){return 0};e.static_instance=null;return e}();u.PearsonDistance=r})(x.distance||(x.distance={}));(function(u){var r=function(e){function a(a,b,m,d){e.call(this,a,b,m,d)}__extends(a,e);a.initFindNear=function(){var a=d.mwg.task.Actions.newTask();a.then(function(a){var c=a.resultAsNodes().get(0);if(null!=c){var g=c.get(d.mwg.structure.tree.KDTree.KEY),f=a.variable("dim").get(0),
k=a.variable("key").get(0),e=a.variable("distance").get(0),l=a.variable("lev").get(0),h=a.variable("hr").get(0),p=a.variable("max_dist_sqd").get(0),q=l%f,e=e.measure(g,k),f=h.clone();h.max[q]=g[q];f.min[q]=g[q];k[q]<g[q]?(g=c.get(d.mwg.structure.tree.KDTree.LEFT),q=d.mwg.structure.tree.KDTree.LEFT,k=h,c=c.get(d.mwg.structure.tree.KDTree.RIGHT),h=f,f=d.mwg.structure.tree.KDTree.RIGHT):(g=c.get(d.mwg.structure.tree.KDTree.RIGHT),k=f,q=d.mwg.structure.tree.KDTree.RIGHT,c=c.get(d.mwg.structure.tree.KDTree.LEFT),
f=d.mwg.structure.tree.KDTree.LEFT);a.defineVariable("further_hr",h);a.defineVariable("pivot_to_target",e);null!=g&&0!=g.size()?(a.defineVariable("near",q),a.defineVariableForSubTask("hr",k),a.defineVariableForSubTask("max_dist_sqd",p),a.defineVariableForSubTask("lev",l+1)):a.defineVariableForSubTask("near",a.newResult());null!=c&&0!=c.size()?a.defineVariableForSubTask("far",f):a.defineVariableForSubTask("far",a.newResult())}a.continueTask()}).isolate(d.mwg.task.Actions.ifThen(function(a){return 0<
a.variable("near").size()},d.mwg.task.Actions.traverse("{{near}}").isolate(a))).then(function(a){var c=a.variable("nnl").get(0),g=a.variable("key").get(0),f=a.variable("distance").get(0),k=a.variable("max_dist_sqd").get(0),e=a.variable("further_hr").get(0),l=a.variable("pivot_to_target").get(0),h=a.variable("lev").get(0),p=a.resultAsNodes().get(0),q;q=c.isCapacityReached()?c.getMaxPriority():java.lang.Double.MAX_VALUE;var t=Math.min(k,q),w=e.closest(g);f.measure(w,g)<k?(l<q&&(q=l,c.insert(p.get(d.mwg.structure.tree.KDTree.VALUE).get(0),
q),p.get(d.mwg.structure.tree.KDTree.KEY),t=c.isCapacityReached()?c.getMaxPriority():java.lang.Double.MAX_VALUE),a.defineVariableForSubTask("hr",e),a.defineVariableForSubTask("max_dist_sqd",t),a.defineVariableForSubTask("lev",h+1),a.defineVariable("continueFar",!0)):a.defineVariable("continueFar",!1);a.continueTask()}).isolate(d.mwg.task.Actions.ifThen(function(a){return a.variable("continueFar").get(0)&&0<a.variable("far").size()},d.mwg.task.Actions.traverse("{{far}}").isolate(a)));return a};a.initFindRadius=
function(){var a=d.mwg.task.Actions.newTask();a.then(function(a){var c=a.resultAsNodes().get(0);if(null!=c){var g=c.get(d.mwg.structure.tree.KDTree.KEY),f=a.variable("dim").get(0),k=a.variable("key").get(0),e=a.variable("distance").get(0),l=a.variable("lev").get(0),h=a.variable("hr").get(0),p=a.variable("max_dist_sqd").get(0),q=l%f,e=e.measure(g,k),f=h.clone();h.max[q]=g[q];f.min[q]=g[q];k[q]<g[q]?(g=c.get(d.mwg.structure.tree.KDTree.LEFT),q=d.mwg.structure.tree.KDTree.LEFT,k=h,c=c.get(d.mwg.structure.tree.KDTree.RIGHT),
h=f,f=d.mwg.structure.tree.KDTree.RIGHT):(g=c.get(d.mwg.structure.tree.KDTree.RIGHT),k=f,q=d.mwg.structure.tree.KDTree.RIGHT,c=c.get(d.mwg.structure.tree.KDTree.LEFT),f=d.mwg.structure.tree.KDTree.LEFT);a.defineVariable("further_hr",h);a.defineVariable("pivot_to_target",e);null!=g&&0!=g.size()?(a.defineVariable("near",q),a.defineVariableForSubTask("hr",k),a.defineVariableForSubTask("max_dist_sqd",p),a.defineVariableForSubTask("lev",l+1)):a.defineVariableForSubTask("near",a.newResult());null!=c&&0!=
c.size()?a.defineVariableForSubTask("far",f):a.defineVariableForSubTask("far",a.newResult())}a.continueTask()}).isolate(d.mwg.task.Actions.ifThen(function(a){return 0<a.variable("near").size()},d.mwg.task.Actions.traverse("{{near}}").isolate(a))).then(function(a){var c=a.variable("nnl").get(0),g=a.variable("key").get(0),f=a.variable("distance").get(0),k=a.variable("radius").get(0),e=a.variable("max_dist_sqd").get(0),l=a.variable("further_hr").get(0),h=a.variable("pivot_to_target").get(0),p=a.variable("lev").get(0),
q=a.resultAsNodes().get(0),t=java.lang.Double.MAX_VALUE,w=Math.min(e,t),D=l.closest(g);f.measure(D,g)<e?(h<t&&(t=h,t<=k&&c.insert(q.get(d.mwg.structure.tree.KDTree.VALUE).get(0),t),w=java.lang.Double.MAX_VALUE),a.defineVariableForSubTask("hr",l),a.defineVariableForSubTask("max_dist_sqd",w),a.defineVariableForSubTask("lev",p+1),a.defineVariable("continueFar",!0)):a.defineVariable("continueFar",!1);a.continueTask()}).isolate(d.mwg.task.Actions.ifThen(function(a){return a.variable("continueFar").get(0)&&
0<a.variable("far").size()},d.mwg.task.Actions.traverse("{{far}}").isolate(a)));return a};a.prototype.setProperty=function(c,b,m){a.enforcer.check(c,b,m);e.prototype.setProperty.call(this,c,b,m)};a.prototype.insert=function(a,b){var m=this;this.extractFeatures(a,function(d){m.insertWith(d,a,b)})};a.prototype.insertWith=function(c,b,m){var d=this.unphasedState(),f=d.getFromKeyWithDefault(a.DIMENSIONS,c.length),k=d.getFromKeyWithDefault(a.DISTANCE_THRESHOLD,a.DISTANCE_THRESHOLD_DEF);if(c.length!=f)throw Error("Key size should always be the same");
if(null==b)throw Error("To index node should not be null");var d=this.getDistance(d),e=a.insert.prepareWith(this.graph(),this,function(a){a.free();null!=m&&m(!0)}),l=e.newResult();l.add(c);e.setGlobalVariable("key",l);e.setGlobalVariable("value",b);e.setGlobalVariable("root",this);e.setGlobalVariable("distance",d);e.setGlobalVariable("dim",f);e.setGlobalVariable("err",k);e.defineVariable("lev",0);a.insert.executeUsing(e)};a.prototype.size=function(){return this.graph().resolver().resolveState(this).getFromKeyWithDefault(a.SIZE,
0)};a.prototype.setDistance=function(c){this.set(a.DISTANCE,c)};a.prototype.setFrom=function(c){this.set(a.FROM,c)};a.prototype.nearestNWithinRadius=function(c,b,m,g){var f=this,k=this.unphasedState(),e=k.getFromKeyWithDefault(a.DIMENSIONS,c.length);if(c.length!=e)throw Error("Key size should always be the same");var l=d.mwg.structure.util.HRect.infiniteHRect(c.length),h=java.lang.Double.MAX_VALUE,p=new d.mwg.structure.util.NearestNeighborList(b);b=this.getDistance(k);var k=a.nearestTask.prepareWith(this.graph(),
this,function(a){var c=p.getAllNodesWithin(m);if(0!=c.length){a=d.mwg.task.Actions.setWorld(java.lang.String.valueOf(f.world())).setTime(java.lang.String.valueOf(f.time())).fromVar("res").lookupAll("{{result}}");var b=a.prepareWith(f.graph(),null,function(a){for(var c=Array(a.size()),b=0;b<a.size();b++)c[b]=a.get(b);g(c)}),c=b.wrap(c);b.addToGlobalVariable("res",c);a.executeUsing(b)}else g([])}),q=k.newResult();q.add(c);k.setGlobalVariable("key",q);k.setGlobalVariable("distance",b);k.setGlobalVariable("dim",
e);k.setGlobalVariable("nnl",p);k.defineVariable("lev",0);k.defineVariable("hr",l);k.defineVariable("max_dist_sqd",h);a.nearestTask.executeUsing(k)};a.prototype.nearestWithinRadius=function(c,b,m){var g=this,f=this.unphasedState(),e=f.getFromKeyWithDefault(a.DIMENSIONS,c.length);if(c.length!=e)throw Error("Key size should always be the same");var n=d.mwg.structure.util.HRect.infiniteHRect(c.length),l=java.lang.Double.MAX_VALUE,h=new d.mwg.structure.util.NearestNeighborArrayList,f=this.getDistance(f),
p=a.nearestRadiusTask.prepareWith(this.graph(),this,function(a){var c=h.distroyAndGetAllNodes();if(0!=c.length){a=d.mwg.task.Actions.setWorld(java.lang.String.valueOf(g.world())).setTime(java.lang.String.valueOf(g.time())).fromVar("res").lookupAll("{{result}}");var b=a.prepareWith(g.graph(),null,function(a){for(var c=Array(a.size()),b=0;b<a.size();b++)c[b]=a.get(b);m(c)}),c=b.wrap(c);b.addToGlobalVariable("res",c);a.executeUsing(b)}else m([])}),q=p.newResult();q.add(c);p.setGlobalVariable("key",q);
p.setGlobalVariable("distance",f);p.setGlobalVariable("dim",e);p.setGlobalVariable("nnl",h);p.setGlobalVariable("radius",b);p.defineVariable("lev",0);p.defineVariable("hr",n);p.defineVariable("max_dist_sqd",l);a.nearestRadiusTask.executeUsing(p)};a.prototype.nearestN=function(c,b,m){var g=this,f=this.unphasedState(),e=f.getFromKeyWithDefault(a.DIMENSIONS,c.length);if(c.length!=e)throw Error("Key size should always be the same");var n=d.mwg.structure.util.HRect.infiniteHRect(c.length),l=java.lang.Double.MAX_VALUE,
h=new d.mwg.structure.util.NearestNeighborList(b);b=this.getDistance(f);var f=a.nearestTask.prepareWith(this.graph(),this,function(a){var c=h.getNodes();if(0!=c.length){a=d.mwg.task.Actions.setWorld(java.lang.String.valueOf(g.world())).setTime(java.lang.String.valueOf(g.time())).fromVar("res").lookupAll("{{result}}");var b=a.prepareWith(g.graph(),null,function(a){for(var c=Array(a.size()),b=0;b<a.size();b++)c[b]=a.get(b);m(c)}),c=b.wrap(c);b.addToGlobalVariable("res",c);a.executeUsing(b)}else m([])}),
p=f.newResult();p.add(c);f.setGlobalVariable("key",p);f.setGlobalVariable("distance",b);f.setGlobalVariable("dim",e);f.setGlobalVariable("nnl",h);f.defineVariable("lev",0);f.defineVariable("hr",n);f.defineVariable("max_dist_sqd",l);a.nearestTask.executeUsing(f)};a.prototype.getDistance=function(c){c=c.getFromKeyWithDefault(a.DISTANCE,a.DISTANCE_TYPE_DEF);if(c==d.mwg.structure.distance.Distances.EUCLIDEAN)c=d.mwg.structure.distance.EuclideanDistance.instance();else if(c==d.mwg.structure.distance.Distances.GEODISTANCE)c=
d.mwg.structure.distance.GeoDistance.instance();else throw Error("Unknown distance code metric");return c};a.prototype.extractFeatures=function(c,b){var m=this,g=e.prototype.get.call(this,a.FROM);if(null!=g){for(var g=g.split(","),f=Array(g.length),k=0;k<g.length;k++){var n=d.mwg.task.Actions.setWorld(""+this.world());n.setTime(this.time()+"");n.parse(g[k].trim());f[k]=n}for(var l=new Float64Array(f.length),h=this.graph().newCounter(f.length),n=function(a){var b=d.mwg.task.Actions.newTask().emptyResult();
b.add(c);(function(a){f[a].executeWith(m.graph(),b,function(c){null==c?l[a]=d.mwg.Constants.NULL_LONG:(l[a]=parseFloat(c.get(0).toString()),c.free());h.count()})})(a)},k=0;k<g.length;k++)n(k);h.then(function(){b(l)})}else b(null)};a.NAME="KDTree";a.FROM="from";a.LEFT="left";a.RIGHT="right";a.KEY="key";a.VALUE="value";a.SIZE="size";a.DIMENSIONS="dimensions";a.DISTANCE="distance";a.DISTANCE_THRESHOLD="threshold";a.DISTANCE_THRESHOLD_DEF=1E-10;a.DISTANCE_TYPE_DEF=0;a.insert=d.mwg.task.Actions.whileDo(function(a){var b=
a.resultAsNodes().get(0),m=b.get(d.mwg.structure.tree.KDTree.KEY),g=a.variable("dim").get(0),f=a.variable("key").get(0),e=a.variable("value").get(0),n=a.variable("root").get(0),l=a.variable("distance").get(0),h=a.variable("err").get(0),p=a.variable("lev").get(0);if(null==m)return b.setProperty(d.mwg.structure.tree.KDTree.DIMENSIONS,d.mwg.Type.INT,g),b.setProperty(d.mwg.structure.tree.KDTree.KEY,d.mwg.Type.DOUBLE_ARRAY,f),b.getOrCreateRel(d.mwg.structure.tree.KDTree.VALUE).clear().add(e.id()),b.setProperty(d.mwg.structure.tree.KDTree.SIZE,
d.mwg.Type.INT,1),!1;if(l.measure(f,m)<h)return b.getOrCreateRel(d.mwg.structure.tree.KDTree.VALUE).clear().add(e.id()),!1;f[p]>m[p]?(l=b.get(d.mwg.structure.tree.KDTree.RIGHT),m=d.mwg.structure.tree.KDTree.RIGHT):(l=b.get(d.mwg.structure.tree.KDTree.LEFT),m=d.mwg.structure.tree.KDTree.LEFT);if(null==l||0==l.size())return a=a.graph().newTypedNode(b.world(),b.time(),d.mwg.structure.tree.KDTree.NAME),a.setProperty(d.mwg.structure.tree.KDTree.KEY,d.mwg.Type.DOUBLE_ARRAY,f),a.getOrCreateRel(d.mwg.structure.tree.KDTree.VALUE).clear().add(e.id()),
b.getOrCreateRel(m).clear().add(a.id()),n.setProperty(d.mwg.structure.tree.KDTree.SIZE,d.mwg.Type.INT,n.get(d.mwg.structure.tree.KDTree.SIZE)+1),a.free(),!1;a.setGlobalVariable("next",m);a.setGlobalVariable("lev",(p+1)%g);return!0},d.mwg.task.Actions.traverse("{{next}}"));a.nearestTask=a.initFindNear();a.nearestRadiusTask=a.initFindRadius();a.enforcer=(new d.mwg.utility.Enforcer).asPositiveDouble(a.DISTANCE_THRESHOLD);return a}(d.mwg.plugin.AbstractNode);u.KDTree=r;r=function(e){function a(a,b,d,
g){e.call(this,a,b,d,g)}__extends(a,e);a.prototype.setBounds=function(c,b,m){var g=this.unphasedState();if(null!=g.get(a._BOUNDMIN))throw Error("Bounds can't be changed!, you need to re-index");if(c.length!=b.length)throw Error("Min and max bounds should be the same array length");if(m.length!=b.length)throw Error("Max and precision should be the same array length");for(var f=0;f<c.length;f++){if(c[f]>=b[f])throw Error("Min should be always exclusively smaller than max");if(m[f]>b[f]-c[f])throw Error("Precision should always be smaller than max-min");
}g.set(a._DIM,d.mwg.Type.INT,c.length);g.set(a._BOUNDMIN,d.mwg.Type.DOUBLE_ARRAY,c);g.set(a._BOUNDMAX,d.mwg.Type.DOUBLE_ARRAY,b);g.set(a._PRECISION,d.mwg.Type.DOUBLE_ARRAY,m)};a.updateCount=function(c,b){if(c)if(null!=b.getByIndex(a._NUMNODES)){var m=b.getByIndex(a._NUMNODES);m++;b.setPropertyByIndex(a._NUMNODES,d.mwg.Type.INT,m)}else b.setPropertyByIndex(a._NUMNODES,d.mwg.Type.INT,1)};a.initNearestTask=function(){var a=d.mwg.task.Actions.newTask();a.defineVar("parent").then(function(a){var c=a.result().get(0),
g=c.graph().resolver().resolveState(c),c=a.variable("nnl").get(0),f=g.get(d.mwg.structure.tree.NDTree._VALUES);if(null!=f){for(var e=a.variable("dim").get(0),n=new Float64Array(e),g=g.get(d.mwg.structure.tree.NDTree._KEYS),l=a.variable("key").get(0),h=a.variable("distance").get(0),p=0;p<f.size();p++){for(var q=0;q<e;q++)n[q]=g[p*e+q];c.insert(f.get(p),h.measure(n,l))}a.continueWith(null)}else{var t=g.get(d.mwg.structure.tree.NDTree._BOUNDMAX),w=g.get(d.mwg.structure.tree.NDTree._BOUNDMIN),r=a.variable("key").get(0),
C=a.variable("distance").get(0),f=c.getWorstDistance();if(!c.isCapacityReached()||d.mwg.structure.tree.NDTree.getclosestDistance(r,w,t,C)<=f){var u=a.variable("precision").get(0),v=w.length,y=new Float64Array(v),z=new Float64Array(v),A=new d.mwg.structure.util.NearestNeighborArrayList;g.each(function(a,c,b){if(a>=d.mwg.structure.tree.NDTree._RELCONST){c=d.mwg.structure.tree.NDTree.binaryFromLong(a,v);for(b=0;b<v;b++)c[b]?(y[b]=t[b]-Math.max((t[b]-w[b])/2,u[b]),z[b]=t[b]):(y[b]=w[b],z[b]=Math.max((t[b]-
w[b])/2,u[b])+w[b]);A.insert(a,d.mwg.structure.tree.NDTree.getclosestDistance(r,y,z,C))}});A.sort();c=A.getNodes();a.continueWith(a.wrap(c))}else a.continueWith(null)}}).foreach(d.mwg.task.Actions.defineVar("relid").fromVar("parent").action(d.mwg.structure.action.TraverseById.NAME,"{{relid}}").subTask(a));return a};a.initRadusTask=function(){var a=d.mwg.task.Actions.newTask();a.defineVar("parent").then(function(a){var c=a.result().get(0),g=c.graph().resolver().resolveState(c),c=a.variable("nnl").get(0),
f=g.get(d.mwg.structure.tree.NDTree._VALUES);if(null!=f){for(var e=a.variable("dim").get(0),n=new Float64Array(e),g=g.get(d.mwg.structure.tree.NDTree._KEYS),l=a.variable("key").get(0),h=a.variable("distance").get(0),p=0;p<f.size();p++){for(var q=0;q<e;q++)n[q]=g[p*e+q];c.insert(f.get(p),h.measure(n,l))}a.continueWith(null)}else{var t=g.get(d.mwg.structure.tree.NDTree._BOUNDMAX),w=g.get(d.mwg.structure.tree.NDTree._BOUNDMIN),r=a.variable("key").get(0),C=a.variable("distance").get(0),c=a.variable("radius").get(0);
if(d.mwg.structure.tree.NDTree.getclosestDistance(r,w,t,C)<=c){var u=a.variable("precision").get(0),v=w.length,y=new Float64Array(v),z=new Float64Array(v),A=new d.mwg.structure.util.NearestNeighborArrayList;g.each(function(a,c,b){if(a>=d.mwg.structure.tree.NDTree._RELCONST){c=d.mwg.structure.tree.NDTree.binaryFromLong(a,v);for(b=0;b<v;b++)c[b]?(y[b]=t[b]-Math.max((t[b]-w[b])/2,u[b]),z[b]=t[b]):(y[b]=w[b],z[b]=Math.max((t[b]-w[b])/2,u[b])+w[b]);A.insert(a,d.mwg.structure.tree.NDTree.getclosestDistance(r,
y,z,C))}});A.sort();c=A.getNodes();a.continueWith(a.wrap(c))}else a.continueWith(null)}}).foreach(d.mwg.task.Actions.defineVar("relid").fromVar("parent").action(d.mwg.structure.action.TraverseById.NAME,"{{relid}}").subTask(a));return a};a.prototype.setUpdateStat=function(c){this.unphasedState().set(a._STAT,d.mwg.Type.BOOL,c)};a.updateGaussian=function(c,b){var m=0,g=c.get(a._TOTAL);null!=g&&(m=g);if(0==m)c.set(a._TOTAL,d.mwg.Type.INT,1),c.set(a._SUM,d.mwg.Type.DOUBLE_ARRAY,b);else{var g=b.length,
f,e;if(1==m){f=c.get(a._SUM);e=new Float64Array(g*(g+1)/2);for(var n=0,l=0;l<g;l++)for(var h=l;h<g;h++)e[n]=f[l]*f[h],n++}else f=c.get(a._SUM),e=c.get(a._SUMSQ);for(l=0;l<g;l++)f[l]+=b[l];for(l=n=0;l<g;l++)for(h=l;h<g;h++)e[n]+=b[l]*b[h],n++;m++;c.set(a._TOTAL,d.mwg.Type.INT,m);c.set(a._SUM,d.mwg.Type.DOUBLE_ARRAY,f);c.set(a._SUMSQ,d.mwg.Type.DOUBLE_ARRAY,e)}};a.prototype.getTotal=function(){var c=e.prototype.getByIndex.call(this,a._TOTAL);return null==c?0:c};a.prototype.getAvg=function(){var c=this.getTotal();
if(0==c)return null;if(1==c)return e.prototype.getByIndex.call(this,a._SUM);for(var b=e.prototype.getByIndex.call(this,a._SUM),d=0;d<b.length;d++)b[d]/=c;return b};a.prototype.getCovarianceArray=function(c,b){if(null==c){var d=new Float64Array(b.length);java.lang.System.arraycopy(b,0,d,0,b.length);return d}null==b&&(b=new Float64Array(c.length));var d=c.length,g=this.getTotal();if(0==g)return null;if(1<g){var f=new Float64Array(d),k=e.prototype.getByIndex.call(this,a._SUMSQ),n;n=g/(g-1);for(var l=
0,h=0;h<d;h++)f[h]=(k[l]/g-c[h]*c[h])*n,f[h]<b[h]&&(f[h]=b[h]),l+=d-h;return f}d=new Float64Array(b.length);java.lang.System.arraycopy(b,0,d,0,b.length);return d};a.getRelationId=function(a,b){for(var m=Long.UZERO,g=0;g<a.length;g++)0!=g&&(m=m.shiftLeft(1)),b[g]>a[g]&&(m=m.add(Long.ONE));return m.add(Long.fromNumber(d.mwg.structure.tree.NDTree._RELCONST,!0)).toNumber()};a.binaryFromLong=function(c,b){for(var d=c-a._RELCONST,g=d>>1,f=[],e=0;e<b;e++)f[b-e-1]=1==d-(g<<1),d=g,g=d>>1;return f};a.prototype.getDistance=
function(c){c=c.getWithDefault(a._DISTANCE,a.DISTANCE_TYPE_DEF);if(c==d.mwg.structure.distance.Distances.EUCLIDEAN)c=d.mwg.structure.distance.EuclideanDistance.instance();else if(c==d.mwg.structure.distance.Distances.GEODISTANCE)c=d.mwg.structure.distance.GeoDistance.instance();else throw Error("Unknown distance code metric");return c};a.prototype.setDistance=function(c){this.setPropertyByIndex(a._DISTANCE,d.mwg.Type.INT,c)};a.prototype.setFrom=function(c){this.setPropertyByIndex(a._FROM,d.mwg.Type.STRING,
c)};a.prototype.nearestN=function(c,b,m){var g=this,f=this.unphasedState(),e=f.getWithDefault(a._DIM,c.length);this.checkKey(f,c,e);var n=new d.mwg.structure.util.NearestNeighborList(b),l=this.getDistance(f);b=a.nearestTask.prepareWith(this.graph(),this,function(a){var c=n.getNodes();if(0!=c.length){a=d.mwg.task.Actions.setWorld(java.lang.String.valueOf(g.world())).setTime(java.lang.String.valueOf(g.time())).fromVar("res").lookupAll("{{result}}");var b=a.prepareWith(g.graph(),null,function(a){for(var c=
Array(a.size()),b=0;b<a.size();b++)c[b]=a.get(b);m(c)}),c=b.wrap(c);b.addToGlobalVariable("res",c);a.executeUsing(b)}else m([])});var h=b.newResult();h.add(c);b.setGlobalVariable("key",h);b.setGlobalVariable("distance",l);b.setGlobalVariable("dim",e);c=f.get(a._PRECISION);f=b.newResult();f.add(c);b.setGlobalVariable("precision",f);b.setGlobalVariable("nnl",n);a.nearestTask.executeUsing(b)};a.prototype.nearestWithinRadius=function(c,b,m){var g=this,f=this.unphasedState(),e=f.getWithDefault(a._DIM,
c.length);this.checkKey(f,c,e);var n=new d.mwg.structure.util.NearestNeighborArrayList,l=this.getDistance(f),h=a.nearestRadiusTask.prepareWith(this.graph(),this,function(a){var c=n.getNodes();if(0!=c.length){a=d.mwg.task.Actions.setWorld(java.lang.String.valueOf(g.world())).setTime(java.lang.String.valueOf(g.time())).fromVar("res").lookupAll("{{result}}");var b=a.prepareWith(g.graph(),null,function(a){for(var c=Array(a.size()),b=0;b<a.size();b++)c[b]=a.get(b);m(c)}),c=b.wrap(c);b.addToGlobalVariable("res",
c);a.executeUsing(b)}else m([])}),p=h.newResult();p.add(c);h.setGlobalVariable("key",p);h.setGlobalVariable("distance",l);h.setGlobalVariable("dim",e);h.setGlobalVariable("radius",b);c=f.get(a._PRECISION);b=h.newResult();b.add(c);h.setGlobalVariable("precision",b);h.setGlobalVariable("nnl",n);a.nearestRadiusTask.executeUsing(h)};a.prototype.nearestNWithinRadius=function(c,b,m,g){var f=this,e=this.unphasedState(),n=e.getWithDefault(a._DIM,c.length);this.checkKey(e,c,n);var l=new d.mwg.structure.util.NearestNeighborList(b),
h=this.getDistance(e);b=a.nearestTask.prepareWith(this.graph(),this,function(a){var c=l.getAllNodesWithin(m);if(0!=c.length){a=d.mwg.task.Actions.setWorld(java.lang.String.valueOf(f.world())).setTime(java.lang.String.valueOf(f.time())).fromVar("res").lookupAll("{{result}}");var b=a.prepareWith(f.graph(),null,function(a){for(var c=Array(a.size()),b=0;b<a.size();b++)c[b]=a.get(b);g(c)}),c=b.wrap(c);b.addToGlobalVariable("res",c);a.executeUsing(b)}else g([])});var p=b.newResult();p.add(c);b.setGlobalVariable("key",
p);b.setGlobalVariable("distance",h);b.setGlobalVariable("dim",n);c=e.get(a._PRECISION);e=b.newResult();e.add(c);b.setGlobalVariable("precision",e);b.setGlobalVariable("nnl",l);a.nearestTask.executeUsing(b)};a.prototype.checkKey=function(c,b,d){if(b.length!=d)throw Error("Key size should always be the same");var g=c.get(a._BOUNDMIN);c=c.get(a._BOUNDMAX);if(null==g||null==c)throw Error("Please set min and max boundary before inserting in the tree");for(var f=0;f<d;f++)if(b[f]<g[f]||b[f]>c[f])throw Error("Key should be between min and max boundaries");
return!0};a.prototype.insertWith=function(c,b,m){var g=this.unphasedState();if(null!=b&&null!=c){null==g.get(a._DIM)&&g.set(a._DIM,d.mwg.Type.INT,c.length);var f=g.getWithDefault(a._DIM,c.length);this.checkKey(g,c,f);var f=a.insert.prepareWith(this.graph(),this,function(a){a.free();null!=m&&m(!0)}),e=f.newResult();e.add(c);f.setGlobalVariable("key",e);f.setGlobalVariable("value",b);c=g.get(a._PRECISION);g=g.getWithDefault(a._STAT,a.STAT_DEF);f.setGlobalVariable("updatestat",g);f.setGlobalVariable("root",
this);g=f.newResult();g.add(c);f.setGlobalVariable("precision",g);a.insert.executeUsing(f)}};a.prototype.extractFeatures=function(c,b){var m=this,g=e.prototype.getByIndex.call(this,a._FROM);if(null!=g){for(var g=g.split(","),f=Array(g.length),k=0;k<g.length;k++){var n=d.mwg.task.Actions.setWorld(""+this.world());n.setTime(this.time()+"");n.parse(g[k].trim());f[k]=n}for(var l=new Float64Array(f.length),h=this.graph().newCounter(f.length),n=function(a){var b=d.mwg.task.Actions.newTask().emptyResult();
b.add(c);(function(a){f[a].executeWith(m.graph(),b,function(c){null==c?l[a]=d.mwg.Constants.NULL_LONG:(l[a]=parseFloat(c.get(0).toString()),c.free());h.count()})})(a)},k=0;k<g.length;k++)n(k);h.then(function(){b(l)})}else b(null)};a.prototype.insert=function(a,b){var d=this;this.extractFeatures(a,function(g){d.insertWith(g,a,b)})};a.prototype.size=function(){return null!=this.getByIndex(a._NUMNODES)?this.getByIndex(a._NUMNODES):1};a.getclosestDistance=function(a,b,d,g){for(var f=new Float64Array(a.length),
e=0;e<a.length;e++)f[e]=a[e]>=d[e]?d[e]:a[e]<=b[e]?b[e]:a[e];return g.measure(f,a)};a.NAME="NDTree";a._STAT=0;a._TOTAL=1;a._SUM=2;a._SUMSQ=3;a._BOUNDMIN=6;a._BOUNDMAX=7;a._VALUES=8;a._KEYS=9;a._VALUES_STR="8";a._KEYS_STR="9";a._PRECISION=10;a._NUMNODES=11;a._DIM=12;a._DISTANCE=13;a._DISTANCETHRESHOLD=14;a._FROM=15;a.DISTANCE_THRESHOLD="threshold";a.DISTANCE_THRESHOLD_DEF=1E-10;a.DISTANCE_TYPE_DEF=0;a.STAT_DEF=!1;a._RELCONST=16;a.nearestTask=a.initNearestTask();a.nearestRadiusTask=a.initRadusTask();
a.insert=d.mwg.task.Actions.whileDo(function(a){for(var b=a.variable("root").get(0),m=a.resultAsNodes().get(0),g=m.graph().resolver().resolveState(m),f=a.variable("updatestat").get(0),e=g.get(d.mwg.structure.tree.NDTree._BOUNDMAX),n=g.get(d.mwg.structure.tree.NDTree._BOUNDMIN),l=new Float64Array(e.length),h=0;h<l.length;h++)l[h]=(e[h]+n[h])/2;var p=a.variable("key").get(0),q=a.variable("precision").get(0),t=p.length;f&&d.mwg.structure.tree.NDTree.updateGaussian(g,p);f=!1;for(h=0;h<t;h++)if(e[h]-n[h]>
q[h]){f=!0;break}if(f){b=d.mwg.structure.tree.NDTree.getRelationId(l,p);if(null==g.get(b)){for(var w=new Float64Array(t),t=new Float64Array(t),h=0;h<l.length;h++)p[h]<=l[h]?(w[h]=n[h],t[h]=Math.max(l[h]-n[h],q[h])+n[h]):(w[h]=e[h]-Math.max(e[h]-l[h],q[h]),t[h]=e[h]);p=m.graph().newTypedNode(m.world(),m.time(),d.mwg.structure.tree.NDTree.NAME);m=p.graph().resolver().resolveState(p);m.set(d.mwg.structure.tree.NDTree._BOUNDMIN,d.mwg.Type.DOUBLE_ARRAY,w);m.set(d.mwg.structure.tree.NDTree._BOUNDMAX,d.mwg.Type.DOUBLE_ARRAY,
t);g.getOrCreate(b,d.mwg.Type.RELATION).add(p.id());p.free()}a.setVariable("next",b)}else a=a.variable("value").get(0),g.getOrCreate(d.mwg.structure.tree.NDTree._VALUES,d.mwg.Type.RELATION).add(a.id()),a=g.get(d.mwg.structure.tree.NDTree._KEYS),null!=a?(m=new Float64Array(a.length+t),java.lang.System.arraycopy(a,0,m,0,a.length),java.lang.System.arraycopy(p,0,m,a.length,t),g.set(d.mwg.structure.tree.NDTree._KEYS,d.mwg.Type.DOUBLE_ARRAY,m)):g.set(d.mwg.structure.tree.NDTree._KEYS,d.mwg.Type.DOUBLE_ARRAY,
p),d.mwg.structure.tree.NDTree.updateCount(!0,b);return f},d.mwg.task.Actions.action(d.mwg.structure.action.TraverseById.NAME,"{{next}}"));return a}(d.mwg.plugin.AbstractNode);u.NDTree=r;r=function(e){function a(a,b,d,g){e.call(this,a,b,d,g)}__extends(a,e);a.createChildAndIndex=function(c,b,e,g,f,k,n,l,h,p){var q=new Float64Array(c);c=new Float64Array(c);for(var t=0;t<b.length;t++)f[t]<=b[t]?(q[t]=e[t],c[t]=b[t]):(q[t]=b[t],c[t]=g[t]);b=n.graph().newTypedNode(n.world(),n.time(),a.NAME);e=b.graph().resolver().resolveState(b);
e.set(a._BOUNDMIN,d.mwg.Type.DOUBLE_ARRAY,q);e.set(a._BOUNDMAX,d.mwg.Type.DOUBLE_ARRAY,c);e.getOrCreate(a._VALUES,d.mwg.Type.RELATION).add(k);e.set(a._KEYS,d.mwg.Type.DOUBLE_ARRAY,f);l.getOrCreate(h,d.mwg.Type.RELATION).add(b.id());d.mwg.structure.tree.NDTree2.updateGaussian(p,e,f);b.free()};a.updateCount=function(c,b){if(c)if(null!=b.getByIndex(a._NUMNODES)){var e=b.getByIndex(a._NUMNODES);e++;b.setPropertyByIndex(a._NUMNODES,d.mwg.Type.INT,e)}else b.setPropertyByIndex(a._NUMNODES,d.mwg.Type.INT,
1)};a.initNearestTask=function(){var a=d.mwg.task.Actions.newTask();a.defineVar("parent").then(function(a){var c=a.result().get(0),e=c.graph().resolver().resolveState(c),c=a.variable("nnl").get(0);if(e.getWithDefault(d.mwg.structure.tree.NDTree2._CONTINUENAV,!1)){var f=e.get(d.mwg.structure.tree.NDTree2._BOUNDMAX),k=e.get(d.mwg.structure.tree.NDTree2._BOUNDMIN),n=a.variable("key").get(0),l=a.variable("distance").get(0),h=c.getWorstDistance();if(!c.isCapacityReached()||d.mwg.structure.tree.NDTree2.getclosestDistance(n,
k,f,l)<=h){var p=k.length,q=new Float64Array(p),t=new Float64Array(p),w=new d.mwg.structure.util.NearestNeighborArrayList;e.each(function(a,b,c){if(a>=d.mwg.structure.tree.NDTree2._RELCONST){b=d.mwg.structure.tree.NDTree2.binaryFromLong(a,p);for(c=0;c<p;c++)b[c]?(q[c]=(f[c]+k[c])/2,t[c]=f[c]):(q[c]=k[c],t[c]=(f[c]+k[c])/2);w.insert(a,d.mwg.structure.tree.NDTree2.getclosestDistance(n,q,t,l))}});w.sort();c=w.getNodes();a.continueWith(a.wrap(c))}else a.continueWith(null)}else{for(var h=e.get(d.mwg.structure.tree.NDTree2._VALUES),
r=a.variable("dim").get(0),u=new Float64Array(r),e=e.get(d.mwg.structure.tree.NDTree2._KEYS),v=a.variable("key").get(0),x=a.variable("distance").get(0),y=0;y<h.size();y++){for(var z=0;z<r;z++)u[z]=e[y*r+z];c.insert(h.get(y),x.measure(u,v))}a.continueWith(null)}}).foreach(d.mwg.task.Actions.defineVar("relid").fromVar("parent").action(d.mwg.structure.action.TraverseById.NAME,"{{relid}}").subTask(a));return a};a.initRadusTask=function(){var a=d.mwg.task.Actions.newTask();a.defineVar("parent").then(function(a){var c=
a.result().get(0),e=c.graph().resolver().resolveState(c),c=a.variable("nnl").get(0);if(e.getWithDefault(d.mwg.structure.tree.NDTree2._CONTINUENAV,!1)){var f=e.get(d.mwg.structure.tree.NDTree2._BOUNDMAX),k=e.get(d.mwg.structure.tree.NDTree2._BOUNDMIN),n=a.variable("key").get(0),l=a.variable("distance").get(0),c=a.variable("radius").get(0);if(d.mwg.structure.tree.NDTree2.getclosestDistance(n,k,f,l)<=c){var h=k.length,p=new Float64Array(h),q=new Float64Array(h),t=new d.mwg.structure.util.NearestNeighborArrayList;
e.each(function(a,c,b){if(a>=d.mwg.structure.tree.NDTree2._RELCONST){c=d.mwg.structure.tree.NDTree2.binaryFromLong(a,h);for(b=0;b<h;b++)c[b]?(p[b]=(f[b]+k[b])/2,q[b]=f[b]):(p[b]=k[b],q[b]=(f[b]+k[b])/2);t.insert(a,d.mwg.structure.tree.NDTree2.getclosestDistance(n,p,q,l))}});t.sort();c=t.getNodes();a.continueWith(a.wrap(c))}else a.continueWith(null)}else{for(var r=e.get(d.mwg.structure.tree.NDTree2._VALUES),u=a.variable("dim").get(0),v=new Float64Array(u),e=e.get(d.mwg.structure.tree.NDTree2._KEYS),
x=a.variable("key").get(0),B=a.variable("distance").get(0),y=0;y<r.size();y++){for(var z=0;z<u;z++)v[z]=e[y*u+z];c.insert(r.get(y),B.measure(v,x))}a.continueWith(null)}}).foreach(d.mwg.task.Actions.defineVar("relid").fromVar("parent").action(d.mwg.structure.action.TraverseById.NAME,"{{relid}}").subTask(a));return a};a.prototype.setUpdateStat=function(c){this.unphasedState().set(a._STAT,d.mwg.Type.BOOL,c)};a.updateGaussian=function(c,b,e){if(c){c=0;var g=b.get(a._TOTAL);null!=g&&(c=g);if(0==c)b.set(a._TOTAL,
d.mwg.Type.INT,1),b.set(a._SUM,d.mwg.Type.DOUBLE_ARRAY,e);else{var g=e.length,f,k;if(1==c){f=b.get(a._SUM);k=new Float64Array(g*(g+1)/2);for(var n=0,l=0;l<g;l++)for(var h=l;h<g;h++)k[n]=f[l]*f[h],n++}else f=b.get(a._SUM),k=b.get(a._SUMSQ);for(l=0;l<g;l++)f[l]+=e[l];for(l=n=0;l<g;l++)for(h=l;h<g;h++)k[n]+=e[l]*e[h],n++;c++;b.set(a._TOTAL,d.mwg.Type.INT,c);b.set(a._SUM,d.mwg.Type.DOUBLE_ARRAY,f);b.set(a._SUMSQ,d.mwg.Type.DOUBLE_ARRAY,k)}}};a.prototype.getTotal=function(){var c=e.prototype.getByIndex.call(this,
a._TOTAL);return null==c?0:c};a.prototype.getAvg=function(){var c=this.getTotal();if(0==c)return null;if(1==c)return e.prototype.getByIndex.call(this,a._SUM);for(var b=e.prototype.getByIndex.call(this,a._SUM),d=0;d<b.length;d++)b[d]/=c;return b};a.prototype.setBounds=function(c,b){var e=this.unphasedState();if(null!=e.get(a._BOUNDMIN))throw Error("Bounds can't be changed!, you need to re-index");if(c.length!=b.length)throw Error("Min and max bounds should be the same array length");for(var g=0;g<
c.length;g++)if(c[g]>=b[g])throw Error("Min should be always exclusively smaller than max");e.set(a._DIM,d.mwg.Type.INT,c.length);e.set(a._BOUNDMIN,d.mwg.Type.DOUBLE_ARRAY,c);e.set(a._BOUNDMAX,d.mwg.Type.DOUBLE_ARRAY,b)};a.prototype.getCovarianceArray=function(c,b){if(null==c){var d=new Float64Array(b.length);java.lang.System.arraycopy(b,0,d,0,b.length);return d}null==b&&(b=new Float64Array(c.length));var d=c.length,g=this.getTotal();if(0==g)return null;if(1<g){var f=new Float64Array(d),k=e.prototype.getByIndex.call(this,
a._SUMSQ),n;n=g/(g-1);for(var l=0,h=0;h<d;h++)f[h]=(k[l]/g-c[h]*c[h])*n,f[h]<b[h]&&(f[h]=b[h]),l+=d-h;return f}d=new Float64Array(b.length);java.lang.System.arraycopy(b,0,d,0,b.length);return d};a.getRelationId=function(a,b){for(var e=Long.UZERO,g=0;g<a.length;g++)0!=g&&(e=e.shiftLeft(1)),b[g]>a[g]&&(e=e.add(Long.ONE));return e.add(Long.fromNumber(d.mwg.structure.tree.NDTree2._RELCONST,!0)).toNumber()};a.binaryFromLong=function(c,b){for(var d=c-a._RELCONST,e=d>>1,f=[],k=0;k<b;k++)f[b-k-1]=1==d-(e<<
1),d=e,e=d>>1;return f};a.prototype.getDistance=function(c){c=c.getWithDefault(a._DISTANCE,a.DISTANCE_TYPE_DEF);if(c==d.mwg.structure.distance.Distances.EUCLIDEAN)c=d.mwg.structure.distance.EuclideanDistance.instance();else if(c==d.mwg.structure.distance.Distances.GEODISTANCE)c=d.mwg.structure.distance.GeoDistance.instance();else throw Error("Unknown distance code metric");return c};a.prototype.setDistance=function(c){this.setPropertyByIndex(a._DISTANCE,d.mwg.Type.INT,c)};a.prototype.setFrom=function(c){this.setPropertyByIndex(a._FROM,
d.mwg.Type.STRING,c)};a.prototype.nearestN=function(c,b,e){var g=this,f=this.unphasedState(),k=f.get(a._DIM);if(null==k)e(null);else{if(c.length!=k)throw Error("Key size should always be the same");var n=new d.mwg.structure.util.NearestNeighborList(b);b=this.getDistance(f);var f=a.nearestTask.prepareWith(this.graph(),this,function(a){var c=n.getNodes();if(0!=c.length){a=d.mwg.task.Actions.setWorld(java.lang.String.valueOf(g.world())).setTime(java.lang.String.valueOf(g.time())).fromVar("res").lookupAll("{{result}}");
var b=a.prepareWith(g.graph(),null,function(a){for(var c=Array(a.size()),b=0;b<a.size();b++)c[b]=a.get(b);e(c)}),c=b.wrap(c);b.addToGlobalVariable("res",c);a.executeUsing(b)}else e([])}),l=f.newResult();l.add(c);f.setGlobalVariable("key",l);f.setGlobalVariable("distance",b);f.setGlobalVariable("dim",k);f.setGlobalVariable("nnl",n);a.nearestTask.executeUsing(f)}};a.prototype.nearestWithinRadius=function(c,b,e){var g=this,f=this.unphasedState(),k=f.get(a._DIM);if(null==k)e(null);else{if(c.length!=k)throw Error("Key size should always be the same");
var n=new d.mwg.structure.util.NearestNeighborArrayList,f=this.getDistance(f),l=a.nearestRadiusTask.prepareWith(this.graph(),this,function(a){var c=n.getNodes();if(0!=c.length){a=d.mwg.task.Actions.setWorld(java.lang.String.valueOf(g.world())).setTime(java.lang.String.valueOf(g.time())).fromVar("res").lookupAll("{{result}}");var b=a.prepareWith(g.graph(),null,function(a){for(var c=Array(a.size()),b=0;b<a.size();b++)c[b]=a.get(b);e(c)}),c=b.wrap(c);b.addToGlobalVariable("res",c);a.executeUsing(b)}else e([])}),
h=l.newResult();h.add(c);l.setGlobalVariable("key",h);l.setGlobalVariable("distance",f);l.setGlobalVariable("dim",k);l.setGlobalVariable("radius",b);l.setGlobalVariable("nnl",n);a.nearestRadiusTask.executeUsing(l)}};a.prototype.nearestNWithinRadius=function(c,b,e,g){var f=this,k=this.unphasedState(),n=k.get(a._DIM);if(null==n)g(null);else{if(c.length!=n)throw Error("Key size should always be the same");var l=new d.mwg.structure.util.NearestNeighborList(b);b=this.getDistance(k);var k=a.nearestTask.prepareWith(this.graph(),
this,function(a){var c=l.getAllNodesWithin(e);if(0!=c.length){a=d.mwg.task.Actions.setWorld(java.lang.String.valueOf(f.world())).setTime(java.lang.String.valueOf(f.time())).fromVar("res").lookupAll("{{result}}");var b=a.prepareWith(f.graph(),null,function(a){for(var c=Array(a.size()),b=0;b<a.size();b++)c[b]=a.get(b);g(c)}),c=b.wrap(c);b.addToGlobalVariable("res",c);a.executeUsing(b)}else g([])}),h=k.newResult();h.add(c);k.setGlobalVariable("key",h);k.setGlobalVariable("distance",b);k.setGlobalVariable("dim",
n);k.setGlobalVariable("nnl",l);a.nearestTask.executeUsing(k)}};a.prototype.checkKey=function(c,b,d){if(b.length!=d)throw Error("Key size should always be the same");var e=c.get(a._BOUNDMIN);c=c.get(a._BOUNDMAX);if(null==e||null==c)throw Error("Please set min and max boundary before inserting in the tree");for(var f=0;f<d;f++)if(b[f]<e[f]||b[f]>c[f])throw Error("Key should be between min and max boundaries");return!0};a.prototype.insertWith=function(c,b,e){if(null!=b&&null!=c){var g=this.unphasedState();
null==g.get(a._DIM)&&g.set(a._DIM,d.mwg.Type.INT,c.length);var f=g.getWithDefault(a._DIM,c.length);this.checkKey(g,c,f);var f=a.insert.prepareWith(this.graph(),this,function(a){a.free();null!=e&&e(!0)}),k=f.newResult();k.add(c);f.setGlobalVariable("key",k);f.setGlobalVariable("value",b.id());f.setGlobalVariable("distance",this.getDistance(g));f.setGlobalVariable("distancemin",g.getWithDefault(a._DISTANCETHRESHOLD,a.DISTANCE_THRESHOLD_DEF));f.setGlobalVariable("updatestat",g.getWithDefault(a._STAT,
a.STAT_DEF));f.setGlobalVariable("updatecount",!0);f.setGlobalVariable("updatestatchild",g.getWithDefault(a._STAT,a.STAT_DEF));f.setGlobalVariable("root",this);a.insert.executeUsing(f)}};a.prototype.extractFeatures=function(c,b){var m=this,g=e.prototype.getByIndex.call(this,a._FROM);if(null!=g){for(var g=g.split(","),f=Array(g.length),k=0;k<g.length;k++){var n=d.mwg.task.Actions.setWorld(""+this.world());n.setTime(this.time()+"");n.parse(g[k].trim());f[k]=n}for(var l=new Float64Array(f.length),h=
this.graph().newCounter(f.length),n=function(a){var b=d.mwg.task.Actions.newTask().emptyResult();b.add(c);(function(a){f[a].executeWith(m.graph(),b,function(c){null==c?l[a]=d.mwg.Constants.NULL_LONG:(l[a]=parseFloat(c.get(0).toString()),c.free());h.count()})})(a)},k=0;k<g.length;k++)n(k);h.then(function(){b(l)})}else b(null)};a.prototype.insert=function(a,b){var d=this;this.extractFeatures(a,function(e){d.insertWith(e,a,b)})};a.prototype.size=function(){return null!=this.getByIndex(a._NUMNODES)?this.getByIndex(a._NUMNODES):
1};a.getclosestDistance=function(a,b,d,e){for(var f=new Float64Array(a.length),k=0;k<a.length;k++)f[k]=a[k]>=d[k]?d[k]:a[k]<=b[k]?b[k]:a[k];return e.measure(f,a)};a.NAME="NDTree2";a._STAT=0;a._TOTAL=1;a._SUM=2;a._SUMSQ=3;a._BOUNDMIN=6;a._BOUNDMAX=7;a._VALUES=8;a._KEYS=9;a._VALUES_STR="8";a._KEYS_STR="9";a._CONTINUENAV=10;a._NUMNODES=11;a._DIM=12;a._DISTANCE=13;a._DISTANCETHRESHOLD=14;a._FROM=15;a.DISTANCE_THRESHOLD="threshold";a.DISTANCE_THRESHOLD_DEF=1E-10;a.DISTANCE_TYPE_DEF=0;a.STAT_DEF=!1;a.MAXINSIDE=
2;a._RELCONST=16;a.nearestTask=a.initNearestTask();a.nearestRadiusTask=a.initRadusTask();a.insert=d.mwg.task.Actions.whileDo(function(a){for(var b=a.variable("root").get(0),e=a.resultAsNodes().get(0),g=e.graph().resolver().resolveState(e),f=a.variable("updatestat").get(0),k=a.variable("updatecount").get(0),n=g.get(d.mwg.structure.tree.NDTree2._BOUNDMAX),l=g.get(d.mwg.structure.tree.NDTree2._BOUNDMIN),h=new Float64Array(n.length),p=0;p<h.length;p++)h[p]=(n[p]+l[p])/2;var p=a.variable("key").get(0),
q=a.variable("value").get(0),t=p.length;if(g.getWithDefault(d.mwg.structure.tree.NDTree2._CONTINUENAV,!1)){d.mwg.structure.tree.NDTree2.updateGaussian(f,g,p);f=d.mwg.structure.tree.NDTree2.getRelationId(h,p);if(null==g.get(f))return a=a.variable("updatestatchild").get(0),d.mwg.structure.tree.NDTree2.createChildAndIndex(t,h,l,n,p,q,e,g,f,a),d.mwg.structure.tree.NDTree2.updateCount(k,b),!1;a.setVariable("next",f);return!0}var r=g.getOrCreate(d.mwg.structure.tree.NDTree2._VALUES,d.mwg.Type.RELATION),
n=g.get(d.mwg.structure.tree.NDTree2._KEYS),l=a.variable("distancemin").get(0);a=a.variable("distance").get(0);if(null!=n){for(var u=new Float64Array(t),h=0;h<r.size();h++)if(java.lang.System.arraycopy(n,h*t,u,0,t),a.measure(u,p)<l){for(b=0;b<t;b++)n[h*t+b]=p[b];g.set(d.mwg.structure.tree.NDTree2._KEYS,d.mwg.Type.DOUBLE_ARRAY,n);r.set(h,q);return!1}h=new Float64Array(n.length+t);java.lang.System.arraycopy(n,0,h,0,n.length);java.lang.System.arraycopy(p,0,h,n.length,t);g.set(d.mwg.structure.tree.NDTree2._KEYS,
d.mwg.Type.DOUBLE_ARRAY,h);r.add(q);n=h;d.mwg.structure.tree.NDTree2.updateCount(k,b);d.mwg.structure.tree.NDTree2.updateGaussian(f,g,p);if(!(r.size()<=d.mwg.structure.tree.NDTree2.MAXINSIDE)){g.set(d.mwg.structure.tree.NDTree2._CONTINUENAV,d.mwg.Type.BOOL,!0);for(var v=b.graph().newCounter(r.size()),p=0;p<r.size();p++)k=new Float64Array(t),java.lang.System.arraycopy(n,p*t,k,0,t),q=d.mwg.structure.tree.NDTree2.insert.prepareWith(b.graph(),e,function(a){a.free();v.count()}),q.setGlobalVariable("distance",
a),q.setGlobalVariable("distancemin",l),q.setGlobalVariable("updatestat",!1),q.setGlobalVariable("updatecount",!1),q.setGlobalVariable("updatestatchild",f),q.setGlobalVariable("root",e),h=q.newResult(),h.add(k),q.setGlobalVariable("key",h),q.setGlobalVariable("value",r.get(p)),d.mwg.structure.tree.NDTree2.insert.executeUsing(q);v.then(function(){r.clear();g.set(d.mwg.structure.tree.NDTree2._KEYS,d.mwg.Type.DOUBLE_ARRAY,null)})}}else g.set(d.mwg.structure.tree.NDTree2._KEYS,d.mwg.Type.DOUBLE_ARRAY,
p),r.add(q),d.mwg.structure.tree.NDTree2.updateCount(k,b),d.mwg.structure.tree.NDTree2.updateGaussian(f,g,p);return!1},d.mwg.task.Actions.action(d.mwg.structure.action.TraverseById.NAME,"{{next}}"));return a}(d.mwg.plugin.AbstractNode);u.NDTree2=r})(x.tree||(x.tree={}));(function(u){var r=function(){function e(a,c){this.min=new Float64Array(a.length);this.max=new Float64Array(c.length);java.lang.System.arraycopy(a,0,this.min,0,a.length);java.lang.System.arraycopy(c,0,this.max,0,c.length)}e.prototype.clone=
function(){return new d.mwg.structure.util.HRect(this.min,this.max)};e.prototype.closest=function(a){for(var c=new Float64Array(a.length),b=0;b<a.length;++b)c[b]=a[b]<=this.min[b]?this.min[b]:a[b]>=this.max[b]?this.max[b]:a[b];return c};e.infiniteHRect=function(a){for(var c=new Float64Array(a),b=new Float64Array(a),e=0;e<a;++e)c[e]=java.lang.Double.NEGATIVE_INFINITY,b[e]=java.lang.Double.POSITIVE_INFINITY;return new d.mwg.structure.util.HRect(c,b)};e.prototype.intersection=function(a){for(var c=new Float64Array(this.min.length),
b=new Float64Array(this.min.length),e=0;e<this.min.length;++e)if(c[e]=Math.max(this.min[e],a.min[e]),b[e]=Math.min(this.max[e],a.max[e]),c[e]>=b[e])return null;return new d.mwg.structure.util.HRect(c,b)};e.prototype.area=function(){for(var a=1,c=0;c<this.min.length;++c)a*=this.max[c]-this.min[c];return a};e.prototype.toString=function(){return this.min+"\n"+this.max+"\n"};return e}();u.HRect=r;r=function(){return function(){}}();u.NDResult=r;r=function(){function d(){this.maxPriority=java.lang.Double.MAX_VALUE;
this.count=0;this.data=new java.util.ArrayList;this.value=new java.util.ArrayList;this.value.add(this.maxPriority);this.data.add(-1)}d.prototype.getMaxPriority=function(){return 0==this.count?java.lang.Double.POSITIVE_INFINITY:this.value.get(1)};d.prototype.insert=function(a,c){this.count++;this.value.add(c);this.data.add(a);this.bubbleUp(this.count);return!0};d.prototype.distroyAndGetAllNodes=function(){for(var a=this.count,c=new Float64Array(this.count),b=0;b<a;++b)c[a-b-1]=this.remove();return c};
d.prototype.sort=function(){for(var a=2;a<this.count;a++)for(var c=a+1;c<this.count;c++)if(this.value.get(a)<this.value.get(c)){var b=this.value.get(a);this.value.set(a,this.value.get(c));this.value.set(c,b);b=this.data.get(a);this.data.set(a,this.data.get(c));this.data.set(c,b)}};d.prototype.getWorstDistance=function(){return this.value.get(1)};d.prototype.getNodes=function(){for(var a=new Float64Array(this.count),c=0;c<this.count;c++)a[c]=this.data.get(this.count-c);return a};d.prototype.getDistances=
function(){for(var a=new Float64Array(this.count),c=0;c<this.count;c++)a[c]=this.value.get(this.count-c);return a};d.prototype.getHighest=function(){return this.data.get(1)};d.prototype.getBestDistance=function(){return this.value.get(1)};d.prototype.isEmpty=function(){return 0==this.count};d.prototype.getSize=function(){return this.count};d.prototype.remove=function(){if(0==this.count)return 0;var a=this.data.get(1);this.data.set(1,this.data.get(this.count));this.value.set(1,this.value.get(this.count));
this.data.set(this.count,0);this.value.set(this.count,0);this.count--;this.bubbleDown(1);return a};d.prototype.bubbleDown=function(a){for(var c=this.data.get(a),b=this.value.get(a),d;2*a<=this.count;a=d)if(d=2*a,d!=this.count&&this.value.get(d)<this.value.get(d+1)&&d++,b<this.value.get(d))this.value.set(a,this.value.get(d)),this.data.set(a,this.data.get(d));else break;this.value.set(a,b);this.data.set(a,c)};d.prototype.bubbleUp=function(a){for(var c=this.data.get(a),b=this.value.get(a),d=Math.floor(a/
2);this.value.get(d)<b;)this.value.set(a,this.value.get(d)),this.data.set(a,this.data.get(d)),a=Math.floor(a/2),d=Math.floor(a/2);this.value.set(a,b);this.data.set(a,c)};return d}();u.NearestNeighborArrayList=r;r=function(){function d(a){this.maxPriority=java.lang.Double.MAX_VALUE;this.count=0;this.capacity=a;this.data=new Float64Array(a+1);this.value=new Float64Array(a+1);this.value[0]=this.maxPriority}d.prototype.getMaxPriority=function(){return 0==this.count?java.lang.Double.POSITIVE_INFINITY:
this.value[1]};d.prototype.removeNode=function(a){for(var c=-1,b=1;b<this.capacity+1;b++)if(this.data[b]==a){c=b;break}if(-1==c)return!1;if(1==c)this.remove();else{if(c==this.capacity+1)this.data[c]=0,this.value[c]=0;else for(b=c;b<this.capacity;b++)this.data[b]=this.data[b+1],this.value[b]=this.value[b+1];this.count--}return!0};d.prototype.insert=function(a,c){if(this.count<this.capacity)return this.add(a,c),!0;if(c>this.getMaxPriority())return!1;this.remove();this.add(a,c);return!0};d.prototype.print=
function(){console.log(" ");console.log("keys: ");for(var a=0;a<this.data.length;a++)console.log(this.data[a]);console.log(" ");console.log("dist: ");for(a=0;a<this.value.length;a++)console.log(this.value[a]);console.log(" ")};d.prototype.getNodes=function(){for(var a=Math.min(this.capacity,this.count),c=new Float64Array(a),b=0;b<a;++b)c[a-b-1]=this.remove();return c};d.prototype.isCapacityReached=function(){return this.count>=this.capacity};d.prototype.getHighest=function(){return this.data[1]};
d.prototype.getWorstDistance=function(){return this.value[1]};d.prototype.isEmpty=function(){return 0==this.count};d.prototype.getSize=function(){return this.count};d.prototype.add=function(a,c){this.count++>=this.capacity&&this.expandCapacity();this.value[this.count]=c;this.data[this.count]=a;this.bubbleUp(this.count)};d.prototype.remove=function(){if(0==this.count)return 0;var a=this.data[1];this.data[1]=this.data[this.count];this.value[1]=this.value[this.count];this.data[this.count]=0;this.value[this.count]=
0;this.count--;this.bubbleDown(1);return a};d.prototype.bubbleDown=function(a){for(var c=this.data[a],b=this.value[a],d;2*a<=this.count;a=d)if(d=2*a,d!=this.count&&this.value[d]<this.value[d+1]&&d++,b<this.value[d])this.value[a]=this.value[d],this.data[a]=this.data[d];else break;this.value[a]=b;this.data[a]=c};d.prototype.bubbleUp=function(a){for(var c=this.data[a],b=this.value[a],d=Math.floor(a/2);this.value[d]<b;)this.value[a]=this.value[d],this.data[a]=this.data[d],a=Math.floor(a/2),d=Math.floor(a/
2);this.value[a]=b;this.data[a]=c};d.prototype.expandCapacity=function(){this.capacity=2*this.count;var a=new Float64Array(this.capacity+1),c=new Float64Array(this.capacity+1);java.lang.System.arraycopy(this.data,0,a,0,this.data.length);java.lang.System.arraycopy(this.value,0,c,0,this.data.length);this.data=a;this.value=c};d.prototype.getAllNodesWithin=function(a){for(var c=Math.min(this.capacity,this.count),b=new Float64Array(c),d=0,e=0;e<c;++e)this.getMaxPriority()<=a?(b[c-d-1]=this.remove(),d++):
this.remove();a=new Float64Array(d);java.lang.System.arraycopy(b,c-d,a,0,d);return a};return d}();u.NearestNeighborList=r})(x.util||(x.util={}))})(v.structure||(v.structure={}))})(d.mwg||(d.mwg={}))})(org||(org={}));
